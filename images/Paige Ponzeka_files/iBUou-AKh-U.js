/*1362518480,173217823*/

if (self.CavalryLogger) { CavalryLogger.start_js(["Nte91"]); }

__d("MercuryIndicatorController",["date-extensions","ArbiterMixin","DOM","MercuryConfig","MercuryConstants","MercuryDelayedRoger","MercuryParticipants","MercuryRoger","MercuryThreads","MercuryTypingReceiver","copyProperties","tx"],function(a,b,c,d,e,f){b('date-extensions');var g=b('ArbiterMixin'),h=b('DOM'),i=b('MercuryConfig'),j=b('MercuryConstants'),k=b('MercuryDelayedRoger'),l=b('MercuryParticipants'),m=b('MercuryRoger'),n=b('MercuryThreads').get(),o=b('MercuryTypingReceiver'),p=b('copyProperties'),q=b('tx'),r=[];function s(t){this._threadID=t;this._canonicalUser=n.getCanonicalUserInThread(t);r.push(this);}p(s.prototype,g,{destroy:function(){r.remove(this);},setLastMessage:function(t){this._lastMsg=t;this._handleStateChange();},_informStateChanged:function(t){if(t.activity=='none'&&this._currentActivity=='none')return;if(this._lastMsg&&l.isAuthor(this._lastMsg.author))t.self_authored=true;this._currentActivity=t.activity;this.inform('state-changed',t);},_notifySentFrom:function(){var t=j.MercuryMessageSourceTags,u,v,w=this._lastMsg.location_text,x=this._lastMsg.source_tags||[];if(w){u=q._("Sent from {location}",{location:w});v='sentFromMobile';}else if(x.contains(t.MESSENGER)){u=h.create('a',{href:'/mobile/messenger','class':'fcg',target:'_blank'},"Sent from Messenger");v='sentFromMobile';}else if(x.contains(t.MOBILE)){u=h.create('a',{href:'/mobile','class':'fcg',target:'_blank'},"Sent from Mobile");v='sentFromMobile';}else if(x.contains(t.EMAIL)){u="Sent from email";v='sentFromEmail';}else{this._informStateChanged({activity:'none'});return;}this._informStateChanged({activity:v,text:u});},_notifySeenTimestamp:function(t){var u=m.getSeenTimestamp(this._threadID,t[0])*.001,v=Date.now()*.001,w=i['24h_times']?'H:i':'g:i A';if(u<v-518400){w='M j';}else if(u<v-86400)w='D '+w;var x=Date.format(w,u);this._informStateChanged({activity:'seen-timestamp',text:q._("Seen {timestamp}",{timestamp:x})});},_notifySeenBy:function(t){var u=this._lastMsg,v=true;l.getMulti(t,function(w){v=false;if(this._lastMsg!=u)return;var x=n.getThreadMetaNow(this._threadID),y=x?x.participants.length:0,z=t.length+(u.author!=l.user),aa,ba=false;if(y>2&&z>=y-1){aa="Seen by everyone";}else if(t.length==1){aa=q._("Seen by {user}",{user:w[t[0]].short_name});}else if(t.length==2){aa=q._("Seen by {user1}, {user2}",{user1:w[t[0]].short_name,user2:w[t[1]].short_name});}else if(t.length==3){aa=q._("Seen by {user1}, {user2}, {user3}",{user1:w[t[0]].short_name,user2:w[t[1]].short_name,user3:w[t[2]].short_name});}else if(t.length>3){var ca=Object.keys(w).length-2,da=q._("{num} more",{num:ca}),ea=h.create('span',{className:'more'},da);aa=h.tx._("Seen by {user1}, {user2}, {=num more link}",{user1:w[t[0]].short_name,user2:w[t[1]].short_name,'=num more link':ea});ba=true;}this._informStateChanged({activity:'seen-by',text:aa,seenBy:t,tooltip:ba});}.bind(this));v&&this._informStateChanged({activity:'none'});},_notifyTyping:function(t){var u=this._lastMsg,v=true;l.getMulti(t,function(w){v=false;if(this._lastMsg!=u)return;if(this._canonicalUser||i.ChatMultiTypGK){var x=n.getThreadMetaNow(this._threadID),y=x?x.participants.length:0,z,aa=false;if(y>2&&t.length>=y-1){z="Everyone is typing...";}else if(t.length==1){z=q._("{name} is typing...",{name:w[t[0]].short_name});}else if(t.length==2){z=q._("{user1} and {user2} are typing...",{user1:w[t[0]].short_name,user2:w[t[1]].short_name});}else if(t.length==3){z=q._("{user1}, {user2}, and {user3} are typing...",{user1:w[t[0]].short_name,user2:w[t[1]].short_name,user3:w[t[2]].short_name});}else if(t.length>3){var ba=Object.keys(w).length-2,ca=q._("{num} more",{num:ba}),da=h.create('a',{href:'#'},ca);z=h.tx._("{user1}, {user2}, and {=num more link} are typing...",{user1:w[t[0]].short_name,user2:w[t[1]].short_name,'=num more link':da});aa=true;}this._informStateChanged({activity:'typing',text:z,typing:t,tooltip:aa});}}.bind(this));v&&this._informStateChanged({activity:'none'});},_handleStateChange:function(){var t=j.MercuryActionType.LOG_MESSAGE;if(!this._lastMsg||this._lastMsg.action_type==t){this._informStateChanged({activity:'none'});return;}if(this._typing&&this._typing.length){this._notifyTyping(this._typing);return;}if(this._canonicalUser&&this._lastMsg.author!=l.user){this._notifySentFrom();return;}var u=k.getSeenBy(this._threadID,true);if(u.length)if(this._canonicalUser){this._notifySeenTimestamp(u);return;}else{this._notifySeenBy(u);return;}this._informStateChanged({activity:'none'});}});o.subscribe('state-changed',function(t,u){r.forEach(function(v){var w=u[v._threadID];if(w!==undefined){v._typing=w;v._handleStateChange();}});});k.subscribe('state-changed',function(t,u){r.forEach(function(v){u[v._threadID]&&v._handleStateChange();});});e.exports=s;});
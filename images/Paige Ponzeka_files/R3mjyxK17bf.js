/*1361761096,173213983*/

if (self.CavalryLogger) { CavalryLogger.start_js(["z9Ei3"]); }

__d("ChannelManager",["Event","function-extensions","AjaxRequest","Arbiter","AsyncRequest","ChannelConstants","ChannelSubdomain","ChannelTransport","Env","FBAjaxRequest","JSLogger","MovingStat","PresenceCookieManager","PresenceState","PresenceUtil","Run","SystemEvents","URI","UserActivity","copyProperties","createArrayFrom","ChannelInitialData"],function(a,b,c,d,e,f){var g=b('Event');b('function-extensions');var h=b('AjaxRequest'),i=b('Arbiter'),j=b('AsyncRequest'),k=b('ChannelConstants'),l=b('ChannelSubdomain'),m=b('ChannelTransport'),n=b('Env'),o=b('FBAjaxRequest'),p=b('JSLogger'),q=b('MovingStat'),r=b('PresenceCookieManager'),s=b('PresenceState'),t=b('PresenceUtil'),u=b('Run'),v=b('SystemEvents'),w=b('URI'),x=b('UserActivity'),y=b('copyProperties'),z=b('createArrayFrom'),aa=c('ChannelInitialData'),ba,ca=p.create('channel'),da=null;function ea(qa){da=qa;}var fa={idle:{ok:'init!'},init:{ok:'pull!',error:'reconnect',sys_online:'init',sys_timetravel:'init'},pull:{ok:'pull!',error:'ping',error_missing:'pull',error_msg_type:'pull',refresh_0:'reconnect',refresh_110:'reconnect',refresh_111:'pull',refresh_112:'pull',refresh_113:'pull',refresh_117:'reconnect'},ping:{ok:'pull!',error:'ping',error_stale:'reconnect!'},reconnect:{ok:'init!',error:'reconnect',sys_online:'reconnect',sys_timetravel:'reconnect'},shutdown:{},_all:{error_max:'shutdown!',error_shutdown:'shutdown!',sys_owner:'reconnect',sys_nonowner:'idle!',sys_online:'ping',sys_offline:'idle!',sys_timetravel:'ping'}},ga={userActive:Date.now(),sessionID:(Math.random()*2147483648|0).toString(16),streamingCapable:false,inStreaming:false,LONGPOLL_TIMEOUT:60000,STREAMING_TIMEOUT:60000,P_TIMEOUT:30000,IFRAME_LOAD_TIMEOUT:30000,MIN_RETRY_INTERVAL:5000,MAX_RETRY_INTERVAL:30000,MIN_12002_TIMEOUT:9000,MIN_504_TIMEOUT:20000,STALL_THRESHOLD:180000,JUMPSTART_THRESHOLD:90000,MIN_INIT_PROBE_DELAY:3000,INIT_PROBE_DELAY_RANDOMIZE_RANGE:12000,PROBE_DELAY:60000,PROBE_HEARTBEATS_INTERVAL_LOW:1000,PROBE_HEARTBEATS_INTERVAL_HIGH:3000,STREAMING_EXIT_STATE_ON_CONTINUE:false},ha=1,ia={},ja=0;function ka(qa){return qa.toLowerCase().replace(/[^0-9a-z]+/g,'_');}function la(){return j.lastSuccessTime?Math.round((Date.now()-j.lastSuccessTime)/1000):-1;}function ma(){var qa={};if(ba.getConfig('host'))qa[ba.getConfig('user_channel')]=ba.getConfig('seq',0);return qa;}function na(){var qa=Date.now(),ra=Date.now(),sa={total:0},ta='idle',ua=false;v.subscribe([v.USER,v.ONLINE,v.TIME_TRAVEL],function(xa,ya){pa(true);ra=null;ba.lastPullTime=Date.now();var za;switch(xa){case v.USER:za=v.isPageOwner()?k.SYS_OWNER:k.SYS_NONOWNER;break;case v.ONLINE:za=ya?k.SYS_ONLINE:k.SYS_OFFLINE;break;case v.TIME_TRAVEL:za=k.SYS_TIMETRAVEL;break;}ba.exitState({status:za,stateId:ha});});var va=function(xa,ya){var za=Date.now(),ab;if(ya){qa=za;ab=ya.nextState||ya.state;}else ab=ta;v.checkTimeTravel();if(ra){var bb=Math.round((za-ra)/1000);if(bb>0){sa[ta]=(sa[ta]||0)+bb;sa.total+=bb;}}ta=ab;ra=za;if(!xa){sa.lastSuccessTime=la();sa.online=v.isOnline();ca.log('rollup',sa);}};i.subscribe(k.ON_ENTER_STATE,va);setInterval(va,60000,false);i.subscribe(p.DUMP_EVENT,function(xa,ya){ya.channelRollup=sa;});var wa=function(){if(ba.isShutdown()||ba.shouldIdle())return;v.checkTimeTravel();var xa=Date.now()-(ba.lastPullTime||n.start);if(!ua&&xa>ga.STALL_THRESHOLD){var ya=la();ca.error('stall',{lastSuccessTime:ya,rollupState:ta});ua=true;}var za=Date.now()-qa;if(ba.state=='pull'&&za>ga.JUMPSTART_THRESHOLD){qa=null;ca.warn('jumpstart',{state:ba.state,dormant:za});ba.enterState('init');}};setInterval(wa,10000,false);}function oa(){var qa=Date.now(),ra=1;function sa(){setTimeout(sa,ra*1000,false);var xa=ba.state;if(xa=='idle'&&ba.shouldIdle())return;ca.bump('conn_t',ra);if(xa=='pull')ca.bump('conn_t_pull',ra);}sa();var ta=[15,30,60,120,240],ua=false,va=false;function wa(xa){setTimeout(function(){ca.rate('pullenter_'+xa,ua);ca.rate('pullexit_'+xa,va);},xa*1000,false);}while(ta.length)wa(ta.shift());i.subscribe(k.ON_ENTER_STATE,function(xa,ya){if(ya.state=='pull')ua=true;qa=Date.now();});i.subscribe(k.ON_EXIT_STATE,function(xa,ya){if(ya.state!='pull'||!qa)return;var za='other';if(ya.status==k.OK){va=true;za='ok';}else if(ya.xhr&&ya.xhr.errorType){za=/ar:(\w+)/.test(ya.xhr.errorType)&&RegExp.$1;}else if(/^sys_/.test(ya.status))return;var ab=(Date.now()-qa)/1000;if(ab<0){return;}else if(ab>3600)ab=3600;ca.bump('conn_num');ca.bump('conn_exit',ab);ca.bump('conn_num_'+za);ca.bump('conn_exit_'+za,ab);});}function pa(qa){if(qa){ja=0;ia={};}else ja++;}ba={state:'idle',nextState:null,lastPullTime:Date.now(),heartbeats:[],setTestCallback:ea,init:function(qa){this.init=function(){};if(typeof(x)!='undefined'){x.subscribe(function(){ga.userActive=Date.now();}.bind(this));}else ca.error('user_activity_undefined');r.register('ch',ma);var ra=this.getConfig('max_conn',2),sa=Math.floor(Math.random()*32);ga.subdomain=l.allocate(ra,sa);if(typeof window.onpageshow!='undefined'){g.listen(window,'pagehide',l.clear);}else u.onUnload(l.clear);this._transportRate=new q(30000);var ta=(h.supportsCORS()&&!ga.forceIframe)?'CORSTransport':'IframeTransport';this.transport=new m[ta](this);if(qa)this.enterState.apply(this,arguments);i.subscribe(p.DUMP_EVENT,function(event,va){va.transportRate=this._transportRate.tally();va.transportType=ta;va.transportVersion=2;}.bind(this));na();oa();if(ba.getConfig('tryStreaming')&&ba.getConfig('host')&&h.supportsCORS()&&!ga.forceIframe){var ua=ga.MIN_INIT_PROBE_DELAY+Math.random()*ga.INIT_PROBE_DELAY_RANDOMIZE_RANGE;setTimeout(this._probeTest,ua,false);}},configure:function(){var qa=z(arguments);ca.log('configure',qa);qa.forEach(y.bind(null,ga));i.inform(k.ON_CONFIG,this);},getConfig:function(qa,ra){return qa in ga?ga[qa]:ra;},isShutdown:function(){return this.state=='shutdown';},shouldIdle:function(){return !(v.isPageOwner()&&v.isOnline());},_sendIframeError:function(qa){var ra=new j().setURI('/ajax/presence/reconnect.php').setData({reason:qa,fb_dtsg:n.fb_dtsg}).setOption('suppressErrorHandlerWarning',true).setOption('retries',1).setMethod('GET').setReadOnly(true).setAllowCrossPageTransition(true);ra.specifiesWriteRequiredParams()&&ra.send();},_getDelay:function(){var qa=Math.min(ga.MIN_RETRY_INTERVAL*Math.pow(2,Math.max(0,ja-1)),ga.MAX_RETRY_INTERVAL);return qa*(.75+Math.random()/2)|0;},enterState:function(){if(this._inEnterState)ca.warn('enterstate_recursion');this._inEnterState=true;try{this._enterState.apply(this,arguments);this._inEnterState=false;}catch(qa){this._inEnterState=false;throw qa;}},_enterState:function(qa){var ra=0,sa=z(arguments);if(this.isShutdown())return;if(qa!='idle!'&&this.shouldIdle())return;ha++;ga.stateId=ha;clearTimeout(this._deferredTransition);this._deferredTransition=null;this.transport.enterState('idle');this.state='idle';this.nextState=null;if(/!$/.test(qa)){var ta=this._transportRate.tally().timeAverage,ua=ba.getConfig('MAX_CHANNEL_STATES_PER_SEC',1);if(ta>=ua){if(!this._throttled){this._throttled=true;ca.warn('throttled');}ca.bump('throttle');ra=1000/ua;}}else if(!(/#$/.test(qa)))ra=this._getDelay();qa=qa.replace(/\W*$/,'');if(!fa[qa])throw new Error('invalid state:'+qa);var va;if(ra<=0){va={state:qa};this._transportRate.add(1);this.state=qa;var wa=this['_enter_'+this.state];if(wa){sa.shift();wa.apply(this,sa);}if(/init|idle|pull|ping/.test(this.state)){if(ga.streamingCapable&&/pull/.test(this.state))this.heartbeats=[];this.transport.enterState(this.state,ga);if(this.state=='ping'){va.url=m.getURI(ga).toString();va.port=ga.port||'undefined';}}}else{this.state='idle';this.nextState=qa;va={state:this.state,delay:ra,nextState:qa};sa[0]=qa+'#';this._deferredTransition=(function(){this._deferredTransition=null;this.enterState.apply(this,sa);}).bind(this).defer(ra,false);}if(/pull/.test(qa)){va.client_id=ga.sessionID;va.streaming=ga.inStreaming;}ca.log('enter_'+this.state,va);i.inform(k.ON_ENTER_STATE,va);},exitState:function(qa,ra){var sa=qa.stateId,ta=qa.status;if(this.isShutdown()||sa<ha)return;var ua=z(arguments),va=this.state;ua[0]=qa.status;var wa={state:va,status:ta};if(/pull/.test(va)){wa.client_id=ga.sessionID;wa.streaming=ga.inStreaming;}if(/ping/.test(va)&&ta!=k.OK)wa.url=m.getURI(ga).toString();if(this.nextState)wa.nextState=this.nextState;if(ra&&ra.errorType){wa.xhr=ra.toJSON?ra.toJSON():ra;delete wa.xhr.json;}if(ra&&ra.json){if(ra.json.t)wa.t=ra.json.t;if(ra.json.reason)wa.reason=ra.json.reason;if(ra.json.seq)wa.seq=ra.json.seq;}ca.log('exit_'+va,wa);i.inform(k.ON_EXIT_STATE,wa);var xa=this['_exit_'+va];if(xa)ta=xa.apply(this,ua)||ta;if(ta!=k.OK){pa();ia[va]=(ia[va]||0)+1;}var ya=fa[this.nextState||va][ta]||fa._all[ta],za=ya&&ya.replace(/!*$/,'');if(!za){ca.error('terminal_transition',wa);this._shutdownHint=k.HINT_INVALID_STATE;ya='shutdown!';}this._lastState=va;this._lastStatus=ta;this.enterState(ya);},_processTransportData:function(qa,ra){var sa=ra.json,ta=sa.t;if('s' in sa){sa.seq=sa.s;delete sa.s;}var ua=ga.seq;if('seq' in sa){ga.seq=sa.seq;s.doSync();}switch(ta){case 'continue':if(ga.inStreaming&&this.heartbeats.length<1){ga.streamingCapable=false;ca.log('switch_to_longpoll');setTimeout(this._probeTest,ga.PROBE_DELAY,false);}pa(true);if(!ga.inStreaming||ga.STREAMING_EXIT_STATE_ON_CONTINUE)this.exitState({status:k.OK,stateId:qa});break;case 'refresh':case 'refreshDelay':this.exitState({status:'refresh_'+(sa.reason||0),stateId:qa},ra);break;case 'fullReload':r.clear();ca.log('invalid_history');i.inform(k.ON_INVALID_HISTORY);this.exitState({status:k.ERROR_MISSING,stateId:qa},ra);break;case 'msg':var va,wa,xa,ya;pa(true);wa=sa.ms;xa=ga.seq-wa.length;for(va=0;va<wa.length;va++,xa++)if(xa>=ua){ya=wa[va];if(ya.type){ca.debug('message',{type:ya.type});i.inform(k.getArbiterType(ya.type),{obj:ya});}}else ca.warn('seq_regression',{seq:xa,last_seq:ua,messages:wa.length});break;case 'heartbeat':if(ga.inStreaming){var za=Date.now();if(this.heartbeats.length>0){var ab=za-this.heartbeats[this.heartbeats.length-1];ca.log('heartbeat_interval',{client_id:ga.sessionID,interval:ab});}this.heartbeats.push(za);}break;default:ca.error('unknown_msg_type',{type:ta});break;}},_enter_init:function(){if(ia.init>=ba.getConfig('MAX_INIT_FAILS',2))return this.exitState.bind(this,{status:k.ERROR_MAX,stateId:ha}).defer();this._initTimer=this.exitState.bind(this,{status:k.ERROR,stateId:ha},'timeout').defer(ga.IFRAME_LOAD_TIMEOUT,false);},_enter_reconnect:function(qa){var ra=ha;if(!t.hasUserCookie()){ca.warn('no_user_cookie');(function(){ba._shutdownHint=k.HINT_AUTH;ba.exitState({status:k.ERROR_SHUTDOWN,stateId:ra});}).defer();return;}var sa={reason:qa,fb_dtsg:n.fb_dtsg};if(n.fb_isb)sa.fb_isb=n.fb_isb;if(da)da(sa);var ta=new o('GET','/ajax/presence/reconnect.php',sa);ta.onSuccess=(function(){ba.configure(ta.json);r.store();this.exitState({status:k.OK,stateId:ra});}).bind(this);ta.onError=(function(){var ua=ta.json&&ta.json.error;if(ta.errorType==h.TRANSPORT_ERROR||ta.errorType==h.PROXY_ERROR)this._shutdownHint=k.HINT_CONN;if(ua&&ua==1356007){this._shutdownHint=k.HINT_MAINT;}else if(ua==1357001||ua==1357004||ua==1348009){this._shutdownHint=k.HINT_AUTH;}else this._shutdownHint=null;this.exitState({status:this._shutdownHint?k.ERROR_SHUTDOWN:k.ERROR,stateId:ra},ta);}).bind(this);ta.send();},_enter_shutdown:function(){i.inform(k.ON_SHUTDOWN,{reason:this._shutdownHint});},_exit_init:function(qa){if(this._initTimer)this._initTimer=clearTimeout(this._initTimer);if(qa==k.ERROR_MAX)this._sendIframeError(k.reason_IFrameLoadGiveUp);},_exit_pull:function(qa){if(qa==k.OK)this.lastPullTime=Date.now();},_exit_ping:function(qa){if(qa==k.OK){var ra=Date.now()-(this.lastPullTime||n.start);if(ra>ga.STALL_THRESHOLD)return k.ERROR_STALE;}},_probeTest:function(){ga.streamingCapable=false;var qa=[],ra={mode:'stream',format:'json'},sa=new w('/probe').setDomain(ga.host+'.facebook.com').setPort(ga.port).setSecure(w().isSecure()).setQueryData(ra),ta=new h('GET',sa);ta.onJSON=function(ua,va){if(ua&&ua.json&&ua.json.t==='heartbeat'){qa.push(Date.now());if(qa.length>=2){var wa=qa[1]-qa[0];if(wa>=ga.PROBE_HEARTBEATS_INTERVAL_LOW&&wa<=ga.PROBE_HEARTBEATS_INTERVAL_HIGH){ga.streamingCapable=true;ca.log('switch_to_streaming');}ca.log('probe_ok',{time:wa});}}};ta.onSuccess=function(ua){if(qa.length!=2){ga.streamingCapable=false;ca.error('probe_error',{error:'beats.length = '+qa.length});}};ta.onError=function(ua){ga.streamingCapable=false;ca.error('probe_error',ua);};ca.log('probe_request');ta.send();}};e.exports=ba;if(aa.serverInitialized==null){ba.configure(aa.channelConfig);if(/shutdown/.test(aa.state))ba._shutdownHint=k[aa.reason];ba.init(aa.state,aa.reason);}});
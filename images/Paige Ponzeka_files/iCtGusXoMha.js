/*1362459397,178142509*/

if (self.CavalryLogger) { CavalryLogger.start_js(["N4tIC"]); }

__d("RangedCallbackManager",["CallbackManagerController","copyProperties","createObjectFrom"],function(a,b,c,d,e,f){var g=b('CallbackManagerController'),h=b('copyProperties'),i=b('createObjectFrom'),j=function(k,l,m){this._resources=[];this._reachedEndOfArray=false;this._error=false;this._existingIDs={};this._controller=new g(this._constructCallbackArg.bind(this));this._getValueHandler=k;this._compareValuesHandler=l;this._skipOnStrictHandler=m;};h(j.prototype,{executeOrEnqueue:function(k,l,m,n){return this._controller.executeOrEnqueue({start:k,limit:l},m,{strict:!!n});},unsubscribe:function(k){this._controller.unsubscribe(k);},getUnavailableResources:function(k){var l=this._controller.getRequest(k),m=[];if(l&&!this._reachedEndOfArray){var n=l.request,o=this._filterForStrictResults(l.options),p=n.start+n.limit;for(var q=o.length;q<p;q++)m.push(q);}return m;},addResources:function(k){k.forEach(function(l){if(!this._existingIDs[l]){this._existingIDs[l]=true;this._resources.push(l);this._error=null;}}.bind(this));this.resortResources();this._controller.runPossibleCallbacks();},addResourcesWithoutSorting:function(k,l){var m=this._resources.slice(0,l);m=m.concat(k);m=m.concat(this._resources.slice(l));this._resources=m;h(this._existingIDs,i(k,true));this._error=null;this._controller.runPossibleCallbacks();},removeResources:function(k){k.forEach(function(l){if(this._existingIDs[l]){this._existingIDs[l]=false;var m=this._resources.indexOf(l);if(m!=-1)this._resources.splice(m,1);}}.bind(this));},removeAllResources:function(){this._resources=[];this._existingIDs={};},resortResources:function(){this._resources=this._resources.sort(function(k,l){return this._compareValuesHandler(this._getValueHandler(k),this._getValueHandler(l));}.bind(this));},setReachedEndOfArray:function(){if(!this._reachedEndOfArray){this._reachedEndOfArray=true;this._error=null;this._controller.runPossibleCallbacks();}},hasReachedEndOfArray:function(){return this._reachedEndOfArray;},setError:function(k){if(this._error!==k){this._error=k;this._controller.runPossibleCallbacks();}},getError:function(k,l,m){var n=this._filterForStrictResults({strict:m});return k+l>n.length?this._error:null;},hasResource:function(k){return this._existingIDs[k];},getResourceAtIndex:function(k){return this._resources[k];},getAllResources:function(){return this._resources.concat();},getCurrentArraySize:function(){return this._resources.length;},_filterForStrictResults:function(k){var l=this._resources;if(k&&k.strict&&this._skipOnStrictHandler)l=l.filter(this._skipOnStrictHandler);return l;},_constructCallbackArg:function(k,l){var m=this._filterForStrictResults(l);if(!this._reachedEndOfArray&&!this._error&&k.start+k.limit>m.length){return false;}else{var n=m.slice(k.start,k.start+k.limit),o=k.start+k.limit>m.length?this._error:null;return [n,o];}},getElementsUntil:function(k){var l=[];for(var m=0;m<this._resources.length;m++){var n=this._getValueHandler(this._resources[m]);if(this._compareValuesHandler(n,k)>0)break;l.push(this._resources[m]);}return l;}});e.exports=j;});
__d("AvailableListConstants",[],function(a,b,c,d,e,f){var g={ON_AVAILABILITY_CHANGED:'buddylist/availability-changed',ON_UPDATE_ERROR:'buddylist/update-error',ON_UPDATED:'buddylist/updated',ON_CHAT_NOTIFICATION_CHANGED:'chat-notification-changed',OFFLINE:0,IDLE:1,ACTIVE:2,MOBILE:3,LEGACY_OVERLAY_OFFLINE:-1,LEGACY_OVERLAY_ONLINE:0,LEGACY_OVERLAY_IDLE:1,legacyStatusMap:{'0':2,'1':1,'-1':0,'2':3},reverseLegacyStatusMap:{0:-1,1:1,2:0,3:2}};a.AvailableListConstants=e.exports=g;});
__d("ChatFavoriteList",["array-extensions","AsyncRequest","emptyFunction"],function(a,b,c,d,e,f){b('array-extensions');var g=b('AsyncRequest'),h=b('emptyFunction'),i=false,j=[],k=[],l=false;function m(){var q=j.join(',');new g('/ajax/chat/favorite_list.php').setData({favorite_list:q}).setHandler(h).setErrorHandler(h).send();}function n(q){return q.toString();}function o(q){if(j.length!=q.length)return true;for(var r=0;r<q.length;r++)if(j[r]!==q[r].toString())return true;return false;}var p={isEditMode:function(){var q=null;d(['ChatSidebar'],function(r){q=r;});return i&&q&&q.isEnabled();},toggleEditMode:function(){i=!i;if(i)k=j.slice();},get:function(){if(i){return k.slice();}else return j.slice();},isFavored:function(q){return k.contains(q.toString());},init:function(q){j=q.slice().map(n);},toggleID:function(q){if(!i)return;q=q.toString();var r=k.indexOf(q);if(r>=0){k.splice(r,1);}else k.push(q);l=true;},hasChanged:function(){if(l){l=false;return true;}return false;},updateList:function(q){if(!i)return;k=q.map(n);},save:function(){if(o(k)){j=k;m();}}};e.exports=p;});
__d("PresenceUtil",["Cookie","Env","randomInt","tx"],function(a,b,c,d,e,f){var g=b('Cookie'),h=b('Env'),i=b('randomInt'),j=b('tx'),k=i(0,4294967295)+1,l={checkMaintenanceError:function(m){if(m.getError()==1356007)return true;return false;},getErrorDescription:function(m){var n=m.getError(),o=m.getErrorDescription();if(!o)o="An error occurred.";if(n==1357001)o="Your session has timed out. Please log in.";return o;},getSessionID:function(){return k;},hasUserCookie:function(){return h.user===g.get('c_user');}};e.exports=l;});
__d("PresencePrivacy",["hasArrayNature","Arbiter","AsyncRequest","ChannelConstants","copyProperties","Env","JSLogger","PresenceUtil","PresencePrivacyInitialData"],function(a,b,c,d,e,f){var g=b('hasArrayNature'),h=b('Arbiter'),i=b('AsyncRequest'),j=b('ChannelConstants'),k=b('copyProperties'),l=b('Env'),m=b('JSLogger'),n=b('PresenceUtil'),o=b('PresencePrivacyInitialData'),p='/ajax/chat/privacy/settings.php',q='/ajax/chat/privacy/online_policy.php',r='/ajax/chat/privacy/visibility.php',s='friend_visibility',t='visibility',u='online_policy',v=k({},o.privacyData),w=o.visibility,x=k({},o.privacyData),y=w,z=o.onlinePolicy,aa=z,ba=[],ca=false;function da(){return m.create('blackbird');}var ea=k(new h(),{WHITELISTED:1,BLACKLISTED:-1,UNLISTED:0,ONLINE:1,OFFLINE:0,ONLINE_TO_WHITELIST:0,ONLINE_TO_BLACKLIST:1});function fa(ra){var sa;for(sa in ra){var ta=ra[sa];if(sa==l.user){da().error('set_viewer_visibility');throw new Error("Invalid to set current user's visibility");}switch(ta){case ea.WHITELISTED:case ea.BLACKLISTED:case ea.UNLISTED:break;default:da().error('set_invalid_friend_visibility',{id:sa,value:ta});throw new Error("Invalid state: "+ta);}}for(sa in ra)v[sa]=ra[sa];ea.inform('privacy-changed');}function ga(ra,sa){var ta={};ta[ra]=sa;fa(ta);}function ha(ra){switch(ra){case ea.ONLINE:case ea.OFFLINE:break;default:da().error('set_invalid_visibility',{value:ra});throw new Error("Invalid visibility: "+ra);}w=ra;ea.inform('privacy-changed');ea.inform('privacy-user-presence-changed');h.inform('chat/visibility-changed',{sender:this});}function ia(ra){switch(ra){case ea.ONLINE_TO_WHITELIST:case ea.ONLINE_TO_BLACKLIST:break;default:throw new Error("Invalid default online policy: "+ra);}z=ra;ea.inform('privacy-user-presence-changed');ea.inform('privacy-changed');}function ja(ra,sa){ca=true;ra.send();}function ka(ra,sa){ba.push({request:ra,data:sa});if(!ca){var ta=ba.shift();ja(ta.request,ta.data);}}function la(ra,sa){var ta=ra.type;if(ta===s){var ua=sa.payload.user_availabilities;if(!g(ua)){ea.inform('privacy-availability-changed',{user_availabilities:ua});for(var va in ra.settings)x[va]=ra.settings[va];}}else{if(ta===t){y=ra.visibility;}else if(ta===u)aa=ra.online_policy;ea.inform('privacy-user-presence-response');}da().log('set_update_response',{data:ra,response:sa});}function ma(ra,sa){if(w!==y)ha(y);if(z!==aa)ia(aa);k(v,x);ea.inform('privacy-changed');ba=[];da().log('set_error_response',{data:ra,response:sa});}function na(ra){ca=false;if(ba.length>0){var sa=ba.shift();ja(sa.request,sa.data);}}function oa(ra,sa){if(n!=null){var ta=ra.getData();ta.window_id=n.getSessionID();ra.setData(ta);}ra.setHandler(la.bind(this,sa)).setErrorHandler(ma.bind(this,sa)).setTransportErrorHandler(ma.bind(this,sa)).setFinallyHandler(na.bind(this)).setAllowCrossPageTransition(true);return ra;}function pa(ra,sa,ta){return oa(new i(ra).setData(sa),ta);}function qa(ra,sa){var ta=sa.obj;if(ta.viewer_id!=l.user){da().error('invalid_viewer_for_channel_message',{type:ra,data:sa});throw new Error("Viewer got from the channel is not the real viewer");}if(ta.window_id===n.getSessionID())return;var ua=ta.data;if(ta.event=='access_control_entry'){ua.target_ids.forEach(function(wa){ga(wa,ua.setting);x[wa]=ua.setting;});}else{if(ta.event=='visibility_update'){var va=!!ua.visibility?ea.ONLINE:ea.OFFLINE;ha(va);y=va;}else if(ta.event=='online_policy_update'){ia(ua.online_policy);aa=ua.online_policy;}ea.inform('privacy-user-presence-response');}da().log('channel_message_received',{data:sa.obj});}k(ea,{WHITELISTED:1,BLACKLISTED:-1,UNLISTED:0,ONLINE:1,OFFLINE:0,ONLINE_TO_WHITELIST:0,ONLINE_TO_BLACKLIST:1,init:function(ra,sa,ta){},setVisibility:function(ra){y=w;ha(ra);var sa={visibility:ra},ta={type:t,visibility:ra},ua=pa(r,sa,ta);ka(ua,ta);da().log('set_visibility',{data:sa});return ra;},getVisibility:function(){return w;},setOnlinePolicy:function(ra){aa=z;ia(ra);var sa={online_policy:ra},ta={type:u,online_policy:ra},ua=pa(q,sa,ta);ka(ua,ta);da().log('set_online_policy',{data:sa});return ra;},getOnlinePolicy:function(){return z;},getFriendVisibility:function(ra){return v[ra]||ea.UNLISTED;},allows:function(ra){if(this.getVisibility()===ea.OFFLINE)return false;var sa=this.getOnlinePolicy();return sa===ea.ONLINE_TO_WHITELIST?v[ra]==ea.WHITELISTED:v[ra]!=ea.BLACKLISTED;},setFriendsVisibility:function(ra,sa){if(ra.length>0){var ta={};for(var ua=0;ua<ra.length;ua++){var va=ra[ua];x[va]=v[va];ta[va]=sa;}fa(ta);var wa=sa;if(wa==ea.UNLISTED)wa=x[ra[0]];var xa={users:ra,setting:sa,setting_type:wa},ya={type:s,settings:ta},za=pa(p,xa,ya);ka(za,ya);da().log('set_friend_visibility',{data:xa});}return sa;},setFriendVisibilityMap:function(ra,sa){for(var ta in ra)x[ta]=v[ta];fa(ra);var ua={type:s,settings:ra};ka(oa(sa,ua),ua);da().log('set_friend_visibility_from_map',{data:ra});},allow:function(ra){if(this.allows(ra)){da().error('allow_already_allowed');throw new Error("allow() should only be called for users that "+"are not already allowed");}if(this.getVisibility()===ea.OFFLINE){da().error('allow_called_while_offline');throw new Error("allow() should only be called when the user is already online");}var sa=this.getOnlinePolicy()===ea.ONLINE_TO_WHITELIST?ea.WHITELISTED:ea.UNLISTED;return this.setFriendsVisibility([ra],sa);},disallow:function(ra){if(!this.allows(ra)){da().error('disallow_already_disallowed');throw new Error("disallow() should only be called for users that "+"are not already disallowed");}if(this.getVisibility()===ea.OFFLINE){da().error('disallow_called_while_offline');throw new Error("disallow() should only be called when the user is already online");}var sa=this.getOnlinePolicy()===ea.ONLINE_TO_BLACKLIST?ea.BLACKLISTED:ea.UNLISTED;return this.setFriendsVisibility([ra],sa);},getBlacklist:function(){var ra=[];for(var sa in v)if(v[sa]===ea.BLACKLISTED)ra.push(sa);return ra;},getWhitelist:function(){var ra=[];for(var sa in v)if(v[sa]===ea.WHITELISTED)ra.push(sa);return ra;},getMapForTest:function(){return v;},setMapForTest:function(ra){v=ra;}});ea.inform('privacy-changed');ea.inform('privacy-user-presence-changed');da().log('initialized',{visibility:w,policy:z});h.subscribe(j.getArbiterType('privacy_changed'),qa.bind(this));h.subscribe(j.ON_CONFIG,function(ra,sa){var ta=sa.getConfig('visibility',null);if(ta!==null&&typeof(ta)!=='undefined'){var ua=ta?ea.ONLINE:ea.OFFLINE;ha(ua);da().log('config_visibility',{vis:ua});}}.bind(this));a.PresencePrivacy=e.exports=ea;},3);
__d("ChatVisibility",["Arbiter","JSLogger","PresencePrivacy"],function(a,b,c,d,e,f){var g=b('Arbiter'),h=b('JSLogger'),i=b('PresencePrivacy'),j={isOnline:function(){return i.getVisibility()===i.ONLINE;},hasBlackbirdEnabled:function(){return this.isVisibleToMostFriends()||this.isVisibleToSomeFriends();},isVisibleToMostFriends:function(){return i.getOnlinePolicy()===i.ONLINE_TO_BLACKLIST&&i.getBlacklist().length>0;},isVisibleToSomeFriends:function(){return i.getOnlinePolicy()===i.ONLINE_TO_WHITELIST&&i.getWhitelist().length>0;},goOnline:function(k){if(i.getVisibility()===i.OFFLINE){h.create('blackbird').log('chat_go_online');i.setVisibility(i.ONLINE);g.inform('chat-visibility/go-online');}k&&k();},goOffline:function(k){if(i.getVisibility()===i.ONLINE){h.create('blackbird').log('chat_go_offline');i.setVisibility(i.OFFLINE);g.inform('chat-visibility/go-offline');}k&&k();},toggleVisibility:function(){if(j.isOnline()){j.goOffline();}else j.goOnline();}};a.ChatVisibility=e.exports=j;},3);
__d("LastMobileActiveTimes",["tx"],function(a,b,c,d,e,f){var g=b('tx'),h=0,i={};function j(n){if(!h||!n)return '';var o=h-n,p=Math.floor(o/60),q=Math.floor(p/60),r=Math.floor(q/24);if(p<=1){return g._("{count}m",{count:1});}else if(p<60){return g._("{count}m",{count:p});}else if(q<24){return g._("{count}h",{count:q});}else if(r<3){return g._("{count}d",{count:r});}else return '';}function k(n,o){i[n]=o;}function l(n){if(n in i){return i[n];}else return 0;}var m={update:function(n,o){h=o/1000;for(var p in n)k(p,n[p]);},getShortDisplay:function(n){return j(l(n));}};e.exports=m;});
__d("Poller",["ArbiterMixin","AsyncRequest","Cookie","Env","copyProperties","emptyFunction"],function(a,b,c,d,e,f){var g=b('ArbiterMixin'),h=b('AsyncRequest'),i=b('Cookie'),j=b('Env'),k=b('copyProperties'),l=b('emptyFunction');function m(p){this._config=k({clearOnQuicklingEvents:true,setupRequest:l,interval:null,maxRequests:Infinity,dontStart:false},p);if(!this._config.dontStart)this.start();}m.MIN_INTERVAL=2000;k(m.prototype,g,{start:function(){if(this._polling)return this;this._requests=0;setTimeout(this.request.bind(this),0);return this;},stop:function(){this._cancelRequest();return this;},mute:function(){this._muted=true;return this;},resume:function(){if(this._muted){this._muted=false;if(!this._handle&&this._polling)return this.request();}return this;},skip:function(){this._skip=true;return this;},reset:function(){return this.stop().start();},request:function(){this._cancelRequest();this._polling=true;if(!o())return this._done();if(this._muted)return this;if(++this._requests>this._config.maxRequests)return this._done();var p=new h(),q=false;p.setInitialHandler(function(){return !q;});this._cancelRequest=function(){q=true;this._cleanup();}.bind(this);p.setFinallyHandler(n.bind(this));p.setInitialHandler=l;p.setFinallyHandler=l;this._config.setupRequest(p,this);if(this._skip){this._skip=false;n.bind(this).defer();}else p.send();return this;},isPolling:function(){return this._polling;},isMuted:function(){return this._muted;},setInterval:function(p){if(p){this._config.interval=p;this.start();}},getInterval:function(){return this._config.interval;},_cleanup:function(){if(this._handle)clearTimeout(this._handle);this._handle=null;this._cancelRequest=l;this._polling=false;},_done:function(){this._cleanup();this.inform('done',{sender:this});return this;},_config:null,_requests:0,_muted:false,_polling:false,_skip:false,_cancelRequest:l});function n(){if(this._polling&&(this._requests<this._config.maxRequests)){var p=this._config.interval;p=typeof p==='function'?p(this._requests):p;this._handle=this.request.bind(this).defer((p>m.MIN_INTERVAL)?p:m.MIN_INTERVAL,this._config.clearOnQuicklingEvents);}else{this._cleanup();this.inform('done',{sender:this});}}function o(){return j.user==i.get('c_user');}e.exports=m;});
__d("ServerTime",["PresenceInitialData"],function(a,b,c,d,e,f){var g=b('PresenceInitialData'),h;function i(k){h=Date.now()-k;}i(g.serverTime);var j={get:function(){return Date.now()-h;},getSkew:function(){return h;},update:function(k){i(k);}};e.exports=j;});
__d("AvailableList",["function-extensions","Arbiter","ArbiterMixin","AsyncRequest","AvailableListConstants","ChannelConstants","ChatConfig","ChatFavoriteList","ChatVisibility","Env","JSLogger","LastMobileActiveTimes","Poller","PresencePrivacy","PresenceUtil","ServerTime","ShortProfiles","UserActivity","copyProperties","createObjectFrom","debounceAcrossTransitions","emptyFunction","ChannelImplementation","AvailableListInitialData"],function(a,b,c,d,e,f){b('function-extensions');var g=b('Arbiter'),h=b('ArbiterMixin'),i=b('AsyncRequest'),j=b('AvailableListConstants'),k=b('ChannelConstants'),l=b('ChatConfig'),m=b('ChatFavoriteList'),n=b('ChatVisibility'),o=b('Env'),p=b('JSLogger'),q=b('LastMobileActiveTimes'),r=b('Poller'),s=b('PresencePrivacy'),t=b('PresenceUtil'),u=b('ServerTime'),v=b('ShortProfiles'),w=b('UserActivity'),x=b('copyProperties'),y=b('createObjectFrom'),z=b('debounceAcrossTransitions'),aa=b('emptyFunction'),ba=c('ChannelImplementation').instance,ca=c('AvailableListInitialData'),da=5,ea='/ajax/chat/buddy_list.php',fa=5000,ga=1800000,ha=0,ia=0,ja=false,ka=ca.pollInterval,la=ca.lazyPollInterval,ma=ca.lazyThreshold,na=0,oa=Date.now(),pa=0,qa=false,ra={},sa=false,ta={},ua=null,va={},wa={},xa=p.create('available_list'),ya=x({},j,h);ya.subscribe([j.ON_AVAILABILITY_CHANGED,j.ON_UPDATE_ERROR,j.ON_UPDATED],function(qb,rb){g.inform(qb,rb);});function za(qb){var rb=qb||w.isActive(ma);return n.isOnline()?(rb?ka:la):null;}function ab(){ya.inform(j.ON_AVAILABILITY_CHANGED);}var bb=z(ab,0);function cb(qb,rb,sb,tb){if(qb==o.user)return;switch(rb){case j.OFFLINE:case j.IDLE:case j.ACTIVE:case j.MOBILE:break;default:return;}var ub=ya.get(qb)!=rb;if(sb){va[qb]=u.get();wa[qb]=tb;}ra[qb]=rb;if(ub){ha++;bb();}}function db(qb){pa=Date.now();ta=y(qb);ha++;bb();}function eb(){if(qa)ya.inform(j.ON_UPDATED,ya);}function fb(qb){if(t.checkMaintenanceError(qb))return;ia++;ja=false;if(ia>=da)ya.inform(j.ON_UPDATE_ERROR);}function gb(qb){var rb=qb.getPayload(),sb=rb.buddy_list;if(!sb){fb(qb);return;}u.update(rb.time);na=u.get();ia=0;ja=false;if(sb.mobile_friends!=null)db(sb.mobile_friends);var tb=sb.userInfos;if(tb)v.setMulti(tb);mb();sa=sb.userIsIdle;var ub=sb.nowAvailableList;ub&&kb(ub);var vb=sb.last_active_times;vb&&q.update(vb,rb.time);if(sb.chatNotif!==undefined){ua=sb.chatNotif;ya.inform(j.ON_CHAT_NOTIFICATION_CHANGED,ua);}lb();eb();bb();}function hb(qb){if(ba.isShutdown()||!n.isOnline()){ya._poller.stop();return;}oa=Date.now();var rb=false;if(Date.now()-pa>ga)rb=true;ja=true;var sb=v.getCachedProfileIDs().join(",");qb.setHandler(gb).setErrorHandler(fb).setOption('suppressErrorAlerts',true).setOption('retries',1).setData({user:o.user,cached_user_info_ids:sb,fetch_mobile:rb}).setURI(ea).setAllowCrossPageTransition(true);}function ib(qb){var rb=qb.payload.availability||{};for(var sb in rb)cb(sb,rb[sb],true,'mercury_tabs');}function jb(qb){var rb=ya.getDebugInfo(qb),sb=(rb.presence==j.ACTIVE),tb=new i('/ajax/mercury/tabs_presence.php').setData({target_id:qb,to_online:sb,presence_source:rb.overlaySource,presence_time:rb.overlayTime}).setHandler(ib).setErrorHandler(aa).setAllowCrossPageTransition(true).send();}function kb(qb){for(var rb in qb)cb(rb,qb[rb].a,false,null);qa=true;}function lb(qb){var rb=za(qb);xa.debug('update_poller',rb);ya._poller&&ya._poller.setInterval(rb);}function mb(){qa=false;ra={};wa={};va={};ha++;}function nb(){mb();oa=0;pa=0;sa=false;ua=null;ta={};ab();}function ob(){lb();if(ba.disconnected()){nb();}else if(!qa)ya.update();}function pb(qb,rb){rb.chat_config=l.getDebugInfo();rb.available_list_debug_info={};ya.getAvailableIDs().forEach(function(sb){rb.available_list_debug_info[sb]=ya.getDebugInfo(sb);});rb.available_list_poll_interval=ya._poller&&ya._poller.getInterval();}x(ya,{get:function(qb){if(qb==o.user)return n.isOnline()?j.ACTIVE:j.OFFLINE;var rb=j.OFFLINE;if(qb in ra)rb=ra[qb];if(!s.allows(qb))rb=j.OFFLINE;if(rb==j.OFFLINE)if(ta[qb])rb=j.MOBILE;return rb;},updateForID:function(qb){jb(qb);},getWebChatNotification:function(){return ua;},isUserIdle:function(){return sa;},isReady:function(){return qa;},set:function(qb,rb,sb){cb(qb,rb,true,null,sb);},update:function(){if(Date.now()-oa<fa){!ja&&eb.defer();return;}ya._poller&&ya._poller.request();},getRev:function(){return ha;},isIdle:function(qb){return ya.get(qb)==j.IDLE;},getOnlineIDs:function(){var qb,rb=[];for(qb in ra)if(ya.get(qb)===j.ACTIVE)rb.push(qb);return rb;},getAvailableIDs:function(){var qb=ya.getOnlineIDs(),rb;for(rb in ta){if(ra[rb])continue;qb.push(rb);}return qb;},getOnlineCount:function(){return ya.getOnlineIDs().length;},getDebugInfo:function(qb){var rb;if(window.ShortProfiles){var sb=v.getNow(qb);if(sb)rb=sb.name;}return {id:qb,presence:ra[qb],overlaySource:wa[qb],overlayTime:va[qb],overlaySource:wa[qb],mobile:ta[qb],name:rb};}});na=ca.updateTime;kb(ca.availableList);if(ca.mobileFriends)db(ca.mobileFriends);if(ca.lastActiveTimes)q.update(ca.lastActiveTimes,na);if(ca.favoriteList)m.init(ca.favoriteList);ua=ca.chatNotif;ya._poller=new r({interval:za(),setupRequest:hb,clearOnQuicklingEvents:false});lb(true);g.subscribe(p.DUMP_EVENT,pb);g.subscribe(k.getArbiterType('favorite_list'),function(qb,rb){var sb=rb.obj,tb=sb.value?sb.value.split(','):[];m.init(tb);bb();});w.subscribe(function(qb,rb){if(rb.idleness>ka){xa.debug('update_activity');ya.update();}});s.subscribe('privacy-changed',ab);s.subscribe('privacy-availability-changed',function(qb,rb){for(var sb in rb.user_availabilities)this.set(sb,rb.user_availabilities[sb]);}.bind(ya));s.subscribe('privacy-user-presence-response',ya.update);ba.subscribe([ba.CONNECTED,ba.RECONNECTING,ba.SHUTDOWN,ba.MUTE_WARNING,ba.UNMUTE_WARNING],ob);g.subscribe(k.getArbiterType('buddylist_overlay'),function(qb,rb){var sb=rb.obj.overlay;for(var tb in sb)ya.set(tb,sb[tb].a,sb[tb].s||'channel');});a.AvailableList=e.exports=ya;});
__d("Chat",["Arbiter","AsyncSignal","MercuryConstants"],function(a,b,c,d,e,f){var g=b('Arbiter'),h=b('AsyncSignal'),i=b('MercuryConstants');function j(n,o,p){var q=o&&o.source;if(q&&q=='ordered_list'||q=='more_online_friends'||q=='online_friends'||q=='typeahead'){o.target=n;o.sorted_list=p;new h('/ajax/chat/ct.php',o).send();}}var k={buddyListNub:'buddylist-nub/initialized',sidebar:'sidebar/initialized'};function l(n,o){g.subscribe(k[n],function(event,p){o(p);});}var m={openTab:function(n,o,p,q,r){if(window.External&&window.External.Chat&&window.External.Chat.openWindow)window.External.Chat.openWindow(n);j(n,q,r);d(['MercuryThreads'],function(s){if(!p||p===i.MercuryParticipantTypes.FRIEND){var t=s.get().getCanonicalThreadToUser(n);g.inform('chat/open-tab',{thread_id:t.thread_id});}});},openBuddyList:function(){l('buddyListNub',function(n){n.show();l('sidebar',function(o){o.enable();});});},closeBuddyList:function(){l('buddyListNub',function(n){n.hide();});},toggleSidebar:function(){l('sidebar',function(n){n.toggle();});},goOnline:function(n){d(['ChatVisibility'],function(o){o.goOnline(n);});},isOnline:function(){var n=null;d(['ChatVisibility'],function(o){n=o;});return n&&n.isOnline();}};a.Chat=e.exports=m;},3);
__d("OrderedFriendsList",["array-extensions","Arbiter","createArrayFrom","ShortProfiles","copyProperties","InitialChatFriendsList"],function(a,b,c,d,e,f){b('array-extensions');var g=b('Arbiter'),h=b('createArrayFrom'),i=b('ShortProfiles'),j=b('copyProperties'),k=[],l={},m=j(new g(),{contains:function(n){return n in l;},compare:function(n,o){var p=m.getRank(n),q=m.getRank(o);if(p!==q)return p-q;var r=i.getNowUnsafe(n),s=i.getNowUnsafe(o),t=((r||{}).name||'~').toLowerCase(),u=((s||{}).name||'~').toLowerCase();if(t!==u)return t<u?-1:1;return 0;},getList:function(){var n=h(k);n=n.filter(function(o){var p=i.getNowUnsafe(o);return !p||p.type=="friend";});return n;},getRank:function(n){return n in l?l[n]:k.length;},isReady:function(){return true;}});(function(){var n=b('InitialChatFriendsList');k=n.list.length?n.list:[];k.forEach(function(o,p){l[o]=p;});m.inform('initialized',{},g.BEHAVIOR_PERSISTENT);})();e.exports=a.OrderedFriendsList||m;});
__d("ChatTypeaheadBehavior",["Chat","ChatFavoriteList","CSS","DOM","Rect","copyProperties","tx"],function(a,b,c,d,e,f){var g=b('Chat'),h=b('ChatFavoriteList'),i=b('CSS'),j=b('DOM'),k=b('Rect'),l=b('copyProperties'),m=b('tx');function n(o){this._typeahead=o;}l(n.prototype,{_subscriptions:null,enable:function(){var o=this._typeahead;this._subscriptions=[o.subscribe('focus',function(){o.getData().refreshData();}),o.subscribe('blur',function(p){o.getCore().reset();}),o.subscribe('respond',function(p,q){if(q.value&&q.value===o.getCore().getValue()){if(!q.results.length){var r=j.create('div',{className:'noResults'},"Friend not found.");j.setContent(o.getView().getElement(),r);}i.addClass(o.getElement(),'hasValue');}}),o.subscribe('reset',function(){i.removeClass(o.getElement(),'hasValue');}),o.subscribe('select',function(p,q){if(h.isEditMode()){h.toggleID(q.selected.uid);}else{var r=i.hasClass(document.documentElement,'sidebarMode'),s={mode:r?'sidebar':'chatNub',source:'typeahead',typeahead:true};g.openTab(q.selected.uid,q.selected.text,q.selected.type,s);}}),o.subscribe('highlight',function(p,q){if(q.index>=0){var r=o.getView().getItems()[q.index];if(r){var s=new k(r),t=r.offsetParent,u=s.boundWithin(new k(t)).getPositionVector();s.getPositionVector().sub(u).scrollElementBy(t);}}})];},disable:function(){this._subscriptions.forEach(function(o){this._typeahead.unsubscribe(o);}.bind(this));this._subscriptions=null;}});e.exports=n;});
__d("ChatTypeaheadCore",["Event","function-extensions","Class","Keys","TypeaheadCore","copyProperties","emptyFunction"],function(a,b,c,d,e,f){var g=b('Event');b('function-extensions');var h=b('Class'),i=b('Keys'),j=b('TypeaheadCore'),k=b('copyProperties'),l=b('emptyFunction');function m(n){this.parent.construct(this,n);}h.extend(m,j);k(m.prototype,{handleTab:l,keydown:function(event){var n=g.getKeyCode(event);if(n===i.ESC){this.reset.shield(this).defer();return event.kill();}return this.parent.keydown(event);}});e.exports=m;});
__d("ChatTypeaheadDataSource",["Arbiter","AvailableListConstants","Class","MercuryConstants","DataSource","Env","JSLogger","OrderedFriendsList","Run","ShortProfiles","copyProperties"],function(a,b,c,d,e,f){var g=b('Arbiter'),h=b('AvailableListConstants'),i=b('Class'),j=b('MercuryConstants'),k=b('DataSource'),l=b('Env'),m=b('JSLogger'),n=b('OrderedFriendsList'),o=b('Run'),p=b('ShortProfiles'),q=b('copyProperties');function r(s){this.parent.construct(this,s);this.persistOnRefresh=s.persistOnRefresh!==false;this.showOfflineUsers=!!s.showOfflineUsers;this._jslog=m.create('chat_typeahead');this._jslog.log('created');}i.extend(r,k);q(r.prototype,{init:function(){this._jslog.log('init');this.parent.init();var s=g.subscribe(h.ON_AVAILABILITY_CHANGED,this._update.shield(this));this._update();if(!this.persistOnRefresh)o.onLeave(function(){s.unsubscribe();});},bootstrap:function(){this._jslog.log('bootstrap');this.parent.bootstrap();if(this.showOfflineUsers){this._jslog.log('show_offline_users');this._jslog.log('ensured_short_profiles');if(p.hasAll()){this._update();}else{this._jslog.log('fetch_all_short_profiles');p.fetchAll();this.inform('activity',{activity:true});var s=p.subscribe('updated',function(){this.inform('activity',{activity:false});this._update();}.bind(this));if(!this.persistOnRefresh)o.onLeave(function(){p.unsubscribe(s);});}}},_update:function(){d(['AvailableList'],function(s){var t=this.value;this.dirty();var u=p.getCachedProfileIDs(),v=u.filter(function(x){var y=p.getNow(x);return y.type===j.MercuryParticipantTypes.FRIEND;});v.sort(n.compare);var w=[];v.forEach(function(x){if(x==l.user)return;var y=s.get(x);if(!this.showOfflineUsers&&y!==s.ACTIVE)return;var z=p.getNow(x);w.push({uid:x,text:z.name,tokens:z.additionalName,localized_text:z.name,additional_text:z.additionalName,photo:z.thumbSrc,availability:y,type:z.type});}.bind(this));if(w.length)this.addEntries(w);this.value=t;if(t)this.respond(t,this.buildUids(t,[],this._exclusions),true);}.bind(this));},refreshData:function(){d(['AvailableList'],function(s){s.update();}.bind(this));}});e.exports=r;});
__d("ChatTypeaheadRenderer",["AvailableListConstants","ChatFavoriteList","CSS","DOM","PresencePrivacy","LastMobileActiveTimes","cx"],function(a,b,c,d,e,f){var g=b('AvailableListConstants'),h=b('ChatFavoriteList'),i=b('CSS'),j=b('DOM'),k=b('PresencePrivacy'),l=b('LastMobileActiveTimes'),m=b('cx');function n(o,p){var q='offline';switch(o.availability){case g.ACTIVE:q='active';break;case g.IDLE:q='idle';break;case g.MOBILE:q='mobile';break;}if(!k.allows(o.uid))q='invis';var r=[],s=h.isEditMode(),t=h.isFavored(o.uid);if(s){var u=j.create('span',{className:"_42fw"});i.addClass(u,t?"_42fx":"_42fy");r.push(u);}if(o.photo){var v=j.create('img',{alt:'',src:o.photo});r.push(j.create('div',{className:'pic_container'},v));}if(!s){r.push(j.create('i',{className:q}));if(q=='mobile'){var w=l.getShortDisplay(o.uid);r.push(j.create('span',{className:'time'},[w]));}}if(o.text)r.push(j.create('span',{className:'text'},[o.text]));return j.create('li',{className:'clearfix '+q},r);}e.exports=n;});
__d("legacy:ChatTypeaheadBehavior",["ChatTypeaheadBehavior"],function(a,b,c,d){var e=b('ChatTypeaheadBehavior');if(!a.TypeaheadBehaviors)a.TypeaheadBehaviors={};a.TypeaheadBehaviors.chatTypeahead=function(f){f.enableBehavior(e);};},3);
__d("NotificationURI",["URI"],function(a,b,c,d,e,f){var g=b('URI'),h={localize:function(i){i=g(i);if(!i.isFacebookURI())return i.toString();var j=i.getSubdomain();return i.getUnqualifiedURI().getQualifiedURI().setSubdomain(j).toString();},snowliftable:function(i){if(!i)return false;i=g(i);return i.isFacebookURI()&&i.getQueryData().hasOwnProperty('fbid');}};e.exports=h;});
__d("AppRequestReminders",["AsyncRequest","CSS","DOM","ge"],function(a,b,c,d,e,f){var g=b('AsyncRequest'),h=b('CSS'),i=b('DOM'),j=b('ge'),k=0,l={},m=1,n=j('OtherAppReqReminder'),o=function(u,v,w){l[v]={node:u,seq:m++,reqCount:w};},p=function(u){k=u;},q=function(u){return u.id.split('_')[1];},r=function(u){var v=j(u),w=v.nextSibling;if(w!==n){h.show(w);k-=l[q(w)].reqCount;}s(k);},s=function(u){new g().setURI('/ajax/reminders/update_count.php').setData({new_count:u}).setMethod('POST').send();},t=function(u,v){if(n&&v&&u>0){i.setContent(j('OtherAppReqLabel'),v);}else if(n){h.hide(n);}else h.hide(j('OtherAppReqReminder'));};f.initNode=o;f.handleRemove=r;f.updateCount=t;f.setTotalOtherCount=p;});
__d("ModalMask",["DOM"],function(a,b,c,d,e,f){var g=b('DOM'),h=null,i=0,j={show:function(){i++;if(!h){h=g.create('div',{id:'modalMaskOverlay'});g.appendContent(document.body,h);}},hide:function(){if(i){i--;if(!i&&h){g.remove(h);h=null;}}}};e.exports=j;});
__d("TimestampConverter",["JSLogger"],function(a,b,c,d,e,f){var g=b('JSLogger'),h=g.create('timestamp_converter');function i(k){return (typeof(k)=='string')&&k.length>6;}var j={convertActionIDToTimestamp:function(k){if(i(k)){var l=k.slice(0,-6);return parseInt(l,10);}},maxValidActionID:function(k,l){if(!i(k))return l;if(!i(l))return k;return this.isGreaterThan(k,l)?k:l;},isGreaterThan:function(k,l){if(!i(k)||!i(l))return false;return this.convertActionIDToTimestamp(k)>this.convertActionIDToTimestamp(l);}};e.exports=j;});
__d("MercuryIDs",[],function(a,b,c,d,e,f){function g(i){return typeof i==='string'&&i.indexOf(':')!==-1;}var h={isValid:function(i){if(!i)return false;return g(i);},isValidThreadID:function(i){if(!h.isValid(i))return false;var j=h.tokenize(i);switch(j.type){case 'user':case 'group':case 'thread':case 'root':case 'pending':return true;default:return false;}},tokenize:function(i){if(!this.isValid(i))throw 'bad_id_format';var j=i.indexOf(':');return {type:i.substr(0,j),value:i.substr(j+1)};}};e.exports=h;});
__d("MercuryAssert",["MercuryIDs"],function(a,b,c,d,e,f){var g=b('MercuryIDs');e.exports={isParticipantID:function(h){if(!g.isValid(h))throw 'bad_participant_id';},allParticipantIDs:function(h){h.forEach(this.isParticipantID);},isUserParticipantID:function(h){var i=g.tokenize(h);if(i.type!='fbid')throw 'bad_user_id';},isEmailParticipantID:function(h){var i=g.tokenize(h);if(i.type!='email')throw 'bad_email_id';},allThreadID:function(h){h.forEach(this.isThreadID);},isThreadID:function(h){if(!g.isValid(h))throw 'bad_thread_id';}};});
__d("MercuryMessageIDs",["KeyedCallbackManager"],function(a,b,c,d,e,f){var g=b('KeyedCallbackManager'),h=new g(),i={getServerIDs:function(j,k){var l=j.filter(function(n){return n.indexOf('mail.projektitan.com')!==-1;}),m=function(n){var o=j.map(function(p){return n[p]?n[p]:p;});k(o);};return h.executeOrEnqueue(l,m);},addServerID:function(j,k){h.setResource(j,k);}};e.exports=i;});
__d("MessagingReliabilityLogger",["function-extensions","PresenceUtil","MercuryServerDispatcher","MessagingReliabilityLoggerInitialData","isEmpty","setTimeoutAcrossTransitions"],function(a,b,c,d,e,f){b('function-extensions');var g=b('PresenceUtil'),h=b('MercuryServerDispatcher'),i=b('MessagingReliabilityLoggerInitialData'),j=b('isEmpty'),k=b('setTimeoutAcrossTransitions'),l='/ajax/mercury/client_reliability.php',m=60000;function n(t,u){var v={app:i.app,categories:JSON.stringify(t)};if(!j(u))v.extra=JSON.stringify(u);return v;}function o(t,u,v,w){if(t[u]===undefined)t[u]={};if(t[u][v]===undefined)t[u][v]=0;t[u][v]+=w;}function p(t,u,v,w){if(t[u]===undefined)t[u]={};if(t[u][v]===undefined)t[u][v]=[];for(var x=0;x<w.length;++x)t[u][v].push(w[x]);}function q(t,u){if((t&&!t.categories)||(u&&!u.categories))return;var v=t?JSON.parse(t.categories):{},w=t&&t.extra?JSON.parse(t.extra):{},x=JSON.parse(u.categories),y=u.extra?JSON.parse(u.extra):{};for(var z in x){var aa=x[z],ba=y[z];for(var ca in aa){o(v,z,ca,aa[ca]);if(ba!==undefined){var da=ba[ca];if(da!==undefined)p(w,z,ca,da);}}}return n(v,w);}var r={};r[l]={mode:h.BATCH_SUCCESSIVE_PIGGYBACK_ON_ERROR,batch_function:q};h.registerEndpoints(r);var s={addEntry:function(t,u,v){if(!i.enabled)return;var w={};o(w,t,u,1);var x={};if(v!==undefined)p(x,t,u,[v]);h.trySend(l,n(w,x));}};(function t(){s.addEntry('page_event','active',g.getSessionID());k(t,m);})();e.exports=s;});
__d("MercurySingletonMixin",["Env"],function(a,b,c,d,e,f){var g=b('Env'),h={_getInstances:function(){if(!this._instances)this._instances={};return this._instances;},get:function(){return this.getForFBID(g.user);},getForFBID:function(i){var j=this._getInstances();if(!j[i])j[i]=new this(i);return j[i];}};e.exports=h;});
__d("MercuryThreadInformer",["ArbiterMixin","copyProperties","MercuryAssert","MercurySingletonMixin"],function(a,b,c,d,e,f){var g=b('ArbiterMixin'),h=b('copyProperties'),i=b('MercuryAssert'),j=b('MercurySingletonMixin');function k(m){if(!m._locked){var n=m._threadDeletions,o=m._threadChanges,p=m._threadReadChanges,q=m._threadlistChanged,r=m._unseenStateChanged,s=m._unreadStateChanged,t=m._receivedMessages,u=m._reorderedMessages,v=m._updatedMessages;m._threadDeletions={};m._threadChanges={};m._threadReadChanges={};m._threadlistChanged=false;m._unseenStateChanged=false;m._unreadStateChanged=false;m._receivedMessages={};m._reorderedMessages={};m._updatedMessages={};var w=Object.keys(o);if(w.length||q)m.inform('threadlist-updated',w);if(w.length)m.inform('threads-updated',o);for(var x in p){m.inform('thread-read-changed',p);break;}for(var x in n){m.inform('threads-deleted',n);break;}if(r)m.inform('unseen-updated',null);if(s)m.inform('unread-updated',null);for(x in t){m.inform('messages-received',t);break;}for(x in u){m.inform('messages-reordered',u);break;}for(x in v){m.inform('messages-updated',v);break;}}}function l(m){this._fbid=m;this._threadDeletions={};this._threadChanges={};this._threadReadChanges={};this._threadlistChanged=false;this._unseenStateChanged=false;this._unreadStateChanged=false;this._receivedMessages={};this._reorderedMessages={};this._updatedMessages={};this._locked=0;}h(l.prototype,g,{updatedThread:function(m){this._threadChanges[m]=true;k(this);},deletedThread:function(m){this._threadDeletions[m]=true;k(this);},updatedThreadlist:function(){this._threadlistChanged=true;k(this);},updatedUnseenState:function(){this._unseenStateChanged=true;k(this);},updatedUnreadState:function(){this._unreadStateChanged=true;k(this);},changedThreadReadState:function(m,n,o){if(!this._threadReadChanges[m]||this._threadReadChanges[m].timestamp<o)this._threadReadChanges[m]={mark_as_read:n,timestamp:o};k(this);},receivedMessage:function(m){i.isThreadID(m.thread_id);var n=m.thread_id;if(!this._receivedMessages[n])this._receivedMessages[n]=[];this._receivedMessages[n].push(m);this.updatedThread(n);},reorderedMessages:function(m,n){this._reorderedMessages[m]={source:n};k(this);},updatedMessage:function(m,n,o){if(!this._updatedMessages[m])this._updatedMessages[m]={};this._updatedMessages[m][n]={source:o};k(this);},synchronizeInforms:function(m){this._locked++;try{m();}catch(n){throw n;}finally{this._locked--;k(this);}},listen:function(m,n){return this.subscribe('threads-updated',function(o,p){if(p[m])n(m);});}});h(l,j);e.exports=l;});
__d("MercuryServerRequests",["ArbiterMixin","AsyncResponse","MercuryConstants","TimestampConverter","Env","JSLogger","KeyedCallbackManager","MercuryAssert","MercuryIDs","MercuryMessageIDs","MessagingReliabilityLogger","MercurySingletonMixin","MercuryServerDispatcher","MercuryThreadInformer","copyProperties","createObjectFrom"],function(a,b,c,d,e,f){var g=b('ArbiterMixin'),h=b('AsyncResponse'),i=b('MercuryConstants'),j=b('TimestampConverter'),k=b('Env'),l=b('JSLogger'),m=b('KeyedCallbackManager'),n=b('MercuryAssert'),o=b('MercuryIDs'),p=b('MercuryMessageIDs'),q=b('MessagingReliabilityLogger'),r=b('MercurySingletonMixin'),s=b('MercuryServerDispatcher'),t=b('MercuryThreadInformer'),u=b('copyProperties'),v=b('createObjectFrom'),w=i.MercuryGenericConstants,x=l.create('mercury_server'),y=i.MercuryAPIArgsSource&&i.MercuryAPIArgsSource.MERCURY,z=i.MercurySendMessageTimeout;function aa(ib,jb){if(jb)ib._lastActionId=j.maxValidActionID(ib._lastActionId,jb);}function ba(ib,jb){var kb=jb.thread_id,lb=ib._serverToClientIDs.getResource(kb);if(!lb){if(jb.canonical_fbid){lb='user:'+jb.canonical_fbid;}else if(jb.root_message_threading_id)lb='root:'+jb.root_message_threading_id;lb=lb||'thread:'+kb;ca(ib,kb,lb);}jb.thread_id=lb;}function ca(ib,jb,kb){ib._serverToClientIDs.setResource(jb,kb);ib._clientToServerIDs.setResource(kb,jb);ib._newlyAddedClientIDs[jb]=kb;}function da(ib,jb,kb){var lb=ib._clientToServerIDs.executeOrEnqueue(jb,kb),mb=ib._clientToServerIDs.getUnavailableResources(lb),nb=ib.tokenizeThreadID(jb);if(mb.length&&nb.type!='root')ib.fetchThreadData(mb);}function ea(ib,jb){return ib._clientToServerIDs.getResource(jb);}function fa(ib,jb){return !!ib._serverToClientIDs.getResource(jb);}function ga(ib,jb){var kb=ib._serverToClientIDs.getResource(jb);if(typeof kb=='undefined')x.warn('no_client_thread_id',{server_id:jb});return kb;}function ha(ib,jb,kb){ib._serverToClientIDs.executeOrEnqueue(jb,kb);ib.ensureThreadIsFetched(jb);}function ia(ib,jb,kb){if(jb.action_type!=i.MercuryActionType.SEND_MESSAGE)return;var lb=jb.client_thread_id;if(!lb)lb=ga(ib,jb.thread_id);var mb=null;if(lb)mb=o.tokenize(lb).type;q.addEntry('send_'+mb,kb,jb.thread_id+','+jb.message_id);}function ja(ib){return ib.getError()?'_'+ib.getError():'';}function ka(ib,jb){var kb=null;switch(jb.status){case i.MercuryActionStatus.SUCCESS:kb='success';break;case i.MercuryActionStatus.FAILED_UNKNOWN_REASON:kb='confirmed_error';break;case i.MercuryActionStatus.UNABLE_TO_CONFIRM:kb='confirm_error';break;default:return;}ia(ib,jb,kb);}function la(ib,jb){(jb.message_counts||[]).forEach(function(sb){aa(ib,sb.last_action_id);});(jb.threads||[]).forEach(function(sb){ba(ib,sb);delete ib._fetchingThreads[sb.thread_id];var tb=ea(ib,sb.thread_id);delete ib._fetchingThreads[tb];aa(ib,sb.last_action_id);});(jb.ordered_threadlists||[]).forEach(function(sb){sb.thread_ids=sb.thread_ids.map(ga.curry(ib));});jb.actions=jb.actions||[];jb.actions.forEach(function(sb){ka(ib,sb);if(sb.status&&sb.status!=i.MercuryActionStatus.SUCCESS&&!sb.thread_id){sb.thread_id=sb.client_thread_id;return;}if(sb.action_type==i.MercuryActionType.SEND_MESSAGE&&sb.client_thread_id&&sb.client_thread_id!=w.PENDING_THREAD_ID)ca(ib,sb.thread_id,sb.client_thread_id);sb.server_thread_id=sb.thread_id;sb.thread_id=fa(ib,sb.thread_id)?ga(ib,sb.thread_id):null;aa(ib,sb.action_id);});if(jb.end_of_history){var kb=[];for(var lb=0;lb<jb.end_of_history.length;lb++){var mb=jb.end_of_history[lb];if(mb.type=='user'){kb.push('user:'+mb.id);}else if(mb.type=='thread'&&fa(ib,mb.id))kb.push(ga(ib,mb.id));}jb.end_of_history=kb;}if(jb.roger){var nb={};for(var ob in jb.roger){var pb=ib._serverToClientIDs.getResource(ob);if(pb){var qb=jb.roger[ob];nb[pb]={};for(var rb in qb)nb[pb]['fbid:'+rb]=qb[rb];}}jb.roger=nb;}}function ma(ib){if(ib._pendingUpdates&&ib._pendingUpdates.length){var jb=ib._pendingUpdates[0];ib._pendingUpdates=ib._pendingUpdates.slice(1);ib.handleUpdate(jb);}}function na(ib,jb){var kb=u({},ib),lb;if(jb.threads){if(!kb.threads)kb.threads={};for(lb in jb.threads)kb.threads[lb]=Object.keys(v((kb.threads[lb]||[]).concat(jb.threads[lb])));}if(jb.messages){if(!kb.messages)kb.messages={};for(lb in jb.messages){if(!kb.messages[lb])kb.messages[lb]={};for(var mb in jb.messages[lb])if(kb.messages[lb][mb]){kb.messages[lb][mb]=qa(kb.messages[lb][mb],jb.messages[lb][mb]);}else kb.messages[lb][mb]=jb.messages[lb][mb];}}kb.client=ib.client||jb.client;return kb;}function oa(ib,jb){var kb=u(v(ib.folders,true),v(jb.folders,true)),lb=ib.client||jb.client;return {folders:Object.keys(kb),client:lb};}function pa(ib,jb){for(var kb in jb)if(ib[kb]&&typeof ib[kb]==='object'){ib[kb]=qa(ib[kb],jb[kb]);}else if(jb[kb]&&typeof jb[kb]==='object'){var lb={};u(lb,jb[kb]);ib[kb]=lb;}return ib;}function qa(ib,jb){var kb=ib.offset<jb.offset?ib.offset:jb.offset,lb=ib.offset+ib.limit,mb=jb.offset+jb.limit,nb=(lb>mb)?lb:mb,ob=nb-kb;return {offset:kb,limit:ob};}function ra(ib,jb){var kb=ib.client||jb.client,lb={ids:{},client:kb};u(lb.ids,ib.ids);u(lb.ids,jb.ids);return lb;}function sa(ib,jb){var kb={},lb,mb=ib.client||jb.client;delete ib.client;delete jb.client;for(lb in ib)u(kb,v(ib[lb],lb));for(lb in jb)u(kb,v(jb[lb],lb));var nb={client:mb};for(var ob in kb){lb=kb[ob];if(!nb[lb])nb[lb]=[];nb[lb].push(ob);}return nb;}function ta(ib,jb){var kb=ib.client||jb.client,lb=v(ib.ids,true),mb=v(jb.ids,true),nb=u(lb,mb);return {ids:Object.keys(nb),client:kb};}function ua(ib){this._fbid=ib;this._lastActionId=0;this._serverToClientIDs=new m();this._clientToServerIDs=new m();this._pendingUpdates=[];this._fetchingThreads={};this._newlyAddedClientIDs={};gb(this);}u(ua.prototype,g,{tokenizeThreadID:function(ib){n.isThreadID(ib);return o.tokenize(ib);},getServerThreadID:function(ib,jb){n.isThreadID(ib);da(this,ib,jb);},getClientThreadID:function(ib,jb){ha(this,ib,jb);},getClientThreadIDNow:function(ib){return ga(this,ib);},getServerThreadIDNow:function(ib){return ea(this,ib);},convertThreadIDIfAvailable:function(ib){var jb=this._serverToClientIDs.getResource(ib);if(jb===undefined){return ib;}else return jb;},canLinkExternally:function(ib){n.isThreadID(ib);var jb=this.tokenizeThreadID(ib);return (jb.type=='user')||!!ea(this,ib);},fetchThreadlistInfo:function(ib,jb,kb,lb,mb){kb=kb||i.MessagingTag.INBOX;mb=mb||y;var nb=lb?s.IMMEDIATE:null,ob={client:mb};ob[kb]={offset:ib,limit:jb,filter:lb};hb(this,'/ajax/mercury/threadlist_info.php',ob,nb);},fetchUnseenThreadIDs:function(ib,jb){jb=jb||y;this.fetchThreadlistInfo(i.MercuryThreadlistConstants.RECENT_THREAD_OFFSET,i.MercuryThreadlistConstants.JEWEL_THREAD_COUNT,ib,null,jb);},fetchUnreadThreadIDs:function(ib,jb){jb=jb||y;hb(this,'/ajax/mercury/unread_threads.php',{folders:[ib],client:jb});},fetchMissedMessages:function(ib,jb){jb=jb||y;hb(this,'/ajax/mercury/thread_sync.php',{last_action_id:this._lastActionId,folders:ib,client:jb});},fetchThreadData:function(ib,jb){jb=jb||y;n.allThreadID(ib);var kb={threads:{},client:jb},lb=[],mb=[];ib.forEach(function(ob){if(this._fetchingThreads[ob])return;this._fetchingThreads[ob]=true;var pb=ea(this,ob);if(pb){mb.push(pb);kb.threads.thread_ids=mb;}else{var qb=this.tokenizeThreadID(ob);if(qb.type=='user'){lb.push(qb.value);kb.threads.user_ids=lb;}else if(qb.type=='thread'){mb.push(qb.value);kb.threads.thread_ids=mb;}else if(qb.type!='root'&&qb.type!='pending')throw new Error('Unknown thread type',qb);}}.bind(this));this.inform("fetch-thread-data",kb);for(var nb in kb.threads){hb(this,'/ajax/mercury/thread_info.php',kb);break;}},ensureThreadIsFetched:function(ib,jb){jb=jb||y;if(!this._serverToClientIDs.getResource(ib)&&!this._fetchingThreads[ib]){this._fetchingThreads[ib]=true;hb(this,'/ajax/mercury/thread_info.php',{threads:{thread_ids:[ib]},client:jb});}},fetchThreadMessages:function(ib,jb,kb,lb,mb){n.isThreadID(ib);mb=mb||y;var nb,ob,pb=this.tokenizeThreadID(ib),qb=ea(this,ib),rb=false;if(qb&&pb.type!='group'){ob='thread_ids';nb=qb;}else{nb=pb.value;switch(pb.type){case 'user':ob='user_ids';rb=true;break;case 'group':ob='group_ids';break;case 'thread':ob='thread_ids';break;}}var sb={messages:{},threads:{},client:mb};if(ob){sb.messages[ob]={};sb.messages[ob][nb]={offset:jb,limit:kb};if(rb)sb.threads[ob]=[nb];hb(this,'/ajax/mercury/thread_info.php',sb,lb);}else da(this,ib,function(tb){sb.messages.thread_ids={};sb.messages.thread_ids[tb]={offset:jb,limit:kb};hb(this,'/ajax/mercury/thread_info.php',sb,lb);}.bind(this));},handleThreadInfoError:function(ib){var jb=ib.getRequest().getData(),kb=[];if(jb.messages){for(var lb in jb.messages.thread_ids)kb.push(va(ga(this,lb)));for(var mb in jb.messages.user_ids)kb.push(va('user:'+mb));for(var nb in jb.messages.group_ids)kb.push(va('group:'+nb));}if(kb.length)this.handleUpdate({actions:kb,from_client:true,payload_source:i.MercuryPayloadSource.CLIENT_CHANNEL_MESSAGE});if(jb.threads&&(jb.threads.user_ids||jb.threads.group_ids||jb.threads.thread_ids)&&!jb.is_retry){if(jb.messages)delete jb.messages;x.log('retry_thread',jb);jb.is_retry=true;hb(this,'/ajax/mercury/thread_info.php',jb);}},markFolderAsRead:function(ib){hb(this,'/ajax/mercury/mark_folder_as_read.php',{folder:ib});var jb=[{action_type:i.MercuryGlobalActionType.MARK_ALL_READ,action_id:null,folder:ib}];this.handleUpdate({global_actions:jb,from_client:true,payload_source:i.MercuryPayloadSource.CLIENT_CHANGE_READ_STATUS});},changeThreadReadStatus:function(ib,jb,kb){n.isThreadID(ib);da(this,ib,function(mb){var nb={ids:{}};nb.ids[mb]=jb;hb(this,'/ajax/mercury/change_read_status.php',nb);}.bind(this));var lb=[{action_type:i.MercuryActionType.CHANGE_READ_STATUS,action_id:null,thread_id:ib,mark_as_read:jb,folder:kb}];this.handleUpdate({actions:lb,from_client:true,payload_source:i.MercuryPayloadSource.CLIENT_CHANGE_READ_STATUS});},changeThreadArchivedStatus:function(ib,jb){n.isThreadID(ib);da(this,ib,function(mb){var nb={ids:{}};nb.ids[mb]=jb;hb(this,'/ajax/mercury/change_archived_status.php',nb);}.bind(this));var kb={action_type:i.MercuryActionType.CHANGE_ARCHIVED_STATUS,action_id:null,thread_id:ib,archived:jb},lb={actions:[kb],from_client:true,payload_source:i.MercuryPayloadSource.CLIENT_CHANGE_ARCHIVED_STATUS};this.handleUpdate(lb);},changeThreadFolder:function(ib,jb){n.isThreadID(ib);da(this,ib,function(mb){var nb={};nb[jb]=[mb];hb(this,'/ajax/mercury/move_thread.php',nb);}.bind(this));var kb={action_type:i.MercuryActionType.CHANGE_FOLDER,action_id:null,thread_id:ib,new_folder:jb},lb={actions:[kb],from_client:true,payload_source:i.MercuryPayloadSource.CLIENT_CHANGE_FOLDER};this.handleUpdate(lb);},changeMutingOnThread:function(ib,jb){n.isThreadID(ib);da(this,ib,function(mb){hb(this,'/ajax/mercury/change_mute_thread.php',{thread_id:mb,mute_settings:jb,payload_source:i.MercuryAPIArgsSource.MERCURY});}.bind(this));var kb={action_type:i.MercuryActionType.CHANGE_MUTE_SETTINGS,action_id:null,thread_id:ib,mute_settings:jb},lb={actions:[kb],from_client:true,payload_source:i.MercuryPayloadSource.CLIENT_CHANGE_MUTE_SETTINGS};this.handleUpdate(lb);},markThreadSpam:function(ib){n.isThreadID(ib);da(this,ib,function(lb){hb(this,'/ajax/mercury/mark_spam.php',{id:lb});}.bind(this));var jb={action_type:i.MercuryActionType.CHANGE_FOLDER,action_id:null,thread_id:ib,new_folder:i.MessagingTag.SPAM},kb={actions:[jb],from_client:true,payload_source:i.MercuryPayloadSource.CLIENT_CHANGE_FOLDER};this.handleUpdate(kb);},markMessagesSpam:function(ib,jb){p.getServerIDs(jb||[],function(lb){hb(this,'/ajax/mercury/mark_spam_messages.php',{message_ids:lb});}.bind(this));var kb={action_type:i.MercuryActionType.DELETE_MESSAGES,action_id:null,thread_id:ib,message_ids:jb};this.handleUpdate({actions:[kb],from_client:true,payload_source:i.MercuryPayloadSource.CLIENT_DELETE_MESSAGES});},unmarkThreadSpam:function(ib){n.isThreadID(ib);da(this,ib,function(lb){hb(this,'/ajax/mercury/unmark_spam.php',{id:lb});}.bind(this));var jb={action_type:i.MercuryActionType.CHANGE_FOLDER,action_id:null,thread_id:ib,new_folder:i.MessagingTag.INBOX},kb={actions:[jb],from_client:true,payload_source:i.MercuryPayloadSource.CLIENT_CHANGE_FOLDER};this.handleUpdate(kb);},deleteThread:function(ib){n.isThreadID(ib);da(this,ib,function(lb){var mb={ids:[lb]};hb(this,'/ajax/mercury/delete_thread.php',mb);}.bind(this));var jb={action_type:i.MercuryActionType.DELETE_THREAD,action_id:null,thread_id:ib},kb={actions:[jb],from_client:true,payload_source:i.MercuryPayloadSource.CLIENT_DELETE_THREAD};this.handleUpdate(kb);},deleteMessages:function(ib,jb,kb){p.getServerIDs(jb||[],function(mb){hb(this,'/ajax/mercury/delete_messages.php',{message_ids:mb});}.bind(this));var lb;if(kb){lb={action_type:i.MercuryActionType.DELETE_THREAD,action_id:null,thread_id:ib};}else lb={action_type:i.MercuryActionType.DELETE_MESSAGES,action_id:null,thread_id:ib,message_ids:jb};this.handleUpdate({actions:[lb],from_client:true,payload_source:i.MercuryPayloadSource.CLIENT_DELETE_MESSAGES});},clearChat:function(ib,jb,kb){n.isThreadID(ib);hb(this,'/ajax/chat/settings.php',{clear_history_id:jb});var lb=[{action_type:i.MercuryActionType.CLEAR_CHAT,action_id:null,thread_id:ib,clear_time:kb}];this.handleUpdate({actions:lb,from_client:true,payload_source:i.MercuryPayloadSource.CLIENT_CLEAR_CHAT});},sendNewMessage:function(ib,jb){jb=jb||y;p.getServerIDs(ib.forward_message_ids||[],function(lb){var mb=ib.thread_id,nb=this.tokenizeThreadID(ib.thread_id),ob=nb.type,pb=u({},ib);pb.forward_message_ids=lb;if((ob=='root'&&nb.value==pb.message_id)||(ob=='user'&&!ea(this,mb))||(ib.thread_id==w.PENDING_THREAD_ID)){pb.client_thread_id=pb.thread_id;pb.thread_id=null;this._sendNewMessageToServer(pb,jb);}else da(this,pb.thread_id,function(qb){pb.thread_id=qb;this._sendNewMessageToServer(pb);}.bind(this));}.bind(this));if(ib.thread_id!=w.PENDING_THREAD_ID){var kb={actions:[u({},ib)],from_client:true,payload_source:i.MercuryPayloadSource.CLIENT_SEND_MESSAGE};this.handleUpdate(kb);}},_sendNewMessageToServer:function(ib,jb){jb=jb||y;hb(this,'/ajax/mercury/send_messages.php',{message_batch:[ib],client:jb});},requestMessageConfirmation:function(ib,jb){jb=jb||y;var kb={},lb={};for(var mb in ib){var nb=ea(this,mb);if(nb){kb[nb]=ib[mb];}else{var ob=ib[mb];for(var pb=0;pb<ob.length;pb++)lb[ob[pb]]=mb;}}var qb=Object.keys(kb),rb=Object.keys(lb);if(qb.length||rb.length)hb(this,'/ajax/mercury/confirm_messages.php',{thread_message_map:kb,local_messages:lb,client:jb});},handleMessageConfirmError:function(ib){var jb=ib.getRequest().getData().thread_message_map,kb=ib.getRequest().getData().local_messages;if(!jb&&!kb)return;var lb=[];for(var mb in jb){var nb=jb[mb];nb.forEach(function(qb){lb.push({action_type:i.MercuryActionType.SEND_MESSAGE,client_message_id:qb,message_id:qb,client_thread_id:null,thread_id:mb,status:i.MercuryActionStatus.UNABLE_TO_CONFIRM});});}for(var ob in kb){var pb=kb[ob];lb.push({action_type:i.MercuryActionType.SEND_MESSAGE,client_message_id:ob,message_id:ob,client_thread_id:pb,thread_id:null,status:i.MercuryActionStatus.UNABLE_TO_CONFIRM});}if(lb.length)this.handleUpdate({actions:lb,payload_source:i.MercuryPayloadSource.CLIENT_HANDLE_ERROR});},markSeen:function(){var ib=j.convertActionIDToTimestamp(this._lastActionId);hb(this,'/ajax/mercury/mark_seen.php',{seen_timestamp:ib});},handleRoger:function(ib){var jb=ib.tid?this._serverToClientIDs.getResource(ib.tid):('user:'+ib.reader);if(jb){var kb={};kb[jb]={};kb[jb]['fbid:'+ib.reader]=ib.time;this.inform('update-roger',kb);}},handleUpdateWaitForThread:function(ib,jb,kb){kb=kb||y;var lb=this._serverToClientIDs.getResource(jb);if(lb){this.handleUpdate(ib);return;}this._serverToClientIDs.executeOrEnqueue(jb,function(){this._pendingUpdates.push(ib);}.bind(this));if(!this._fetchingThreads[jb]){this._fetchingThreads[jb]=true;hb(this,'/ajax/mercury/thread_info.php',{threads:{thread_ids:[jb]},client:kb});}},handleUpdate:function(ib){x.debug('handle_update',{payload:ib,from_client:ib.from_client});for(var jb in ib){t.getForFBID(this._fbid).synchronizeInforms(function(){if(!ib.from_client){la(this,ib);this.inform('payload-preprocessed',ib);}this.inform('update-thread-ids',this._newlyAddedClientIDs);this._newlyAddedClientIDs={};this.inform('update-participants',ib);this.inform('update-threads',ib);this.inform('update-unread',ib);this.inform('update-threadlist',ib);this.inform('update-messages',ib);this.inform('update-unseen',ib);this.inform('update-typing-state',ib);this.inform('update-roger',ib.roger);this.inform('model-update-completed',null);ma(this);}.bind(this));break;}},_handleSendMessageErrorCommon:function(ib,jb,kb,lb){x.debug('handle_send_message_error_common',{reliability_error_status:kb,request_error_status:jb});var mb=ib.getData(),nb=mb.message_batch,ob=nb.map(function(qb){return {action_type:i.MercuryActionType.SEND_MESSAGE,client_message_id:qb.message_id,message_id:qb.message_id,client_thread_id:qb.client_thread_id,thread_id:qb.thread_id,status:jb,error_data:lb};});ob.forEach(function(qb){ia(this,qb,kb);}.bind(this));var pb={actions:ob,payload_source:i.MercuryPayloadSource.CLIENT_HANDLE_ERROR};this.handleUpdate(pb);},handleSendMessageError:function(ib){var jb=ib.getPayload(),kb=null,lb=null;if(jb&&jb.error_payload){kb=i.MercuryActionStatus.UNCONFIRMED;lb='send_error';}else{kb=i.MercuryActionStatus.ERROR;lb='request_error'+ja(ib);}var mb=ib.error;if(mb===1404074)h.verboseErrorHandler(ib);var nb=/<.*>/.test(ib.getErrorDescription())?ib.getErrorSummary():ib.getErrorDescription();this._handleSendMessageErrorCommon(ib.getRequest(),kb,lb,{type:i.MercuryErrorType.SERVER,code:ib.getError(),description:nb,is_transient:ib.isTransient()});},handleSendMessageTransportError:function(ib){this._handleSendMessageErrorCommon(ib.getRequest(),i.MercuryActionStatus.ERROR,'transport_error'+ja(ib),{type:i.MercuryErrorType.TRANSPORT,code:ib.getError(),is_transient:true});},handleSendMessageTimeout:function(ib){this._handleSendMessageErrorCommon(ib,i.MercuryActionStatus.ERROR,'transport_timeout',{type:i.MercuryErrorType.TIMEOUT,is_transient:true});},getLastActionID:function(){return this._lastActionId;}});u(ua,r);function va(ib){return {action_type:i.MercuryActionType.LOG_MESSAGE,thread_id:ib,message_id:ib,timestamp:Date.now(),timestamp_absolute:'',timestamp_relative:'',is_unread:false,source:i.MercurySourceType.UNKNOWN,log_message_type:i.MercuryLogMessageType.SERVER_ERROR,log_message_data:{}};}function wa(ib){var jb=ib.getData(),kb=jb.request_user_id?jb.request_user_id:k.user;return ua.getForFBID(kb);}function xa(ib,jb){wa(jb).handleUpdate(ib);}function ya(ib,jb){var kb=ib.client||jb.client;return {client:kb,message_batch:ib.message_batch.concat(jb.message_batch)};}function za(ib,jb){var kb={};u(kb,ib.ids);u(kb,jb.ids);var lb=ib.client||jb.client;return {ids:kb,client:lb};}function ab(ib,jb){return jb;}function bb(ib){var jb=wa(ib.getRequest());jb.handleThreadInfoError(ib);}function cb(ib){var jb=wa(ib.getRequest());jb.handleSendMessageError(ib);}function db(ib){var jb=wa(ib.getRequest());jb.handleSendMessageTransportError(ib);}function eb(ib){var jb=wa(ib);jb.handleSendMessageTimeout(ib);}function fb(ib){var jb=wa(ib.getRequest());jb.handleMessageConfirmError(ib);}function gb(ib){s.registerEndpoints({'/ajax/mercury/thread_sync.php':{request_user_id:ib._fbid,mode:s.IDEMPOTENT,handler:xa},'/ajax/mercury/thread_info.php':{request_user_id:ib._fbid,mode:s.BATCH_DEFERRED_MULTI,batch_function:na,handler:xa,error_handler:bb},'/ajax/mercury/mark_folder_as_read.php':{request_user_id:ib._fbid,mode:s.IMMEDIATE,handler:xa},'/ajax/mercury/change_read_status.php':{request_user_id:ib._fbid,mode:s.BATCH_SUCCESSIVE,batch_function:za,handler:xa},'/ajax/mercury/send_messages.php':{request_user_id:ib._fbid,mode:s.BATCH_SUCCESSIVE,batch_function:ya,batch_size_limit:i.MessagingConfig.SEND_BATCH_LIMIT,handler:xa,error_handler:cb,transport_error_handler:db,timeout:z,timeout_handler:eb,connection_retries:i.MessagingConfig.SEND_CONNECTION_RETRIES},'/ajax/mercury/mark_seen.php':{request_user_id:ib._fbid,mode:s.BATCH_SUCCESSIVE,batch_function:ab,handler:xa},'/ajax/mercury/confirm_messages.php':{request_user_id:ib._fbid,mode:s.IMMEDIATE,handler:xa,error_handler:fb},'/ajax/mercury/threadlist_info.php':{request_user_id:ib._fbid,mode:s.BATCH_SUCCESSIVE_UNIQUE,batch_function:pa,handler:xa},'/ajax/mercury/mark_spam.php':{request_user_id:ib._fbid,mode:s.IMMEDIATE,handler:xa},'/ajax/mercury/mark_spam_messages.php':{request_user_id:ib._fbid,mode:s.IMMEDIATE,handler:xa},'/ajax/mercury/unmark_spam.php':{request_user_id:ib._fbid,mode:s.IMMEDIATE,handler:xa},'/ajax/mercury/unread_threads.php':{request_user_id:ib._fbid,mode:s.BATCH_SUCCESSIVE_UNIQUE,batch_function:oa,handler:xa},'/ajax/chat/settings.php':{request_user_id:ib._fbid,mode:s.IMMEDIATE},'/ajax/mercury/change_archived_status.php':{request_user_id:ib._fbid,mode:s.BATCH_SUCCESSIVE,batch_function:ra,handler:xa},'/ajax/mercury/delete_thread.php':{request_user_id:ib._fbid,mode:s.BATCH_SUCCESSIVE,batch_function:ta,handler:xa},'/ajax/mercury/delete_messages.php':{request_user_id:ib._fbid,mode:s.IMMEDIATE,handler:xa},'/ajax/mercury/move_thread.php':{request_user_id:ib._fbid,mode:s.BATCH_SUCCESSIVE,batch_function:sa,handler:xa},'/ajax/mercury/change_mute_thread.php':{request_user_id:ib._fbid,mode:s.IMMEDIATE,handler:xa}});}function hb(ib,jb,kb,lb){s.trySend(jb,kb,lb,ib._fbid);}e.exports=ua;});
__d("MercuryFolders",["array-extensions","MercuryConstants"],function(a,b,c,d,e,f){b('array-extensions');var g=b('MercuryConstants'),h=[g.MessagingTag.INBOX,g.MessagingTag.OTHER,g.MessagingTag.ACTION_ARCHIVED,g.MessagingTag.SPAM],i={getSupportedFolders:function(){return h.concat();},isSupportedFolder:function(j){return h.contains(j);},getFromMeta:function(j){var k=j.folder;if(j.is_archived)k=g.MessagingTag.ACTION_ARCHIVED;return k;}};e.exports=i;});
__d("MercuryAttachment",["MercuryConstants","startsWith"],function(a,b,c,d,e,f){var g=b('MercuryConstants'),h=b('startsWith'),i={getAttachIconClass:function(j){switch(j){case g.MercuryAttachmentContentType.PHOTO:return 'MercuryPhotoIcon';case g.MercuryAttachmentContentType.VIDEO:return 'MercuryVideoIcon';case g.MercuryAttachmentContentType.MUSIC:return 'MercuryMusicIcon';case g.MercuryAttachmentContentType.VOICE:return 'MercuryVoiceIcon';case g.MercuryAttachmentContentType.TEXT:return 'MercuryTextIcon';case g.MercuryAttachmentContentType.MSWORD:return 'MercuryMSWordIcon';case g.MercuryAttachmentContentType.MSXLS:return 'MercuryMSXLSIcon';case g.MercuryAttachmentContentType.MSPPT:return 'MercuryMSPPTIcon';}return 'MercuryDefaultIcon';},getAttachIconClassByMime:function(j){if(h(j,'image')){return 'MercuryPhotoIcon';}else if(h(j,'video')){return 'MercuryVideoIcon';}else if(h(j,'audio')){return 'MercuryMusicIcon';}else if(h(j,'text/plain')){return 'MercuryTextIcon';}else return 'MercuryDefaultIcon';},getAttachTypeByMime:function(j){if(h(j,'image')){return g.MercuryAttachmentContentType.PHOTO;}else if(h(j,'video')){return g.MercuryAttachmentContentType.VIDEO;}else if(h(j,'audio')){return g.MercuryAttachmentContentType.MUSIC;}else if(h(j,'text/plain')){return g.MercuryAttachmentContentType.TEXT;}else return g.MercuryAttachmentContentType.UNKNOWN;},convertRaw:function(j){var k=[];for(var l=0;l<j.length;l++){var m=j[l];if(m.filename){var n={};n.attach_type=g.MercuryAttachmentType.FILE;n.name=m.filename;n.icon_type=i.getAttachTypeByMime(m.filetype);n.url='';k.push(n);}}return k;}};e.exports=i;});
__d("MercuryParticipants",["MercuryConstants","Env","MercuryAssert","MercuryIDs","MercuryServerRequests","ShortProfiles","copyProperties","getObjectValues","tx"],function(a,b,c,d,e,f){var g=b('MercuryConstants'),h=b('Env'),i=b('MercuryAssert'),j=b('MercuryIDs'),k=b('MercuryServerRequests').get(),l=b('ShortProfiles'),m=b('copyProperties'),n=b('getObjectValues'),o=b('tx'),p='fbid:'+h.user,q={},r={},s=function(x){x=v(x);if(!q[x.id]){q[x.id]=m({},x);if(x.vanity)r[x.vanity]=x.id;}};function t(x){i.isEmailParticipantID(x);var y=j.tokenize(x),z=y.value;return {gender:g.MercuryParticipantsConstants.UNKNOWN_GENDER,href:null,id:x,image_src:g.MercuryParticipantsConstants.EMAIL_IMAGE,name:z,short_name:z,employee:false,call_promo:false};}function u(x,y,z){i.allParticipantIDs(x);var aa={},ba={};x.forEach(function(da){if(q[da]&&!z){aa[da]=m({},q[da]);}else{var ea=j.tokenize(da);if(ea.type=='fbid'){var fa=ea.value;ba[da]=fa;}else if(ea.type=='email')aa[da]=t(da);}});var ca=n(ba);if(ca.length){l.getMulti(ca,function(da){for(var ea in ba){var fa=ba[ea],ga=da[fa];aa[ea]={gender:ga.gender,href:ga.uri,id:ea,image_src:ga.thumbSrc,name:ga.name,short_name:ga.firstName,employee:ga.employee,call_promo:ga.showVideoPromo,type:ga.type,vanity:ga.vanity,is_friend:ga.is_friend,social_snippets:ga.social_snippets};s(aa[ea]);}y(aa);});}else y(aa);}function v(x){var y=x.type===g.MercuryParticipantTypes.USER||x.type===g.MercuryParticipantTypes.FRIEND;if(!y)return x;if(!x.name&&!x.href&&!x.vanity){var z="Facebook User";x.name=z;x.short_name=z;}return x;}var w={user:p,isAuthor:function(x){return x===p;},getIDFromVanityOrFBID:function(x){if(!x)return;if(r[x])return r[x];if(x.match('^\\d+$'))return w.getIDForUser(x);},getNow:function(x){return q[x];},get:function(x,y){i.isParticipantID(x);w.getMulti([x],function(z){y(z[x]);});},getMulti:function(x,y,z){return u(x,y,false);},getMultiForceDownload:function(x,y){return u(x,y,true);},getUserID:function(x){if(!j.isValid(x))return null;var y=j.tokenize(x);if(y.type!='fbid')return null;return y.value;},getIDForUser:function(x){return 'fbid:'+x;},addParticipants:function(x){x.forEach(s);}};k.subscribe('update-participants',function(x,y){w.addParticipants(y.participants||[]);});e.exports=w;});
__d("MercuryThreads",["Arbiter","MercuryConfig","MercuryConstants","TimestampConverter","MercuryFolders","JSLogger","KeyedCallbackManager","MercuryAssert","MercuryAttachment","MercuryIDs","MercurySingletonMixin","MercuryParticipants","MercuryServerRequests","MercuryThreadInformer","copyProperties","createObjectFrom"],function(a,b,c,d,e,f){var g=b('Arbiter'),h=b('MercuryConfig'),i=b('MercuryConstants'),j=b('TimestampConverter'),k=b('MercuryFolders'),l=b('JSLogger'),m=b('KeyedCallbackManager'),n=b('MercuryAssert'),o=b('MercuryAttachment'),p=b('MercuryIDs'),q=b('MercurySingletonMixin'),r=b('MercuryParticipants'),s=b('MercuryServerRequests'),t=b('MercuryThreadInformer'),u=b('copyProperties'),v=b('createObjectFrom'),w=l.create('mercury_threads');function x(ja,ka,la){var ma=v(ka.participants,true),na=r.getIDForUser(ja._fbid);la.forEach(function(oa){if(ma[oa]!==true){ka.participants.push(oa);if(oa===na)ka.is_subscribed=true;}});}function y(ja,ka,la){ka.participants.remove(la);if(la===r.getIDForUser(ja._fbid))ka.is_subscribed=false;}function z(ja,ka){if(ja.participants[0]!=ka){ja.participants.remove(ka);ja.participants.unshift(ka);}}function aa(ja,ka){var la=ka.body,ma=ka.subject,na='';if(ma){ma=ma.toLowerCase();if(la.slice(0,ma.length).toLowerCase()==ma){na=la;}else if(la){na=ma+' \u00B7 '+la;}else na=ma;}else na=la;ja.snippet=na;ja.snippet_has_attachment=ka.has_attachment;if(ka.raw_attachments&&ka.raw_attachments.length>0){var oa=o.convertRaw(ka.raw_attachments);ja.snippet_attachments=oa;}else ja.snippet_attachments=ka.attachments;ja.is_forwarded_snippet=!!ka.forward_count;ja.snippet_sender=ka.author;}function ba(ja,ka,la){if(!ka)return false;if(!ka.timestamp)return true;var ma=!ka.unread_count;if(la==ma)return false;ka.unread_count=la?0:1;ja._threadInformer.updatedThread(ka.thread_id);return true;}function ca(ja,ka){var la=ja._threads.getAllResources();for(var ma in la){var na=la[ma];if(na.folder==ka){na.unread_count=0;ja._threads.setResource(ma,na);ja._threadInformer.updatedThread(ma);}}}function da(ja,ka,la){if(!ka||ka.chat_clear_time===la)return false;ka.chat_clear_time=la;ja._threadInformer.reorderedMessages(ka.thread_id);return true;}function ea(ja,ka,la,ma){var na=la.action_type;if(na==i.MercuryActionType.USER_GENERATED_MESSAGE||na==i.MercuryActionType.LOG_MESSAGE){la.is_unread&&ka.unread_count++;ka.message_count++;ka.is_archived=false;}switch(na){case i.MercuryActionType.USER_GENERATED_MESSAGE:z(ka,la.author);break;case i.MercuryActionType.SEND_MESSAGE:var oa=la.log_message_type;if(oa==i.MercuryLogMessageType.THREAD_IMAGE)ka.image_src=la.log_message_data.image?la.log_message_data.image.preview_url:null;ka.snippet_attachments=la.attachments;break;case i.MercuryActionType.LOG_MESSAGE:var oa=la.log_message_type;if(oa==i.MercuryLogMessageType.SUBSCRIBE){x(ja,ka,la.log_message_data.added_participants);}else if(oa==i.MercuryLogMessageType.UNSUBSCRIBE){y(ja,ka,la.author);}else if(oa==i.MercuryLogMessageType.THREAD_IMAGE){if(!ma)ka.image_src=la.log_message_data.image?la.log_message_data.image.preview_url:null;}else if(oa==i.MercuryLogMessageType.THREAD_NAME)ka.name=la.log_message_data.name;break;case i.MercuryActionType.CHANGE_READ_STATUS:if(la.timestamp)ja._threadInformer.changedThreadReadState(ka.thread_id,la.mark_as_read,la.timestamp);ba(ja,ka,la.mark_as_read);break;case i.MercuryActionType.CLEAR_CHAT:da(ja,ka,la.clear_time);break;case i.MercuryActionType.CHANGE_ARCHIVED_STATUS:ka.is_archived=la.archived;break;case i.MercuryActionType.CHANGE_FOLDER:ka.folder=la.new_folder;break;case i.MercuryActionType.DELETE_MESSAGES:if(ma){ka.snippet='...';ka.snippet_has_attachment=false;ka.snippet_attachments=null;ka.snippet_sender=null;ka.is_forwarded_snippet=false;ja._threadInformer.updatedThread(la.thread_id);}else if(la.message_ids)ka.message_count=ka.message_count-la.message_ids.length;break;case i.MercuryActionType.CHANGE_MUTE_SETTINGS:if(h.MuteThreadsOnDesktopGK&&la.mute_settings!==undefined){var pa=ja._fbid+'@facebook.com';if(ka.mute_settings){if(la.mute_settings){ka.mute_settings[pa]=la.mute_settings;}else delete ka.mute_settings[pa];ja._threadInformer.updatedThread(ka.thread_id);}}break;}if(la.action_id)ka.last_action_id=j.maxValidActionID(la.action_id,ka.last_action_id);}function fa(ja,ka){var la=ja._serverRequests.tokenizeThreadID(ka.thread_id);if(la.type=='group'){w.error('invalid_new_thread_message',ka);return undefined;}var ma=ha(ja,ka.specific_to_list),na={thread_id:ka.thread_id,last_action_id:ka.action_id,participants:ka.specific_to_list,name:null,snippet:ka.body,snippet_has_attachment:false,snippet_attachments:[],snippet_sender:ka.author,unread_count:0,message_count:0,image_src:null,timestamp_absolute:ka.timestamp_absolute,timestamp_relative:ka.timestamp_relative,timestamp:ka.timestamp,canonical_fbid:la.type==='user'?la.value:null,is_canonical_user:la.type==='user',is_canonical:ma,is_subscribed:true,root_message_threading_id:ka.message_id,folder:i.MessagingTag.INBOX,is_archived:false,mode:i.MercuryThreadMode.TITAN_ORIGINATED};return na;}function ga(ja){this._fbid=ja;this._serverRequests=s.getForFBID(this._fbid);this._threadInformer=t.getForFBID(this._fbid);this._threads=new m();ia(this);}u(ga.prototype,{getThreadMetaNow:function(ja){n.isThreadID(ja);return this._threads.getResource(ja);},getThreadMeta:function(ja,ka,la){n.isThreadID(ja);var ma=this._threads.executeOrEnqueue(ja,ka),na=this._threads.getUnavailableResources(ma);if(na.length){var oa=this._serverRequests.tokenizeThreadID(ja);if(oa.type=='user'){this.getCanonicalThreadToUser(oa.value);}else this._serverRequests.fetchThreadData(na,la);}return ma;},unsubscribe:function(ja){this._threads.unsubscribe(ja);},changeThreadReadStatus:function(ja,ka){n.isThreadID(ja);var la=this._threads.getResource(ja);if(ba(this,la,ka))this._serverRequests.changeThreadReadStatus(ja,ka,k.getFromMeta(la));},changeThreadArchivedStatus:function(ja,ka){n.isThreadID(ja);var la=this._threads.getResource(ja);if(la.is_archived!=ka){la.is_archived=ka;this._threadInformer.updatedThread(la.thread_id);this._serverRequests.changeThreadArchivedStatus(ja,ka);}},markThreadSpam:function(ja){this._serverRequests.markThreadSpam(ja);},unmarkThreadSpam:function(ja){this._serverRequests.unmarkThreadSpam(ja);},updateThreadMuteSetting:function(ja,ka){this._serverRequests.changeMutingOnThread(ja,ka);},changeFolder:function(ja,ka){n.isThreadID(ja);var la=this._threads.getResource(ja);if(la&&la.folder!=ka){la.folder=ka;this._threadInformer.updatedThread(la.thread_id);this._serverRequests.changeThreadFolder(ja,ka);}},deleteThread:function(ja){n.isThreadID(ja);this._serverRequests.deleteThread(ja);},updateThreads:function(ja){if(!ja||!ja.length)return;var ka={};ja.forEach(function(la){ka[la.thread_id]=la;});this._threads.addResourcesAndExecute(ka);},updateMetadataByActions:function(ja,ka){if(!ja||!ja.length)return;var la={},ma={},na={};for(var oa=0;oa<ja.length;oa++){var pa=ja[oa];if(pa.is_forward)continue;var qa=pa.action_type,ra=pa.thread_id;n.isThreadID(ra);var sa=this.getThreadMetaNow(ra);if(qa==i.MercuryActionType.LOG_MESSAGE&&pa.log_message_type==i.MercuryLogMessageType.SERVER_ERROR)continue;if(!sa&&!pa.action_id&&qa==i.MercuryActionType.USER_GENERATED_MESSAGE){sa=fa(this,pa);this._threads.setResource(ra,sa);}if(sa){if(qa==i.MercuryActionType.DELETE_THREAD){sa.message_count=0;this._threadInformer.deletedThread(ra);continue;}var ta=!!pa.action_id;if(qa==i.MercuryActionType.LOG_MESSAGE||qa==i.MercuryActionType.USER_GENERATED_MESSAGE)ta=!ka;if(sa.server_timestamp&&pa.timestamp<=sa.server_timestamp&&ta)continue;if(!na[ra])na[ra]=u({},sa);ea(this,na[ra],pa,ka);if(qa==i.MercuryActionType.USER_GENERATED_MESSAGE)la[ra]=pa;if(qa==i.MercuryActionType.USER_GENERATED_MESSAGE||qa==i.MercuryActionType.LOG_MESSAGE||qa==i.MercuryActionType.SEND_MESSAGE)if(pa&&pa.timestamp&&(!ma[ra]||pa.timestamp>ma[ra].timestamp))ma[ra]=pa;}}for(var ua in na){var va=na[ua],wa=la[ua];if(wa)aa(va,wa);var xa=ma[ua],ya=va.timestamp;if(xa){if(xa.timestamp>ya)va=u(va,{timestamp_absolute:xa.timestamp_absolute,timestamp_relative:xa.timestamp_relative,timestamp:xa.timestamp});var za=va.server_timestamp;if(!ka&&xa.timestamp>za)va.server_timestamp=xa.timestamp;}this._threads.setResource(ua,va);}},getCanonicalThreadToUser:function(ja,ka,la){return this.getCanonicalThreadToParticipant('fbid:'+ja,ka,la);},getCanonicalThreadToParticipant:function(ja,ka,la){var ma=this.getThreadIDForParticipant(ja),na=this._threads.getResource(ma);if(typeof na=='undefined'){na=this.createNewLocalThread(ma,[r.getIDForUser(this._fbid),ja],ka);this._serverRequests.fetchThreadData([ma],la);}return na;},getThreadIdForUser:function(ja){return 'user:'+ja;},getThreadIDForParticipant:function(ja){var ka=p.tokenize(ja);return this.getThreadIdForUser(ka.value);},createNewLocalThread:function(ja,ka,la){var ma=this._threads.getResource(ja);if(!ma){var na=this._serverRequests.tokenizeThreadID(ja);ma={thread_id:ja,last_action_id:null,participants:ka,name:null,snippet:'',snippet_has_attachment:false,snippet_sender:null,unread_count:la?la:0,message_count:0,image_src:null,timestamp_absolute:null,timestamp_relative:null,timestamp:null,canonical_fbid:na.type==='user'?na.value:null,is_canonical_user:na.type=='user',is_canonical:ha(this,ka),is_subscribed:true,root_message_threading_id:null,folder:i.MessagingTag.INBOX,is_archived:false,mode:i.MercuryThreadMode.TITAN_ORIGINATED};this._threads.setResource(ja,ma);}return ma;},addParticipantsToThreadLocally:function(ja,ka){var la=this._threads.getResource(ja);if(la){x(this,la,ka);this._threadInformer.updatedThread(la.thread_id);}},getCanonicalUserInThread:function(ja){var ka=this._serverRequests.tokenizeThreadID(ja);return ka.type=='user'?ka.value:null;},getCanonicalGroupInThread:function(ja){var ka=this._serverRequests.tokenizeThreadID(ja);return ka.type=='group'?ka.value:null;},isEmptyLocalThread:function(ja){var ka=this._threads.getResource(ja);if(!ka)return false;var la=this._serverRequests.tokenizeThreadID(ja);return la.type=='root'&&!ka.timestamp;},canReply:function(ja){var ka=this._threads.getResource(ja);return ka&&ka.is_subscribed&&ka.mode!=i.MercuryThreadMode.OBJECT_ORIGINATED&&(ka.recipients_loadable||ka.recipients_loadable===undefined);}});u(ga,q);function ha(ja,ka){var la=ka.filter(function(ma){return ma!=r.getIDForUser(ja._fbid);});return la.length<=1;}function ia(ja){ja._serverRequests.subscribe('update-threads',function(ka,la){var ma=(la.actions||[]).filter(function(qa){return qa.thread_id;});ja.updateThreads(la.threads);ja.updateMetadataByActions(ma,la.from_client);(la.threads||[]).forEach(function(qa){ja._threadInformer.updatedThread(qa.thread_id);});var na=la.global_actions||[];for(var oa=0;oa<na.length;oa++){var pa=na[oa];if(pa.action_type==i.MercuryGlobalActionType.MARK_ALL_READ)ca(ja,pa.folder);}});}g.subscribe(l.DUMP_EVENT,function(ja,ka){ka.messaging=ka.messaging||{};ka.messaging.threads={};var la=ga._getInstances();for(var ma in la)ka.messaging.threads[ma]=la[ma]._threads.dumpResources();});e.exports=ga;});
__d("MercuryUnreadState",["Arbiter","MercuryConstants","MercuryFolders","JSLogger","KeyedCallbackManager","MercurySingletonMixin","MercuryServerRequests","MercuryThreadInformer","MercuryThreads","copyProperties","createObjectFrom"],function(a,b,c,d,e,f){var g=b('Arbiter'),h=b('MercuryConstants'),i=b('MercuryFolders'),j=b('JSLogger'),k=b('KeyedCallbackManager'),l=b('MercurySingletonMixin'),m=b('MercuryServerRequests'),n=b('MercuryThreadInformer'),o=b('MercuryThreads'),p=b('copyProperties'),q=b('createObjectFrom'),r=(i.getSupportedFolders()||[]).filter(function(ia){return ia!=h.MessagingTag.ACTION_ARCHIVED;}),s='unread_thread_hash',t='unseen_thread_list',u=h.MercuryThreadlistConstants.MAX_UNREAD_COUNT,v=j.create('mercury_unread_state');function w(ia){this._fbid=ia;this._serverRequests=m.getForFBID(this._fbid);this._threadInformer=n.getForFBID(this._fbid);this._threads=o.getForFBID(this._fbid);this._allReadTimestamp={};this._threadReadTimestamp={};this._initialUnreadCount={};this._maxCount={};this._unreadResources={};r.forEach(function(ja){this._initialUnreadCount[ja]=0;this._maxCount[ja]=false;this._unreadResources[ja]=new k();}.bind(this));this._serverRequests.subscribe('update-unread',function(ja,ka){ba(this,ka);var la=ka.global_actions||[];for(var ma=0;ma<la.length;ma++){var na=la[ma];if(na.action_type==h.MercuryGlobalActionType.MARK_ALL_READ)ea(this,na.folder,na.timestamp);}}.bind(this));this._serverRequests.subscribe('update-thread-ids',function(ja,ka){ga(this,ka);}.bind(this));}p(w.prototype,{getUnreadCount:function(ia){if(this.exceedsMaxCount(ia)){v.error('unguarded_unread_count_fetch',{});return 0;}return aa(this,ia);},exceedsMaxCount:function(ia){return this._maxCount[ia]||(aa(this,ia)>u);},markFolderAsRead:function(ia){if(this._maxCount[ia]||aa(this,ia)>0)this._serverRequests.markFolderAsRead(ia);}});p(w,l);function x(ia,ja,ka){ia._unreadResources[ja].setResource(s,ka);ia._unreadResources[ja].setResource(t,Object.keys(ka));}function y(ia,ja,ka){var la=ia._unreadResources[ja].executeOrEnqueue(s,ka),ma=ia._unreadResources[ja].getUnavailableResources(la);if(ma.length)ia._serverRequests.fetchUnreadThreadIDs(ja);}function z(ia,ja){return ia._unreadResources[ja].getResource(s);}function aa(ia,ja){var ka=ia._unreadResources[ja].getResource(t);if(ka){return ka.length;}else return ia._initialUnreadCount[ja];}function ba(ia,ja){var ka;(ja.unread_thread_ids||[]).forEach(function(la){ka=la.folder;if(!ha(ka))return;var ma=fa(ia,la.thread_ids);x(ia,ka,q(ma,true));if(ma.length>u)ia._maxCount[ka]=true;ia._threadInformer.updatedUnreadState();});(ja.message_counts||[]).forEach(function(la){if(la.unread_count===undefined)return;ka=la.folder;if(la.unread_count>u){ia._maxCount[ka]=true;x(ia,ka,{});ia._threadInformer.updatedUnreadState();}else{ia._initialUnreadCount[ka]=la.unread_count;if(ia._initialUnreadCount[ka]===0)x(ia,ka,{});ia._threadInformer.updatedUnreadState();}});(ja.actions||[]).forEach(function(la){if(la.is_forward)return;var ma=h.MercuryActionType,na=la.thread_id?la.thread_id:la.server_thread_id;if(la.action_type==ma.DELETE_THREAD){r.forEach(function(pa){da(ia,pa,na);});}else if(la.action_type==ma.CHANGE_ARCHIVED_STATUS||la.action_type==ma.CHANGE_FOLDER){var oa=ia._threads.getThreadMetaNow(la.thread_id);ka=i.getFromMeta(oa);if(ha(ka)&&oa.unread_count>0)ca(ia,ka,na);r.forEach(function(pa){if(pa!=ka)da(ia,pa,na);});}else{ka=la.folder;if(!ha(ka))return;if(la.action_type==ma.CHANGE_READ_STATUS){if(la.mark_as_read){da(ia,ka,na,la.timestamp);}else ca(ia,ka,na,la.timestamp);}else if(la.action_type==ma.USER_GENERATED_MESSAGE||la.action_type==ma.LOG_MESSAGE)if(la.is_unread)ca(ia,ka,na,la.timestamp);}});}function ca(ia,ja,ka,la){if(ia._maxCount[ja])return;y(ia,ja,function(ma){var na=ia._allReadTimestamp[ja]||0,oa=ia._threadReadTimestamp[ka]||0,pa=la||Number.POSITIVE_INFINITY;if(pa>=na&&pa>=oa&&!ma[ka]){ma[ka]=la||0;x(ia,ja,ma);ia._threadInformer.updatedUnreadState();}});}function da(ia,ja,ka,la){if(ia._maxCount[ja])return;y(ia,ja,function(ma){if(la){var na=ia._threadReadTimestamp[ka];if(!na||na<la)ia._threadReadTimestamp[ka]=la;}var oa=ma[ka];if(la&&typeof oa=='number'&&la<oa)return;if(ka in ma){delete ma[ka];x(ia,ja,ma);ia._threadInformer.updatedUnreadState();}});}function ea(ia,ja,ka){ia._maxCount[ja]=false;x(ia,ja,{});ia._allReadTimestamp[ja]=Math.max(ia._allReadTimestamp[ja]||0,ka||0);ia._threadInformer.updatedUnreadState();}function fa(ia,ja){return ja.map(ia._serverRequests.convertThreadIDIfAvailable.bind(ia._serverRequests));}function ga(ia,ja){r.forEach(function(ka){var la=z(ia,ka);if(!la)return;for(var ma in ja){var na=ja[ma];if(la[ma]){la[na]=la[ma];delete la[ma];}}x(ia,ka,la);});}function ha(ia){return r.contains(ia);}g.subscribe(j.DUMP_EVENT,function(ia,ja){ja.messaging=ja.messaging||{};ja.messaging.unread={};ja.messaging.unread_max_count={};var ka=w._getInstances();for(var la in ka){ja.messaging.unread[la]={};ja.messaging.unread_max_count[la]={};r.forEach(function(ma){ja.messaging.unread[la][ma]=p({},z(ka[la],ma));ja.messaging.unread_max_count[la][ma]=ka[la]._maxCount[ma];});}});e.exports=w;});
__d("MercuryLeftNavCountControl",["Arbiter","MercuryConstants","CSS","DOM","MercuryThreadInformer","MercuryUnreadState","copyProperties"],function(a,b,c,d,e,f){var g=b('Arbiter'),h=b('MercuryConstants'),i=b('CSS'),j=b('DOM'),k=b('MercuryThreadInformer').get(),l=b('MercuryUnreadState').get(),m=b('copyProperties'),n,o,p=function(q,r){n=q;o=r;this.render();this.listenerToken=k.subscribe('unread-updated',this.render.bind(this));this.subscriptions=[g.subscribe('onload/exit',this.cleanup.bind(this))];};m(p.prototype,{render:function(){var q=l.exceedsMaxCount(h.MessagingTag.INBOX);if(q){j.setContent(n,h.MercuryThreadlistConstants.MAX_UNREAD_COUNT);}else{var r=l.getUnreadCount(h.MessagingTag.INBOX);j.setContent(n,r.toString());i.conditionClass(n.parentNode,'hidden_elem',r<=0);}j.setContent(o,q?'+':'');},cleanup:function(){this.subscriptions.forEach(g.unsubscribe);k.unsubscribe(this.listenerToken);}});e.exports=p;});
__d("MercuryLeftNav",["DOM","MercuryServerRequests","MercuryLeftNavCountControl"],function(a,b,c,d,e,f){var g=b('DOM'),h=b('MercuryServerRequests').get(),i=b('MercuryLeftNavCountControl');function j(k,l){h.handleUpdate(l);var m=g.scry(k,'span.countValue')[0],n=g.scry(k,'span.maxCountIndicator')[0];new i(m,n);}e.exports=j;});
__d("WebMessengerPermalinkConstants",["URI"],function(a,b,c,d,e,f){var g=b('URI'),h={ARCHIVED_PATH:'/messages/archived',BASE_PATH:'/messages',OTHER_PATH:'/messages/other',SPAM_PATH:'/messages/spam',COMPOSE_POSTFIX_PATH:'/new',SEARCH_POSTFIX_PATH:'/search',TID_POSTFIX_PARTIAL_PATH:'/conversation-',overriddenVanities:'(archived|other|spam|new|search|conversation-.*)',getURIPathForThreadID:function(i,j){return (j||h.BASE_PATH)+h.TID_POSTFIX_PARTIAL_PATH+g.encodeComponent(g.encodeComponent(i));},getThreadIDFromURI:function(i){var j=i.getPath().match(h.BASE_PATH+'(/[^/]*)*'+h.TID_POSTFIX_PARTIAL_PATH+'([^/]+)');if(j){var k=g.decodeComponent(g.decodeComponent(j[2]));return k;}},getURIPathForIDOrVanity:function(i,j){if(i.match('^'+h.overriddenVanities+'$'))i='.'+i;return (j||h.BASE_PATH)+'/'+i;},getUserIDOrVanity:function(i){var j=i.match(h.BASE_PATH+'.*/([^/]+)/?$'),k=j&&j[1],l=h.overriddenVanities;if(!k||k.match('^'+l+'$')){return false;}else if(k.match('^\\.'+l+'$')){return k.substr(1);}else return k;}};e.exports=h;});
__d("MercuryEmoji",["MercuryConfig","Emoji","Emote"],function(a,b,c,d,e,f){var g=b('MercuryConfig'),h=b('Emoji'),i=b('Emote'),j={htmlEmojiAndEmote:function(k,l){if(g.MessagingDisplayEmojiGK){return h.htmlEmojiAndEmote(k,l);}else return i.htmlEmote(k,l);}};e.exports=j;});
__d("MercuryErrorInfo",["MercuryConstants","tx"],function(a,b,c,d,e,f){var g=b('MercuryConstants'),h=b('tx'),i={getMessage:function(j){var k="This message failed to send.";if(i.isConnectionError(j)){k="Unable to connect to Facebook. This message failed to send. ";}else if(j.description)k=j.description;return k;},isConnectionError:function(j){if(j&&j.type==g.MercuryErrorType.TRANSPORT)return j.code===1001||j.code===1004||j.code===1006;return false;}};e.exports=i;});
__d("MercuryChannelHandler",["Arbiter","ChannelConstants","MercuryConfig","MercuryConstants","MessagingReliabilityLogger","MercuryParticipants","PresenceUtil","MercuryServerRequests","MercuryThreadInformer","copyProperties"],function(a,b,c,d,e,f){var g=b('Arbiter'),h=b('ChannelConstants'),i=b('MercuryConfig'),j=b('MercuryConstants'),k=b('MessagingReliabilityLogger'),l=b('MercuryParticipants'),m=b('PresenceUtil'),n=b('MercuryServerRequests').get(),o=b('MercuryThreadInformer').get(),p=b('copyProperties');function q(fa,ga){if(fa!=h.getArbiterType('messaging')||!ga.obj||!ga.obj.message){k.addEntry('channel_receive','invalid_data');return;}var ha=ga.obj.message,ia={author:ha.mercury_author_id,author_email:ha.mercury_author_email,body:ha.body,subject:ha.subject,has_attachment:ha.has_attachment,attachments:ha.attachments,html_body:ha.html_body,thread_id:ha.tid,message_id:ha.mid,coordinates:ha.mercury_coordinates,spoof_warning:ha.mercury_spoof_warning,source:ha.mercury_source,source_tags:ha.mercury_source_tags,threading_id:ha.threading_id,timestamp:ha.timestamp,timestamp_absolute:ha.timestamp_absolute,timestamp_relative:ha.timestamp_relative,timestamp_time_passed:ha.timestamp_time_passed,action_type:j.MercuryActionType.USER_GENERATED_MESSAGE,is_unread:ha.is_unread,action_id:ha.action_id,is_forward:false,forward_count:ha.forward_count||ha.forward,forward_message_ids:ha.forward_msg_ids,location_text:ha.location_text,folder:ga.obj.folder},ja=[p({},ia)];ja=ja.concat(ha.forward_actions||[]);var ka=j.MercuryPayloadSource.CLIENT_CHANNEL_MESSAGE;n.handleUpdateWaitForThread({actions:ja,payload_source:ka},ha.tid);if(!ha.is_unread&&ha.mercury_author_id===l.user){var la={};la[ha.tid]=ga.obj.folder;r(h.getArbiterType('messaging'),{obj:{event:j.MessagingEventTypes.READ,tids:[ha.tid],folder_info:la,timestamp:ha.timestamp}});}k.addEntry('channel_receive','success',[ia.thread_id,ia.message_id,m.getSessionID()]);}function r(fa,ga){if(fa!=h.getArbiterType('messaging')||!ga.obj||!ga.obj.tids)return;var ha=[],ia=ga.obj.event==j.MessagingEventTypes.READ;ga.obj.tids.forEach(function(ja){ha.push({action_type:j.MercuryActionType.CHANGE_READ_STATUS,action_id:null,thread_id:ja,mark_as_read:ia,timestamp:ga.obj.timestamp||0,folder:ga.obj.folder_info[ja]});});n.handleUpdate({actions:ha,payload_source:j.MercuryPayloadSource.CLIENT_CHANNEL_MESSAGE});}function s(fa,ga){if(fa!=h.getArbiterType('messaging')||!ga.obj||!ga.obj.tids)return;var ha=[];ga.obj.tids.forEach(function(ia){ha.push({action_type:j.MercuryActionType.DELETE_THREAD,action_id:null,thread_id:ia});});n.handleUpdate({actions:ha,payload_source:j.MercuryPayloadSource.CLIENT_CHANNEL_MESSAGE});}function t(fa,ga){if(fa!=h.getArbiterType('messaging')||!ga.obj||!ga.obj.tids||!ga.obj.mids)return;var ha=ga.obj.tids[0],ia={action_type:j.MercuryActionType.DELETE_MESSAGES,action_id:null,thread_id:ha,message_ids:ga.obj.mids};n.handleUpdate({actions:[ia],threads:[ga.obj.updated_thread],payload_source:j.MercuryPayloadSource.CLIENT_CHANNEL_MESSAGE});}function u(fa,ga){if(fa!=h.getArbiterType('messaging')||!ga.obj||!ga.obj.folder)return;var ha={action_type:j.MercuryGlobalActionType.MARK_ALL_READ,action_id:ga.obj.action_id,folder:ga.obj.folder};n.handleUpdate({global_actions:[ha]});}function v(fa,ga){if(fa!=h.getArbiterType('messaging')||!ga.obj.tids)return;var ha=j.MercuryPayloadSource.CLIENT_CHANNEL_MESSAGE;ga.obj.tids.forEach(function(ia){var ja={action_type:j.MercuryActionType.CHANGE_ARCHIVED_STATUS,action_id:null,thread_id:ia,archived:ga.obj.state};n.handleUpdateWaitForThread({actions:[p({},ja)],payload_source:ha},ia);});}function w(fa,ga){if(fa!=h.getArbiterType('messaging')||!ga.obj.tids)return;var ha=j.MercuryPayloadSource.CLIENT_CHANNEL_MESSAGE,ia;ga.obj.tids.forEach(function(ja){if(ga.obj.event==j.MessagingEventTypes.TAG){ia=ga.obj.tag;}else ia=ga.obj.marked_as_spam?j.MessagingTag.SPAM:j.MessagingTag.INBOX;var ka={action_type:j.MercuryActionType.CHANGE_FOLDER,action_id:null,thread_id:ja,new_folder:ia};n.handleUpdateWaitForThread({actions:[p({},ka)],payload_source:ha},ja);});}function x(fa,ga){if(fa!=h.getArbiterType('messaging')||!ga.obj.tag)return;switch(ga.obj.tag){case j.MessagingTag.ACTION_ARCHIVED:v(fa,ga);break;case j.MessagingTag.INBOX:case j.MessagingTag.OTHER:w(fa,ga);break;}}function y(fa,ga){if(fa!=h.getArbiterType('inbox')||!ga.obj||!ga.obj.seen_timestamp)return;n.handleUpdate({message_counts:[{seen_timestamp:ga.obj.seen_timestamp,folder:j.MessagingTag.INBOX}],unseen_thread_ids:[{thread_ids:[],folder:j.MessagingTag.INBOX}],payload_source:j.MercuryPayloadSource.CLIENT_CHANNEL_MESSAGE});}function z(fa,ga){if(fa!=h.getArbiterType('mercury')||!ga.obj)return;o.synchronizeInforms(function(){var ha=ga.obj,ia=[];(ha.actions||[]).forEach(function(ja){var ka=j.MercuryActionType.USER_GENERATED_MESSAGE;if(ja.action_type==j.MercuryActionType.LOG_MESSAGE){var la=j.MercuryPayloadSource.CLIENT_CHANNEL_MESSAGE;n.handleUpdateWaitForThread({actions:[p({},ja)],payload_source:la},ja.thread_id);}else if(ja.action_type!=ka)ia.push(ja);});ha.actions=ia;ha.payload_source=j.MercuryPayloadSource.CLIENT_CHANNEL_MESSAGE;n.handleUpdate(ha);});}function aa(fa,ga){n.handleRoger(ga.obj);}function ba(fa,ga){if(fa!=h.getArbiterType('messaging')||!ga.obj||ga.obj.mute_settings===undefined||!ga.obj.thread_id)return;var ha=j.MercuryActionType.CHANGE_MUTE_SETTINGS,ia=[{action_type:ha,action_id:null,thread_id:ga.obj.thread_id,mute_settings:ga.obj.mute_settings}];n.handleUpdate({actions:ia,payload_source:j.MercuryPayloadSource.CLIENT_CHANNEL_MESSAGE});}function ca(fa,ga){switch(ga.obj.event){case j.MessagingEventTypes.DELIVER:q(fa,ga);break;case j.MessagingEventTypes.READ:case j.MessagingEventTypes.UNREAD:r(fa,ga);break;case j.MessagingEventTypes.READ_ALL:u(fa,ga);break;case j.MessagingEventTypes.DELETE:s(fa,ga);break;case j.MessagingEventTypes.DELETE_MESSAGES:t(fa,ga);break;case j.MessagingEventTypes.TAG:x(fa,ga);break;case j.MessagingEventTypes.REPORT_SPAM:w(fa,ga);break;case j.MessagingEventTypes.READ_RECEIPT:aa(fa,ga);break;case j.MessagingEventTypes.CHANGE_MUTE_SETTINGS:if(i.MuteThreadsOnDesktopGK)ba(fa,ga);break;}}var da=[],ea={turnOn:function(){if(!da.length){var fa={mercury:z,messaging:ca,inbox:y};for(var ga in fa)da.push(g.subscribe(h.getArbiterType(ga),fa[ga]));}},turnOff:function(){if(da.length){da.forEach(g.unsubscribe);da=[];}}};ea.turnOn();e.exports=ea;});
__d("MercuryMessages",["Arbiter","AsyncRequest","MercuryConstants","Env","JSLogger","KeyedCallbackManager","MercuryAssert","MercuryConfig","MercuryIDs","MercurySingletonMixin","MercuryMessageIDs","MercuryParticipants","PresenceUtil","RangedCallbackManager","MercuryServerRequests","MercuryThreadInformer","MercuryThreads","copyProperties","debounce","randomInt","tx"],function(a,b,c,d,e,f){var g=b('Arbiter'),h=b('AsyncRequest'),i=b('MercuryConstants'),j=b('Env'),k=b('JSLogger'),l=b('KeyedCallbackManager'),m=b('MercuryAssert'),n=b('MercuryConfig'),o=b('MercuryIDs'),p=b('MercurySingletonMixin'),q=b('MercuryMessageIDs'),r=b('MercuryParticipants'),s=b('PresenceUtil'),t=b('RangedCallbackManager'),u=b('MercuryServerRequests'),v=b('MercuryThreadInformer'),w=b('MercuryThreads'),x=b('copyProperties'),y=b('debounce'),z=b('randomInt'),aa=b('tx'),ba=i.MercuryGenericConstants;function ca(ta,ua){var va=ua;if(ta._localIdsMap[ua])va=ta._localIdsMap[ua];return ta._messages[va];}var da=new l();function ea(ta,ua){if(ua.status===undefined)ua.status=i.MercuryActionStatus.UNSENT;ua.timestamp_absolute="Today";ua.message_id=ua.message_id||ta.generateNewClientMessageID(ua.timestamp);var va=r.getIDForUser(ta._fbid);ua.specific_to_list=ua.specific_to_list||[];if(ua.specific_to_list.length&&ua.specific_to_list.indexOf(va)===-1)ua.specific_to_list.push(va);if(!ua.thread_id){if(ua.specific_to_list.length==1){ua.thread_id='user:'+ta._fbid;}else if(ua.specific_to_list.length==2){var wa=ua.specific_to_list[0]==va?ua.specific_to_list[1]:ua.specific_to_list[0];if(o.tokenize(wa).type=='email'){ua.thread_id=ba.PENDING_THREAD_ID;}else ua.thread_id=ta._threads.getThreadIDForParticipant(wa);}ua.thread_id=ua.thread_id||'root:'+ua.message_id;}if(!ua.specific_to_list.length){var xa=ta._serverRequests.tokenizeThreadID(ua.thread_id);if(xa.type=='user')ua.specific_to_list=['fbid:'+xa.value,va];}}function fa(ta,ua,va,wa){var xa=pa(va)?[i.MercuryMessageSourceTags.CHAT]:[],ya=Date.now(),za=Date.format(n['24h_times']?'H:i':'g:ia',Math.floor(ya/1000)),ab={action_type:ua,thread_id:wa,author:r.getIDForUser(ta._fbid),author_email:null,coordinates:null,timestamp:ya,timestamp_absolute:(new Date(ya)).toLocaleDateString(),timestamp_relative:za,timestamp_time_passed:i.MercuryTimePassed.TODAY,is_unread:false,is_cleared:false,is_forward:false,is_filtered_content:false,spoof_warning:false,source:va,source_tags:xa};return ab;}function ga(ta){switch(ta){case i.MercuryPayloadSource.UNKNOWN:case i.MercuryPayloadSource.SERVER_INITIAL_DATA:case i.MercuryPayloadSource.SERVER_FETCH_THREAD_INFO:case i.MercuryPayloadSource.SERVER_THREAD_SYNC:return true;}return false;}function ha(ta){return ta&&ta.substr(0,6)==='server';}function ia(ta,ua){if(!ta._threadsToMessages[ua])ta._threadsToMessages[ua]=new t(function(va){return ca(ta,va).timestamp;},function(va,wa){return wa-va;});return ta._threadsToMessages[ua];}g.subscribe(k.DUMP_EVENT,function(ta,ua){var va={},wa={},xa=ka._getInstances();for(var ya in xa){va[ya]={};for(var za in xa[ya]._messages){var ab=xa[ya]._messages[za];if(Object.keys(ab).length===0)continue;var bb=ab.thread_id;va[ya][bb]=va[ya][bb]||{};va[ya][bb][ab.message_id]={action_type:ab.action_type,author:ab.author,is_unread:ab.is_unread,timestamp:ab.timestamp};}wa[ya]=x({},xa[ya]._localIdsMap);}ua.messaging=ua.messaging||{};ua.messaging.local_message_ids=wa;ua.messaging.messages=va;});function ja(ta,ua,va){ua.forEach(function(wa){var xa=ia(ta,wa);xa.setReachedEndOfArray();ta._threadInformer.reorderedMessages(wa,va);});}function ka(ta){this._fbid=ta;this._serverRequests=u.getForFBID(this._fbid);this._threadInformer=v.getForFBID(this._fbid);this._threads=w.getForFBID(this._fbid);this._failedHistoryFetchThreads={};this._threadsToMessages={};this._titanMessagesCount={};this._localTitanMessagesCount={};this._messages={};this._attachmentData={};this._messagesNeedingAttachmentData={};this._localIdsMap={};this._serverRequests.subscribe('update-messages',function(ua,va){var wa=(va.actions||[]).filter(function(ya){var za=ya.action_type;return (ya.is_forward||ya.thread_id)&&(za==i.MercuryActionType.LOG_MESSAGE||za==i.MercuryActionType.USER_GENERATED_MESSAGE||za==i.MercuryActionType.SEND_MESSAGE||za==i.MercuryActionType.CLEAR_CHAT||za==i.MercuryActionType.DELETE_THREAD||za==i.MercuryActionType.DELETE_MESSAGES);}),xa=ga(va.payload_source);if(ha(va.payload_source))wa.forEach(function(ya){if(!ya.is_forward){var za=this._threads.getThreadMetaNow(ya.thread_id);if(za)ya.is_cleared=ya.timestamp<za.chat_clear_time;}}.bind(this));this.handleUpdates(wa,xa,va.payload_source,va.from_client);if(va.end_of_history)ja(this,va.end_of_history,va.payload_source);}.bind(this));}x(ka.prototype,{getMessagesFromIDs:function(ta){return (ta||[]).map(ca.curry(this)).filter(function(ua){return ua;});},hasLoadedNMessages:function(ta,ua){var va=ia(this,ta);return va.hasReachedEndOfArray()||va.getCurrentArraySize()>=ua;},hasLoadedExactlyNMessages:function(ta,ua){var va=ia(this,ta);return va.getCurrentArraySize()==ua;},getThreadMessagesRange:function(ta,ua,va,wa,xa,ya){var za=ia(this,ta),ab=function(gb){wa(la(this,gb));}.bind(this),bb=za.executeOrEnqueue(ua,va,ab),cb=za.getUnavailableResources(bb),db=this._failedHistoryFetchThreads[ta];if(cb.length&&!db){var eb=(this._titanMessagesCount[ta]||0)-(this._localTitanMessagesCount[ta]||0),fb=cb.length+(this._localTitanMessagesCount[ta]||0);this._serverRequests.fetchThreadMessages(ta,eb,fb,xa,ya);}else this._failedHistoryFetchThreads[ta]=false;return bb;},getThreadMessagesSinceTimestamp:function(ta,ua){var va=ia(this,ta),wa=va.getElementsUntil(ua);return la(this,wa);},hasLoadedAllMessages:function(ta){return ia(this,ta).hasReachedEndOfArray();},getCurrentlyLoadedMessages:function(ta){var ua=ia(this,ta).getAllResources();return la(this,ua);},unsubscribe:function(ta,ua){m.isThreadID(ua);var va=ia(this,ua);va.unsubscribe(ta);},addAttachmentData:function(ta,ua,va){var wa=ca(this,ta);if(wa){var xa=wa.attachments.indexOf(ua);if(xa!=-1){wa.attachments[xa]=va;this._threadInformer.updatedMessage(wa.thread_id,wa.message_id,'attach');}}else{if(!this._attachmentData[ta])this._attachmentData[ta]=[];this._attachmentData[ta].push({attach_key:ua,data:va});}},handleUpdates:function(ta,ua,va,wa){var xa,ya={},za={},ab=i.MercuryActionStatus;for(var bb=0;bb<ta.length;bb++){var cb=ta[bb];if(cb.is_forward||va==i.MercuryPayloadSource.SERVER_SEARCH){if(!this._messages[cb.message_id]){this._messages[cb.message_id]=cb;qa(this,cb);}continue;}var db=cb.action_type;if(db==i.MercuryActionType.SEND_MESSAGE){var eb=cb.client_message_id;if(eb&&this._localIdsMap[eb]&&cb.status){if(cb.status==ab.UNCONFIRMED){if(!za[cb.thread_id])za[cb.thread_id]=[];za[cb.thread_id].push(cb.client_message_id);}else if(!ya[cb.thread_id])ya[cb.thread_id]=[];var fb=ca(this,cb.client_message_id),gb=fb.status;fb.status=cb.status;if(cb.status===ab.SUCCESS||cb.error_data)fb.error_data=cb.error_data;if(cb.status==ab.SUCCESS){this.updateLocalMessage(cb,va);if(cb.client_thread_id==ba.PENDING_THREAD_ID){fb.thread_id=cb.thread_id;ya[cb.thread_id].push(fb.message_id);da.setResource(fb.message_id,fb.thread_id);}}if(typeof gb!='undefined'||cb.status==ab.FAILED_UNKNOWN_REASON||cb.status==ab.UNABLE_TO_CONFIRM||cb.status==ab.SUCCESS||cb.status==ab.ERROR)this._threadInformer.updatedMessage(cb.thread_id,ca(this,cb.client_message_id).message_id,va);}continue;}else if(db==i.MercuryActionType.DELETE_THREAD){ia(this,cb.thread_id).removeAllResources();continue;}else if(db==i.MercuryActionType.DELETE_MESSAGES){var hb=cb.message_ids.map(function(ob){return ca(this,ob).message_id;}.bind(this));xa=ia(this,cb.thread_id);xa.removeResources(hb);this._threadInformer.reorderedMessages(cb.thread_id,va);continue;}else if(db==i.MercuryActionType.LOG_MESSAGE){if(cb.log_message_type==i.MercuryLogMessageType.SERVER_ERROR)this._failedHistoryFetchThreads[cb.thread_id]=true;}else if(db==i.MercuryActionType.CLEAR_CHAT){var ib=ia(this,cb.thread_id).getAllResources();ib.map(ca.curry(this)).forEach(function(ob){ob.is_cleared=true;});continue;}var jb=ca(this,cb.message_id);if((cb.threading_id&&this._localIdsMap[cb.threading_id])||(jb&&!jb.is_forward))continue;if(!ya[cb.thread_id])ya[cb.thread_id]=[];ya[cb.thread_id].push(cb.message_id);this._messages[cb.message_id]=cb;qa(this,cb);if(cb.threading_id&&cb.threading_id!=cb.message_id)q.addServerID(cb.threading_id,cb.message_id);if(!ua)this._threadInformer.receivedMessage(cb);}for(var kb in ya){xa=ia(this,kb);var lb=xa.getAllResources(),mb=lb.filter(function(ob){var pb=this._messages[ob];return pb.action_type==i.MercuryActionType.LOG_MESSAGE&&pb.log_message_type==i.MercuryLogMessageType.SERVER_ERROR;}.bind(this));xa.removeResources(mb);ma(this,kb,ya[kb]);if(wa)na(this,kb,ya[kb]);if(ua){xa.addResources(ya[kb]);this._threadInformer.reorderedMessages(kb,va);}else xa.addResourcesWithoutSorting(ya[kb].reverse(),0);this._threadInformer.updatedThread(kb);}var nb=Object.keys(za);if(nb.length)this._serverRequests.requestMessageConfirmation(za);},sendMessage:function(ta,ua,va){ua=ua||Function.prototype;ea(this,ta);this._localIdsMap[ta.message_id]=ta.message_id;if(ta.thread_id=='root:'+ta.message_id)ia(this,ta.thread_id).setReachedEndOfArray();this._serverRequests.sendNewMessage(ta,va);if(ta.thread_id==ba.PENDING_THREAD_ID){this._messages[ta.message_id]=ta;return da.executeOrEnqueue(ta.message_id,ua);}else ua(ta.thread_id);},isFirstMessage:function(ta){var ua=ia(this,ta.thread_id);if(ua.getCurrentArraySize()===0)return false;var va=ua.getResourceAtIndex(ua.getCurrentArraySize()-1),wa=ca(this,va).message_id,xa=ca(this,ta.message_id).message_id;return ua.hasReachedEndOfArray()&&wa==xa;},unsubscribeSend:function(ta){da.unsubscribe(ta);},resendMessage:function(ta,ua){var va=x({},ta);va.status=i.MercuryActionStatus.RESENDING;va.timestamp=Date.now();va.message_id=ta.message_id;this._messages[ta.message_id]=va;var wa=ia(this,ta.thread_id);wa.resortResources([ta.message_id]);this.sendMessage(va,null,ua);this._threadInformer.reorderedMessages(ta.thread_id,i.MercuryPayloadSource.CLIENT_SEND_MESSAGE);},deleteMessages:function(ta,ua){if(ua.length){var va=ia(this,ta),wa=va.getCurrentArraySize()==ua.length&&va.hasReachedEndOfArray();this._serverRequests.deleteMessages(ta,ua,wa);}},markMessagesSpam:function(ta,ua){if(ua.length){var va=ia(this,ta),wa=va.getCurrentArraySize()==ua.length&&va.hasReachedEndOfArray();if(wa){this._serverRequests.markThreadSpam(ta);}else this._serverRequests.markMessagesSpam(ta,ua);}},updateLocalMessage:function(ta,ua){var va=ta.message_id,wa=ta.client_message_id;this._localIdsMap[wa]=va;this._messages[va]=this._messages[wa];q.addServerID(wa,va);this._messages[wa]={};var xa=ca(this,wa);if(ta.timestamp)xa.timestamp=ta.timestamp;if(ta.attachments&&ta.attachments.length){xa.raw_attachments=null;xa.attachments=ta.attachments;qa(this,xa,va);}if(ta.log_message_data)xa.log_message_data=ta.log_message_data;if(oa(xa))this._localTitanMessagesCount[xa.thread_id]--;},constructUserGeneratedMessageObject:function(ta,ua,va,wa){var xa=fa(this,i.MercuryActionType.USER_GENERATED_MESSAGE,ua,va);xa.body=ta;xa.has_attachment=false;xa.html_body=false;xa.attachments=[];xa.specific_to_list=wa||[];return xa;},constructLogMessageObject:function(ta,ua,va,wa){var xa=fa(this,i.MercuryActionType.LOG_MESSAGE,ta,ua);xa.log_message_type=va;xa.log_message_data=wa;return xa;},generateNewClientMessageID:function(ta){var ua=ta+':'+(z(0,4294967295)+1)+'-'+s.getSessionID();return '<'+ua+'@mail.projektitan.com>';}});x(ka,p,{addAttachmentData:function(ta,ua,va,wa){wa=wa||j.user;ka.getForFBID(wa).addAttachmentData(ta,ua,va);}});function la(ta,ua){var va=ua.map(ca.curry(ta));return va.reverse();}function ma(ta,ua,va){var wa=va.filter(function(xa){return oa(ca(ta,xa));});if(!ta._titanMessagesCount[ua])ta._titanMessagesCount[ua]=0;ta._titanMessagesCount[ua]+=wa.length;}function na(ta,ua,va){var wa=va.filter(function(xa){return oa(ca(ta,xa));});if(!ta._localTitanMessagesCount[ua])ta._localTitanMessagesCount[ua]=0;ta._localTitanMessagesCount[ua]+=wa.length;}function oa(ta){var ua=ta.action_type;if(ua==i.MercuryActionType.USER_GENERATED_MESSAGE)return true;switch(ta.log_message_type){case i.MercuryLogMessageType.SUBSCRIBE:case i.MercuryLogMessageType.UNSUBSCRIBE:case i.MercuryLogMessageType.SERVER_ERROR:case i.MercuryLogMessageType.LIVE_LISTEN:return false;default:return true;}}function pa(ta){switch(ta){case i.MercurySourceType.CHAT_WEB:case i.MercurySourceType.CHAT_JABBER:case i.MercurySourceType.CHAT_IPHONE:case i.MercurySourceType.CHAT_MEEBO:case i.MercurySourceType.CHAT_ORCA:case i.MercurySourceType.CHAT_TEST:case i.MercurySourceType.CHAT:case i.MercurySourceType.DESKTOP:return true;default:return false;}}function qa(ta,ua,va){va=va||ua.message_id;var wa=ta._attachmentData[va];if(wa){wa.forEach(function(xa){var ya=ua.attachments.indexOf(xa.attach_key);if(ya!==-1)ua.attachments[ya]=xa.data;});delete ta._attachmentData[va];}else if(!ua.is_forward&&ra(ta,ua)){ta._messagesNeedingAttachmentData[va]=true;sa(ta);}}function ra(ta,ua){if(!ua||!ua.attachments)return false;for(var va=0;va<ua.attachments.length;va++){var wa=ua.attachments[va];if(typeof wa==='string'&&wa.indexOf(i.MercuryAttachmentType.SHARE)===0)return true;}var xa=ua.forward_message_ids||[];for(va=0;va<xa.length;va++){var ya=ca(ta,xa[va]);if(ra(ta,ya))return true;}return false;}var sa=y(function(ta){var ua={};for(var va in ta._messagesNeedingAttachmentData){var wa=ca(ta,va);if(ra(ta,wa))ua[va]=true;}var xa=Object.keys(ua);if(xa.length)new h('/ajax/mercury/attachments/fetch_shares.php').setData({message_ids:xa}).setAllowCrossPageTransition(true).send();ta._messagesNeedingAttachmentData={};},0,this,true);e.exports=ka;});
__d("MercuryRoger",["ArbiterMixin","MercuryConstants","MercuryServerRequests","copyProperties"],function(a,b,c,d,e,f){var g=b('ArbiterMixin'),h=b('MercuryConstants'),i=b('MercuryServerRequests').get(),j=b('copyProperties'),k={},l={getSeenBy:function(m,n){if(!m)return [];var o=[],p=k[m.thread_id],q=h.MercuryActionStatus.SUCCESS;for(var r in p)if(p[r]>m.timestamp&&(m.status===undefined||m.status===q)&&(!n||r!=m.author))o.push(r);return o;},getSeenTimestamp:function(m,n){var o=k[m];return o?o[n]:null;}};j(l,g);i.subscribe('update-roger',function(m,n){for(var o in n){if(!k[o])k[o]={};for(var p in n[o]){var q=k[o][p],r=n[o][p];if(!q||r>q)k[o][p]=r;}}if(n)l.inform('state-changed',n);});e.exports=l;});
__d("MercuryDelayedRoger",["ArbiterMixin","LiveTimer","MercuryConfig","MercuryConstants","MercuryMessages","MercuryRoger","MercuryThreadInformer","MercuryThreads","copyProperties","setTimeoutAcrossTransitions"],function(a,b,c,d,e,f){var g=b('ArbiterMixin'),h=b('LiveTimer'),i=b('MercuryConfig'),j=b('MercuryConstants'),k=b('MercuryMessages').get(),l=b('MercuryRoger'),m=b('MercuryThreadInformer').get(),n=b('MercuryThreads').get(),o=b('copyProperties'),p=b('setTimeoutAcrossTransitions'),q={},r={},s=i['roger.seen_delay'],t=o({getSeenBy:function(x,y){if(r[x])return [];if(!q[x]){var z=n.getThreadMetaNow(x);if(z)q[x]={thread_id:x,author:z.participants[0],timestamp:z.timestamp};}return l.getSeenBy(q[x],y);}},g);function u(x){var y=false;k.getThreadMessagesRange(x,0,1,function(z){var aa=z[0];if(!aa)return;var ba=aa.timestamp,ca=j.MercuryActionStatus.SUCCESS;if(aa.action_id||aa.status==ca)ba-=h.getServerTimeOffset();var da=t.getSeenBy(x);if(r[x]){clearTimeout(r[x]);delete r[x];}var ea=ba+s,fa=ea-Date.now();if(fa>0)r[x]=p(function(){delete r[x];v(x);},fa);q[x]=aa;var ga=t.getSeenBy(x);if(da.length||ga.length)y=true;});return y;}function v(x){var y={};y[x]=true;t.inform('state-changed',y);}function w(event,x){var y={};for(var z in x)if(u(z))y[z]=true;for(var aa in y){t.inform('state-changed',y);break;}}l.subscribe('state-changed',function(x,y){for(var z in y)!r[z]&&v(z);});m.subscribe('messages-received',w);m.subscribe('messages-reordered',w);m.subscribe('messages-updated',w);e.exports=t;});
__d("MercuryFilters",["array-extensions","MercuryConstants"],function(a,b,c,d,e,f){b('array-extensions');var g=b('MercuryConstants'),h=[g.MessagingTag.UNREAD],i={ALL:'all',getSupportedFilters:function(){return h.concat();},isSupportedFilter:function(j){return h.contains(j);}};e.exports=i;});
__d("MercuryOrderedThreadlist",["MercuryConstants","copyProperties","JSLogger","MercuryFilters","MercuryFolders","MercurySingletonMixin","RangedCallbackManager","MercuryServerRequests","MercuryThreadInformer","MercuryThreads"],function(a,b,c,d,e,f){var g=b('MercuryConstants'),h=b('copyProperties'),i=b('JSLogger'),j=b('MercuryFilters'),k=b('MercuryFolders'),l=b('MercurySingletonMixin'),m=b('RangedCallbackManager'),n=b('MercuryServerRequests'),o=b('MercuryThreadInformer'),p=b('MercuryThreads'),q=i.create('ordered_threadlist_model'),r=j.getSupportedFilters().concat([j.ALL]),s=k.getSupportedFolders();function t(da,ea,fa,ga){var ha=[],ia=false,ja=false,ka=(ea||[]).filter(function(ra){var sa=ra.filter||j.ALL;return (ra.folder==fa||(!ra.folder&&fa==g.MessagingTag.INBOX))&&sa==ga;}),la=da._threadlistOrderMap[fa][ga].getAllResources(),ma;ka.forEach(function(ra){ha=ha.concat(ra.thread_ids);if(ra.error){if(ra.end>la.length)ja=ra.error;}else{var sa=ra.end-ra.start;if(ra.thread_ids.length<sa)ia=true;}if(!ma||ra.end>ma)ma=ra.end;});x(da,ha,fa,ga);if(ia){da._threadlistOrderMap[fa][ga].setReachedEndOfArray();}else if(ja){da._threadlistOrderMap[fa][ga].setError(ja);}else{var na=da._threadlistOrderMap[fa][ga].getCurrentArraySize();if(ma&&na<ma){var oa={},pa=la.concat(ha),qa=pa.filter(function(ra){var sa=oa[ra];oa[ra]=true;return sa;});if(qa.length){q.warn('duplicate_threads',{folder:fa,expected_final_size:ma,actual_final_size:na,duplicate_thread_ids:qa});da._serverRequests.fetchThreadlistInfo(ma,qa.length,fa,ga==j.ALL?null:ga);}}}}function u(da,ea){s.forEach(function(fa){r.forEach(function(ga){t(da,ea,fa,ga);});});}function v(da,ea){var fa={};s.forEach(function(ga){fa[ga]={};r.forEach(function(ha){fa[ga][ha]={to_add:[],to_remove:[],to_remove_if_last_after_add:{}};});});ea.forEach(function(ga){if(ga.is_forward)return;var ha=ga.thread_id,ia=y(da,ha),ja=z(da,ha);function ka(){ja.forEach(function(ma){fa[ia][ma].to_add.push(ha);if(!da._threadlistOrderMap[ia][ma].hasReachedEndOfArray()&&!da._threadlistOrderMap[ia][ma].hasResource(ha))fa[ia][ma].to_remove_if_last_after_add[ha]=true;});}function la(ma){if(r.contains(ma))if(ja.contains(ma)){fa[ia][ma].to_add.push(ha);}else fa[ia][ma].to_remove.push(ha);}if(!ia){if(ga.action_type===g.MercuryActionType.CHANGE_FOLDER||ga.action_type===g.MercuryActionType.CHANGE_ARCHIVED_STATUS)s.forEach(function(ma){if(ma!==ia)r.forEach(function(na){da._threadlistOrderMap[ma][na].removeResources([ha]);});});return;}switch(ga.action_type){case g.MercuryActionType.DELETE_THREAD:ja.forEach(function(ma){fa[ia][ma].to_remove.push(ha);});break;case g.MercuryActionType.CHANGE_ARCHIVED_STATUS:case g.MercuryActionType.CHANGE_FOLDER:ka();break;case g.MercuryActionType.CHANGE_READ_STATUS:la(g.MessagingTag.UNREAD);break;case g.MercuryActionType.USER_GENERATED_MESSAGE:case g.MercuryActionType.LOG_MESSAGE:ja.forEach(function(ma){if(aa(da,ha,ia,ma))fa[ia][ma].to_add.push(ha);});break;}});s.forEach(function(ga){r.forEach(function(ha){var ia=da._threadlistOrderMap[ga][ha];x(da,fa[ga][ha].to_add,ga,ha);for(var ja=ia.getCurrentArraySize()-1;ja>=0;ja--){var ka=ia.getResourceAtIndex(ja);if(!fa[ga][ha].to_remove_if_last_after_add[ka])break;fa[ga][ha].to_remove.push(ka);}ia.removeResources(fa[ga][ha].to_remove);});});}function w(da,ea){var fa={};s.forEach(function(ga){fa[ga]={};r.forEach(function(ha){fa[ga][ha]=[];});});ea.forEach(function(ga){var ha=y(da,ga.thread_id),ia=z(da,ga.thread_id);if(ha)ia.forEach(function(ja){if(aa(da,ga.thread_id,ha,ja))fa[ha][ja].push(ga.thread_id);});});s.forEach(function(ga){r.forEach(function(ha){if(fa[ga][ha].length>0)x(da,fa[ga][ha],ga,ha);});});}function x(da,ea,fa,ga){ga=ga||j.ALL;da._threadlistOrderMap[fa][ga].addResources(ea);s.forEach(function(ha){if(ha!=fa)da._threadlistOrderMap[ha][ga].removeResources(ea);});}function y(da,ea){var fa=da._threads.getThreadMetaNow(ea),ga=null;if(!fa){ga='No thread metadata';}else if(!fa.folder)ga='No thread folder';if(ga){var ha={error:ga,tid:ea};q.warn('no_thread_folder',ha);return null;}var ia=fa.folder;if(fa.is_archived)ia=g.MessagingTag.ACTION_ARCHIVED;if(da._threadlistOrderMap[ia]){return ia;}else return null;}function z(da,ea){var fa=da._threads.getThreadMetaNow(ea),ga=[j.ALL];if(!fa){var ha={error:'no_thread_metadata',tid:ea};q.warn('no_thread_metadata',ha);return [];}if(fa.unread_count)ga.push(g.MessagingTag.UNREAD);return ga;}function aa(da,ea,fa,ga){var ha=da._threads.getThreadMetaNow(ea);return ha&&ha.timestamp&&y(da,ea)==fa&&z(da,ea).contains(ga);}function ba(da){this._fbid=da;this._serverRequests=n.getForFBID(this._fbid);this._threadInformer=o.getForFBID(this._fbid);this._threads=p.getForFBID(this._fbid);this._threadlistOrderMap={};s.forEach(function(ea){this._threadlistOrderMap[ea]={};r.forEach(function(fa){this._threadlistOrderMap[ea][fa]=new m(function(ga){return this._threads.getThreadMetaNow(ga).timestamp;}.bind(this),function(ga,ha){return ha-ga;},this._serverRequests.canLinkExternally.bind(this._serverRequests));}.bind(this));}.bind(this));this._serverRequests.subscribe('update-threadlist',function(ea,fa){if(!ca(fa))return;var ga=fa.ordered_threadlists;if(ga&&ga.length){u(this,ga);}else{var ha=(fa.actions||[]).filter(function(ia){return ia.thread_id;});w(this,fa.threads||[]);v(this,ha);}this._threadInformer.updatedThreadlist();}.bind(this));}h(ba.prototype,{getThreadlist:function(da,ea,fa,ga,ha,ia){return this.getFilteredThreadlist(da,ea,fa,j.ALL,ga,ha,ia);},getFilteredThreadlist:function(da,ea,fa,ga,ha,ia,ja){var ka=this._threadlistOrderMap[fa][ga],la=ka.executeOrEnqueue(da,ea,ha,ia),ma=ka.getUnavailableResources(la),na=ka.getError(da,ea,ia);if(ma.length||na){if(ka.getCurrentArraySize()<da){var oa={start:da,limit:ea,filter:ga,resources_size:ka.getCurrentArraySize()};q.warn('range_with_gap',oa);}ka.setError(false);this._serverRequests.fetchThreadlistInfo(ka.getCurrentArraySize(),ma.length,fa,ga==j.ALL?null:ga,ja);}return la;},getThreadlistUntilTimestamp:function(da,ea,fa){fa=fa||j.ALL;return this._threadlistOrderMap[ea][fa].getElementsUntil(da);},unsubscribe:function(da,ea,fa){fa=fa||j.ALL;this._threadlistOrderMap[ea][fa].unsubscribe(da);}});h(ba,l);function ca(da){switch(da.payload_source){case g.MercuryPayloadSource.CLIENT_CHANGE_ARCHIVED_STATUS:case g.MercuryPayloadSource.CLIENT_CHANGE_READ_STATUS:case g.MercuryPayloadSource.CLIENT_CHANGE_FOLDER:case g.MercuryPayloadSource.CLIENT_CHANNEL_MESSAGE:case g.MercuryPayloadSource.CLIENT_DELETE_MESSAGES:case g.MercuryPayloadSource.CLIENT_DELETE_THREAD:case g.MercuryPayloadSource.CLIENT_SEND_MESSAGE:case g.MercuryPayloadSource.SERVER_SEND_MESSAGE:case g.MercuryPayloadSource.SERVER_CONFIRM_MESSAGES:case g.MercuryPayloadSource.SERVER_FETCH_THREADLIST_INFO:case g.MercuryPayloadSource.SERVER_THREAD_SYNC:return true;case g.MercuryPayloadSource.SERVER_INITIAL_DATA:return da.ordered_threadlists;default:return false;}}e.exports=ba;});
__d("MercuryUnseenState",["Arbiter","MercuryConstants","TimestampConverter","JSLogger","KeyedCallbackManager","MercurySingletonMixin","MercuryServerRequests","MercuryThreadInformer","copyProperties","createObjectFrom"],function(a,b,c,d,e,f){var g=b('Arbiter'),h=b('MercuryConstants'),i=b('TimestampConverter'),j=b('JSLogger'),k=b('KeyedCallbackManager'),l=b('MercurySingletonMixin'),m=b('MercuryServerRequests'),n=b('MercuryThreadInformer'),o=b('copyProperties'),p=b('createObjectFrom'),q=h.MercuryThreadlistConstants.MAX_UNSEEN_COUNT,r='unseen_thread_hash',s='unseen_thread_list',t=j.create('mercury_unseen_state');function u(ha){this._fbid=ha;this._serverRequests=m.getForFBID(this._fbid);this._threadInformer=n.getForFBID(this._fbid);this._initialUnseenCount=0;this._lastSeenTimestamp=0;this._maxCount=false;this._unseenResources=new k();this._serverRequests.subscribe('update-unseen',function(ia,ja){z(this,ja);}.bind(this));this._serverRequests.subscribe('update-thread-ids',function(ia,ja){fa(this,ja);}.bind(this));}o(u.prototype,{getUnseenCount:function(){if(this.exceedsMaxCount()){t.error('unguarded_unseen_count_fetch',{});return 0;}return y(this);},exceedsMaxCount:function(){return this._maxCount||(y(this)>q);},markAsSeen:function(){if(y(this)>0||this._maxCount){this._serverRequests.markSeen();aa(this,i.convertActionIDToTimestamp(this._serverRequests.getLastActionID()),[]);}},markThreadSeen:function(ha,ia){var ja={};ja[ha]=null;ca(this,ja,ia);}});o(u,l);function v(ha,ia){ha._unseenResources.setResource(r,ia);ha._unseenResources.setResource(s,Object.keys(ia));}function w(ha,ia){var ja=ha._unseenResources.executeOrEnqueue(r,ia),ka=ha._unseenResources.getUnavailableResources(ja);if(ka.length)ha._serverRequests.fetchUnseenThreadIDs();}function x(ha){return ha._unseenResources.getResource(r);}function y(ha){var ia=ha._unseenResources.getResource(s);if(ia){return ia.length;}else return ha._initialUnseenCount;}function z(ha,ia){var ja=ga(ia);if(ia.unseen_thread_ids){ia.unseen_thread_ids.forEach(function(ua){if(ua.folder!=h.MessagingTag.INBOX)return;var va=ea(ha,ua.thread_ids),wa=ha._lastSeenTimestamp;if(ja&&ja.seen_timestamp)wa=ja.seen_timestamp;aa(ha,wa,va);if(ja&&ja.unseen_count>q)ha._maxCount=true;});}else if(ja&&ja.seen_timestamp){ha._lastSeenTimestamp=ja.seen_timestamp;if(ja.unseen_count>q){ha._maxCount=true;v(ha,{});}else{ha._initialUnseenCount=ja.unseen_count;if(ha._initialUnseenCount===0)v(ha,{});}}else{if(ha._maxCount)return;var ka=ia.actions;if(!ka||!(ka.length))return;var la={},ma={};for(var na=0;na<ka.length;na++){var oa=ka[na];if(oa.is_forward)continue;var pa=oa.action_type,qa=oa.action_id,ra=oa.thread_id?oa.thread_id:oa.server_thread_id,sa=oa.folder===undefined||oa.folder==h.MessagingTag.INBOX;if(!sa)continue;if(pa==h.MercuryActionType.USER_GENERATED_MESSAGE||pa==h.MercuryActionType.LOG_MESSAGE){var ta=i.isGreaterThan(qa,la[ra]);if(oa.is_unread&&(!la[ra]||ta))la[ra]=qa;}else if(pa==h.MercuryActionType.CHANGE_READ_STATUS&&oa.mark_as_read)ma[ra]=qa;}ba(ha,la);ca(ha,ma);}}function aa(ha,ia,ja){var ka=x(ha);if(ka===undefined||ia>ha._lastSeenTimestamp||ha._maxCount){ha._lastSeenTimestamp=ia;ja=ja||[];if(ja.length<=q)ha._maxCount=false;var la={},ma=x(ha)||{};for(var na in ma)if(ma[na]!==true){var oa=ma[na];if(da(ha,oa))la[na]=oa;}var pa=o(p(ja,true),la);v(ha,pa);ha._threadInformer.updatedUnseenState();}}function ba(ha,ia){if(ha._maxCount)return;var ja={},ka=false;for(var la in ia){var ma=ia[la];if(da(ha,ma)){ja[la]=ma;ka=true;}}if(!ka)return;w(ha,function(na){for(var oa in ja){var pa=ja[oa];if(!na[oa]&&da(ha,pa))na[oa]=ja[oa];}v(ha,na);ha._threadInformer.updatedUnseenState();});}function ca(ha,ia,ja){var ka=false;for(var la in ia){ka=true;break;}if(ka)w(ha,function(ma){var na=false;for(var oa in ia){var pa=ia[oa],qa=i.isGreaterThan(pa,ma[oa]);if(ma[oa]&&(!pa||qa)){delete ma[oa];na=true;}}if(na){v(ha,ma);ha._threadInformer.updatedUnseenState();if(ja&&y(ha)===0)ha._serverRequests.markSeen();}});}function da(ha,ia){var ja=i.convertActionIDToTimestamp(ia);return ja>ha._lastSeenTimestamp;}function ea(ha,ia){return ia.map(ha._serverRequests.convertThreadIDIfAvailable.bind(ha._serverRequests));}function fa(ha,ia){var ja=x(ha);if(!ja)return;for(var ka in ia){var la=ia[ka];if(ja[ka]){ja[la]=ja[ka];delete ja[ka];}}v(ha,ja);}function ga(ha){var ia=(ha.message_counts||[]);for(var ja=0;ja<ia.length;ja++)if(ia[ja].folder==h.MessagingTag.INBOX)return ia[ja];return null;}g.subscribe(j.DUMP_EVENT,function(ha,ia){ia.messaging=ia.messaging||{};ia.messaging.unseen={};ia.messaging.unseen_max_count={};ia.messaging.unseen_time={};var ja=u._getInstances();for(var ka in ja){ia.messaging.unseen[ka]=o({},x(ja[ka]));ia.messaging.unseen_max_count[ka]=ja[ka]._maxCount;ia.messaging.unseen_time[ka]=ja[ka]._lastSeenTimestamp;}});e.exports=u;});
__d("MercuryThreadMetadataRawRenderer",["Event","MercuryConfig","MercuryConstants","CSS","DOM","MercuryErrorInfo","MercuryStatusTemplates","Tooltip","URI","WebMessengerPermalinkConstants","tx"],function(a,b,c,d,e,f){var g=b('Event'),h=b('MercuryConfig'),i=b('MercuryConstants'),j=b('CSS'),k=b('DOM'),l=b('MercuryErrorInfo'),m=b('MercuryStatusTemplates'),n=b('Tooltip'),o=b('URI'),p=b('WebMessengerPermalinkConstants'),q=b('tx'),r={renderParticipantListWithNoThreadName:function(t,u,v,w,x,y){var z={callback:true,check_length:true,show_unread_count:true};y=y||{};var aa={};for(var ba in y)if(z[ba]){aa[ba]=y[ba];delete y[ba];}var ca=v.map(function(ha){return w[ha];}),da=this.renderRawParticipantList(t,ca,v.length,y);da=this.renderRawTitleWithUnreadCount(da,aa.show_unread_count?u.unread_count:0);var ea=y.abbr_mode,fa={};for(var ga in y)fa[ga]=y[ga];fa.abbr_mode=true;x.forEach(function(ha){var ia=x.length>1?this._cloneIfDOMElement(da):da;k.setContent(ha,ia);if(aa.check_length&&!ea&&ha.scrollWidth>ha.clientWidth){var ja=this.renderRawParticipantList(t,ca,v.length,fa),ka=this.renderRawTitleWithUnreadCount(ja,aa.show_unread_count?u.unread_count:0);k.setContent(ha,ka);}}.bind(this));aa.callback&&aa.callback(da);},renderRawParticipantList:function(t,u,v,w){var x={abbr_mode:true,last_separator_uses_and:true,names_renderer:true};w=w||{};var y=null;if(w.names_renderer){y=w.names_renderer(u);}else y=u.map(function(ba){return ba.name;});var z=null;if(y.length===0){z="No Participants";}else if(y.length==1){z=y[0];}else if(y.length==2){var aa={participant1:y[0],participant2:y[1]};if(w.last_separator_uses_and){z=q._("{participant1} and {participant2}",aa);}else z=q._("{participant1}, {participant2}",aa);}else if(w.last_separator_uses_and){if(w.abbr_mode){z=q._("{participant1} and {others_link}",{participant1:y[0],others_link:this.renderRawParticipantCount(t,{render_subset:true,count:v-1})});}else if(y.length==3){z=q._("{participant1}, {participant2} and {participant3}",{participant1:y[0],participant2:y[1],participant3:y[2]});}else z=q._("{participant1}, {participant2} and {others_link}",{participant1:y[0],participant2:y[1],others_link:this.renderRawParticipantCount(t,{render_subset:true,count:v-2})});}else if(y.length==3){z=q._("{participant1}, {participant2}, {participant3}",{participant1:y[0],participant2:y[1],participant3:y[2]});}else z=q._("{participant1}, {participant2}, {participant3}, {others_link}",{participant1:y[0],participant2:y[1],participant3:y[2],others_link:this.renderRawParticipantCount(t,{render_subset:true,count:v-3})});if(Array.isArray(z))z=k.create('span',{},z);return z;},renderRawTitleWithUnreadCount:function(t,u){var v=t;if(u&&u>1)v=k.create('span',{},q._("{conversation_title} ({unread_count})",{conversation_title:t,unread_count:u}));return v;},renderRawParticipantCount:function(t,u){var v=u.render_subset,w;if(!v){w=u.count>1?q._("{num} people",{num:u.count}):"1 person";}else w=u.count>1?q._("{others_count} others",{others_count:u.count}):"1 other";return w;},renderShortNames:function(t){if(t.length==1)return [t[0].name];return t.map(function(u){return u.short_name;});},getUserCanonicalTitanURL:function(t,u,v){var w=new o().setSubdomain('www'),x=t.substr(t.indexOf(':')+1);w.setPath(s(v)+'/'+x);u&&u(w.toString());return w.toString();},getTitanURLWithServerID:function(t,u,v){var w=new o().setSubdomain('www');if(h.MessagesMercuryIntegrationGK){w.setPath(p.getURIPathForThreadID(t,s(v)));}else{w.setPath('/messages/');w.setQueryData({action:'read',tid:t});}u&&u(w.toString());return w.toString();},renderUserCanonicalTitanLink:function(t,u,v,w){var x=this.getUserCanonicalTitanURL(t,null,w);u.setAttribute('href',x);v&&v();},renderTitanLinkWithServerID:function(t,u,v,w){var x=this.getTitanURLWithServerID(t,null,w);u.setAttribute('href',x);v&&v();},renderStatusIndicator:function(t,u,v){var w=i.MercuryActionStatus,x;if(t==w.RESENDING){x=this.renderResendIndicator();}else if(t!==undefined&&t!=w.UNSENT&&t!=w.UNCONFIRMED&&t!=w.SUCCESS)x=this.renderErrorIndicator(u,v);return x;},renderResendIndicator:function(){return m[':fb:mercury:resend-indicator'].render();},renderErrorIndicator:function(t,u){if(!t)return null;var v=m[':fb:mercury:error-indicator'].render(),w=t.is_transient,x=l.getMessage(t);if(l.isConnectionError(t)){x=q._("{message} Check your network connection or click to try again.",{message:x});}else if(w)x=q._("{message} Click to send again.",{message:x});n.set(v,x,'above','center');if(u&&w){g.listen(v,'click',u);j.addClass(v,'mercuryClickableErrorIndicator');}return v;},_cloneIfDOMElement:function(t){if(t.cloneNode){return t.cloneNode();}else return t;}};function s(t){var u=p.BASE_PATH;if(t&&t!=i.MessagingTag.INBOX)u+='/'+t;return u;}e.exports=r;});
__d("MercurySeenByAll",["CSS","DataStore","DOM","MercuryParticipants","MercuryDelayedRoger","MercuryThreads"],function(a,b,c,d,e,f){var g=b('CSS'),h=b('DataStore'),i=b('DOM'),j=b('MercuryParticipants'),k=b('MercuryDelayedRoger'),l=b('MercuryThreads').get(),m={},n={updateOnSeenChange:function(p,q){m[p.tagName]=true;h.set(p,'thread-id',q.thread_id);g.addClass(p,'seenByListener');o(p,q);}};function o(p,q){var r=q.participants.filter(function(t){return t!==j.user;}),s=q.participants.length>0&&q.participants[0]===j.user;g.conditionClass(p,'repliedLast',s);g.conditionClass(p,'seenByAll',s&&k.getSeenBy(q.thread_id).length===r.length);}k.subscribe('state-changed',function(p,q){for(var r in m){var s=i.scry(document.body,r+'.seenByListener');for(var t=0;t<s.length;t++){var u=s[t],v=h.get(u,'thread-id');if(q[v])l.getThreadMeta(v,function(w){o(u,w);});}}});e.exports=n;});
__d("MercuryThreadMetadataRenderer",["MercuryConfig","MercuryConstants","CSS","DOM","HTML","MercuryImageTemplates","JSLogger","MercuryAttachment","MercuryEmoji","MercurySingletonMixin","MercuryThreadMetadataRawRenderer","MercuryParticipants","MercurySeenByAll","MercuryServerRequests","MercuryThreadlistIconTemplates","MercuryThreads","Tooltip","URI","createArrayFrom","copyProperties","cx","tx"],function(a,b,c,d,e,f){var g=b('MercuryConfig'),h=b('MercuryConstants'),i=b('CSS'),j=b('DOM'),k=b('HTML'),l=b('MercuryImageTemplates'),m=b('JSLogger'),n=b('MercuryAttachment'),o=b('MercuryEmoji'),p=b('MercurySingletonMixin'),q=b('MercuryThreadMetadataRawRenderer'),r=b('MercuryParticipants'),s=b('MercurySeenByAll'),t=b('MercuryServerRequests'),u=b('MercuryThreadlistIconTemplates'),v=b('MercuryThreads'),w=b('Tooltip'),x=b('URI'),y=b('createArrayFrom'),z=b('copyProperties'),aa=b('cx'),ba=b('tx'),ca=m.create('wm_timestamp');function da(ha){this._fbid=ha;this._serverRequests=t.getForFBID(ha);this._threads=v.getForFBID(ha);}z(da,p);z(da.prototype,{renderTimestamp:function(ha,ia,ja,ka){if(ka){if(!ia){ca.warn('no_title');ia=(new Date(ka)).toLocaleDateString();}ha.setAttribute('title',ia);if(!ja){ca.warn('no_display');ja=Date.format(g['24h_times']?'H:i':'g:ia',Math.floor(ka/1000));}j.setContent(ha,ja);i.show(ha);}},renderMessageSourceTags:function(ha,ia,ja,ka){var la=h.MercuryMessageSourceTags,ma='',na='',oa='';if(ja.contains(la.MESSENGER)){ma="Sent from Messenger";na=new x('/mobile/messenger');oa="_9g";}else if(ja.contains(la.MOBILE)){ma="Sent from Mobile";na=new x('/mobile/');oa="_9j";}else if(ja.contains(la.CHAT)){ma="Sent from chat";oa="_9h";}else if(ja.contains(la.EMAIL)){if(ka){ma=ba._("Sent from {email}",{email:ka});}else ma="Sent from email";oa="_9i";}if(oa){w.set(ha,ma);i.addClass(ia,oa);if(na){ha.setAttribute('href',na);}else ha.removeAttribute('href');}else i.hide(ha);},renderMessageLocation:function(ha,ia,ja){var ka=x('/ajax/messaging/hovercard/map.php').setQueryData(ja);ha.setAttribute('data-hovercard',ka);i.removeClass(ha,"_b9");i.show(ia);},renderSpoofWarning:function(ha,ia,ja){if(ia){i.addClass(ha,"_sa");w.set(ha,ba._("Unable to confirm {name_or_email} as the sender.",{name_or_email:ja.name}));}},renderChatSpoofWarning:function(ha,ia,ja){if(ia)j.appendContent(ha,ba._("Unable to confirm {name_or_email} as the sender.",{name_or_email:ja.name}));},renderCoreThreadlist:function(ha,ia,ja,ka,la){ka=ka||{};this.renderThreadImage(ha,ia.getNode('image'));ga(this,ha,ia.getNode('name'),ka);if(ha.folder&&la)fa(ia.getNode('folderBadge'),ha.folder);var ma=ia.getNode('timestamp');this.renderTimestamp(ma,ha.timestamp_absolute,ha.timestamp_relative,ha.timestamp);this.renderSnippet(ha,ia.getNode('snippet'));ja(ia,ha);},renderAndSeparatedParticipantList:function(ha,ia,ja){ja=ja||{};ja.last_separator_uses_and=true;this._threads.getThreadMeta(ha,function(ka){ga(this,ka,ia,ja);}.bind(this));},renderSnippet:function(ha,ia){var ja=j.create('span');i.addClass(ja,'MercuryRepliedIndicator');j.appendContent(ia,ja);s.updateOnSeenChange(ja,ha);if(ha.snippet_has_attachment)if(!ha.snippet&&ha.snippet_attachments&&ha.snippet_attachments.length){ea(ha,ia);}else j.appendContent(ia,j.create('span',{className:'MercuryAttachmentIndicator'}));if(ha.is_forwarded_snippet){var ka;if(ha.snippet){ka="Forwarded Message:";}else ka="Forwarded Message";j.appendContent(ia,j.create('strong',{className:'mercuryForwardedIndicator'},ka));}var la=ha.snippet;if(la)if(la.substr(0,4)=='?OTR'){la="[encrypted message]";}else la=la.replace(/\r\n|[\r\n]/g," ");var ma=ha.participants.length;if(ha.is_subscribed)ma--;if(ha.snippet_sender&&r.getIDForUser(this._fbid)!=ha.snippet_sender&&ma>1){r.get(ha.snippet_sender,function(na){if(na.short_name)la=ba._("{name}: {conversation_snippet}",{name:na.short_name,conversation_snippet:la});j.appendContent(ia,k(o.htmlEmojiAndEmote(la)));});}else j.appendContent(ia,k(o.htmlEmojiAndEmote(la)));},getTitanURL:function(ha,ia,ja){if(ha.substr(0,ha.indexOf(':'))=='user'){q.getUserCanonicalTitanURL(ha,ia,ja);}else this._serverRequests.getServerThreadID(ha,function(ka){q.getTitanURLWithServerID(ka,ia,ja);});},renderTitanLink:function(ha,ia,ja,ka){if(ha.substr(0,ha.indexOf(':'))=='user'){q.renderUserCanonicalTitanLink(ha,ia,ja,ka);}else this._serverRequests.getServerThreadID(ha,function(la){q.renderTitanLinkWithServerID(la,ia,ja,ka);});},renderThreadImage:function(ha,ia){if(ha.image_src){this._renderThreadImageSingle(ha.image_src,ia);return;}var ja=r.getIDForUser(this._fbid),ka=[],la=ha.participants.filter(function(ma){return ma!=ja;});if(!la.length){ka=[ja];}else if(la.length==1){ka=[la[0]];}else{ka=la.slice(0,3);if(ka.length==2)ka.push(ja);}r.getMulti(ka,function(ma){var na=ka.map(function(oa){return ma[oa];});this.renderParticipantImages(na,ia);}.bind(this));},renderParticipantImages:function(ha,ia){if(ha.length>2){this._renderThreadImageSplit(ha,ia);}else this._renderThreadImageSingle(ha[0].image_src,ia);},renderParticipantList:function(ha,ia,ja,ka){return q.renderRawParticipantList(this._serverRequests.getServerThreadIDNow(ha),ia,ja,ka);},renderThreadNameAndParticipantList:function(ha,ia,ja,ka){var la=q.renderRawParticipantList(this._serverRequests.getServerThreadIDNow(ha),ia,ja,ka),ma=this._threads.getThreadMetaNow(ha);if(!ma.name)return la;return ba._("{conversation_name} [with {participant_list}]",{conversation_name:ma.name,participant_list:la});},renderParticipantCount:function(ha,ia){return q.renderRawParticipantCount(this._serverRequests.getServerThreadIDNow(ha),ia);},_renderThreadImageSingle:function(ha,ia){var ja=l[':fb:mercury:thread-image:single'].build().getRoot();ja.src=ha;j.setContent(ia,ja);},_renderThreadImageSplit:function(ha,ia){var ja=l[':fb:mercury:thread-image:split'].build().setNodeProperty('left','src',ha[0].image_src).setNodeProperty('topRight','src',ha[1].image_src).setNodeProperty('bottomRight','src',ha[2].image_src);j.setContent(ia,ja.getRoot());}});function ea(ha,ia){var ja=ha.snippet_attachments.filter(function(la){return la.attach_type==h.MercuryAttachmentType.PHOTO;});if(ja.length==ha.snippet_attachments.length){var ka=u[':fb:mercury:attachment-icon-text'].build().getRoot();i.addClass(ka,n.getAttachIconClass(ja[0].icon_type));if(ja.length==1){j.appendContent(ka,"Sent 1 photo");}else j.appendContent(ka,ba._("Sent {num_photos} photos",{num_photos:ja.length}));j.appendContent(ia,ka);}else ha.snippet_attachments.filter(function(la){return la.attach_type==h.MercuryAttachmentType.FILE||la.attach_type==h.MercuryAttachmentType.PHOTO;}).forEach(function(la){var ma=u[':fb:mercury:attachment-icon-text'].build().getRoot(),na=n.getAttachIconClass(la.icon_type);if(la.metadata&&la.metadata.type=='fb_voice_message'){j.appendContent(ma,"Voice Message");}else j.appendContent(ma,la.name);i.addClass(ma,na);j.appendContent(ia,ma);});}function fa(ha,ia){y(ha).forEach(function(ja){j.setContent(ja,ia);});}function ga(ha,ia,ja,ka){ja=y(ja);if(ia.name){var la=q.renderRawTitleWithUnreadCount(ia.name,ka.show_unread_count?ia.unread_count:0);ja.forEach(function(na){j.setContent(na,la);});ka.callback&&ka.callback(la);return;}var ma=ia.participants;if(ia.participants.length>1)ma=ia.participants.filter(function(na){return na!=r.getIDForUser(ha._fbid);});r.getMulti(ma,function(na){q.renderParticipantListWithNoThreadName(ha._serverRequests.getServerThreadIDNow(ia.thread_id),ia,ma,na,ja,ka);});}e.exports=da;});
__d("MercuryChatUtils",["Env"],function(a,b,c,d,e,f){var g=b('Env'),h={canOpenChatTab:function(i){var j=i.is_canonical&&!i.is_canonical_user;return i.is_subscribed&&!j&&i.canonical_fbid!=g.user;}};e.exports=h;});
__d("RenderManager",["function-extensions","copyProperties"],function(a,b,c,d,e,f){b('function-extensions');var g=b('copyProperties');function h(i){this._isDirty=false;this._obj=i;}g(h.prototype,{dirty:function(){if(!this._isDirty){this._isDirty=true;this._doPaint.bind(this).defer();}},_doPaint:function(){this._isDirty=false;this._obj.paint();}});e.exports=h;});
__d("CounterDisplay",["Arbiter","CSS","DOM","RenderManager","Run","$","copyProperties"],function(a,b,c,d,e,f){var g=b('Arbiter'),h=b('CSS'),i=b('DOM'),j=b('RenderManager'),k=b('Run'),l=b('$'),m=b('copyProperties');function n(o,p,q,r,s,t){m(this,{_name:o,_valueNode:l(p),_wrapperNode:l(q)||null,_statusClass:s,_rm:new j(this),_arbiterSubscription:null,_count:0});var u=this._valueNode.firstChild;if(u){var v=parseInt(u.nodeValue,10);if(!isNaN(v))this._count=v;}this._statusNode=r?l(r):null;this._subscribeAll();n.instances.push(this);if(!t)k.onLeave(this._destroy.bind(this),true);}m(n,{EVENT_TYPE_ADJUST:'CounterDisplay/adjust',EVENT_TYPE_UPDATE:'CounterDisplay/update',instances:[],adjustCount:function(o,p){g.inform(n.EVENT_TYPE_ADJUST+'/'+o,p);},setCount:function(o,p){g.inform(n.EVENT_TYPE_UPDATE+'/'+o,p);}});m(n.prototype,{_destroy:function(){delete this._valueNode;delete this._wrapperNode;if(this._arbiterSubscription){this._arbiterSubscription.unsubscribe();delete this._arbiterSubscription;}n.instances.remove(this);},adjustCount:function(o){this._count=Math.max(0,this._count+o);this._rm.dirty();return this;},setCount:function(o){this._count=Math.max(0,o);this._rm.dirty();return this;},paint:function(){i.setContent(this._valueNode,this._count);this._toggleNodes();},_toggleNodes:function(){if(this._wrapperNode)h.conditionClass(this._wrapperNode,'hidden_elem',this._count<=0);if(this._statusClass&&this._statusNode)h.conditionClass(this._statusNode,this._statusClass,this._count>0);},_subscribeAll:function(){var o=[n.EVENT_TYPE_ADJUST+'/'+this._name,n.EVENT_TYPE_UPDATE+'/'+this._name];this._arbiterSubscription=g.subscribe(o,this._onInform.bind(this),g.SUBSCRIBE_NEW);},_onInform:function(o,p){p=parseInt(p);if(isNaN(p))return;if(o.indexOf(n.EVENT_TYPE_ADJUST)!=-1){this.adjustCount(p);}else if(o.indexOf(n.EVENT_TYPE_UPDATE)!=-1){this.setCount(p);}else return;return;}});e.exports=n;});
__d("AsyncLayout",["AjaxPipeRequest","Arbiter","AsyncRequest","AsyncResponse","CSS","DOM","HTML","NavigationMessage","PageTransitions","URI","$","copyProperties","emptyFunction","ge","goURI"],function(a,b,c,d,e,f){var g=b('AjaxPipeRequest'),h=b('Arbiter'),i=b('AsyncRequest'),j=b('AsyncResponse'),k=b('CSS'),l=b('DOM'),m=b('HTML'),n=b('NavigationMessage'),o=b('PageTransitions'),p=b('URI'),q=b('$'),r=b('copyProperties'),s=b('emptyFunction'),t=b('ge'),u=b('goURI');function v(w){this.canvasID=w;if(t('rightCol'))this.auxiliaryID='rightCol';if(t('headerArea'))this.headerID='headerArea';if(t('toolbarContainer'))this.toolbarID='toolbarContainer';this.waitingForAux=false;o.registerHandler(this.catchPageTransition.bind(this));this.subscription=h.subscribe(n.NAVIGATION_BEGIN,this.onNavigate.bind(this));}r(v.prototype,{catchPageTransition:function(w){this.subscription.unsubscribe();return false;},getCanvasID:function(w){return w.sidecol?'contentCol':'contentArea';},onNavigate:function(w,x){var y=x.useAjaxPipe;x=x.params;if(x.endpoint){if(this.request){this.request.setFinallyHandler(s);this.request.abort();}if(this.sideRequest)this.sideRequest.abort();if(y){this.request=new g().setURI(x.endpoint).setData(x).setCanvasId(this.getCanvasID(x)).setFinallyHandler(this.finallyHandler.bind(this)).setErrorHandler(this.errorHandler.bind(this)).setFirstResponseCallback(this.firstResponseCallback.bind(this)).send();}else{x.handled=true;this.waitingForAux=x.sidecol;var z=!!x.iframe,aa=new i().setOption('useIframeTransport',z).setURI(new p(x.endpoint)).setReadOnly(true).setMethod('GET').setData(x).setHandler(this.onResponse.bind(this)).setErrorHandler(this.errorHandler.bind(this)).setFinallyHandler(this.finallyHandler.bind(this));this.request=aa;aa.send();}}},onSideResponse:function(w){var x=w.getPayload();if(x&&this.auxiliaryID)this.receivedAux(x);},receivedAux:function(w){!this.waitingForAux;this.waitingForAux=false;l.setContent(q(this.auxiliaryID),m(w));},onResponse:function(w){var x=w.getPayload();if(x.redirect){u(x.redirect);}else{var y=x.html||x;l.setContent(q(this.canvasID),m(y));if(x.side_html&&this.auxiliaryID)this.receivedAux(x.side_html);if(this.headerID&&!x.keep_header){var z=q(this.headerID);l.setContent(z,m(x.header_html||''));k.conditionShow(z,x.header_html);}if(x.toolbar_html&&this.toolbarID)l.setContent(q(this.toolbarID),m(x.toolbar_html));if(x.js)(new Function(x.js))();k.conditionClass('contentCol','hasRightCol',this.auxiliaryID&&!x.noRightSide);var aa=t('rightCol');if(aa&&x.noRightSide)l.empty(aa);}var ba=w.getRequest().getData();h.inform(n.NAVIGATION_COMPLETED,ba.key);},errorHandler:function(w){j.verboseErrorHandler(w);h.inform(n.NAVIGATION_FAILED);this.request=null;},firstResponseCallback:function(w){window.scrollTo(0,0);h.inform(n.NAVIGATION_FIRST_RESPONSE);},finallyHandler:function(w){this.request=null;o.transitionComplete(true);h.inform(n.NAVIGATION_COMPLETED);}});e.exports=v;});
__d("Dcode",[],function(a,b,c,d,e,f){var g,h={},i={_:'%',A:'%2',B:'000',C:'%7d',D:'%7b%22',E:'%2c%22',F:'%22%3a',G:'%2c%22ut%22%3a1',H:'%2c%22bls%22%3a',I:'%2c%22n%22%3a%22%',J:'%22%3a%7b%22i%22%3a0%7d',K:'%2c%22pt%22%3a0%2c%22vis%22%3a',L:'%2c%22ch%22%3a%7b%22h%22%3a%22',M:'%7b%22v%22%3a2%2c%22time%22%3a1',N:'.channel%22%2c%22sub%22%3a%5b',O:'%2c%22sb%22%3a1%2c%22t%22%3a%5b',P:'%2c%22ud%22%3a100%2c%22lc%22%3a0',Q:'%5d%2c%22f%22%3anull%2c%22uct%22%3a',R:'.channel%22%2c%22sub%22%3a%5b1%5d',S:'%22%2c%22m%22%3a0%7d%2c%7b%22i%22%3a',T:'%2c%22blc%22%3a1%2c%22snd%22%3a1%2c%22ct%22%3a',U:'%2c%22blc%22%3a0%2c%22snd%22%3a1%2c%22ct%22%3a',V:'%2c%22blc%22%3a0%2c%22snd%22%3a0%2c%22ct%22%3a',W:'%2c%22s%22%3a0%2c%22blo%22%3a0%7d%2c%22bl%22%3a%7b%22ac%22%3a',X:'%2c%22ri%22%3a0%7d%2c%22state%22%3a%7b%22p%22%3a0%2c%22ut%22%3a1',Y:'%2c%22pt%22%3a0%2c%22vis%22%3a1%2c%22bls%22%3a0%2c%22blc%22%3a0%2c%22snd%22%3a1%2c%22ct%22%3a',Z:'%2c%22sb%22%3a1%2c%22t%22%3a%5b%5d%2c%22f%22%3anull%2c%22uct%22%3a0%2c%22s%22%3a0%2c%22blo%22%3a0%7d%2c%22bl%22%3a%7b%22ac%22%3a'};(function(){var k=[];for(var l in i){h[i[l]]=l;k.push(i[l]);}k.reverse();g=new RegExp(k.join("|"),'g');})();var j={encode:function(k){return encodeURIComponent(k).replace(/([_A-Z])|%../g,function(l,m){return m?'%'+m.charCodeAt(0).toString(16):l;}).toLowerCase().replace(g,function(l){return h[l];});},decode:function(k){return decodeURIComponent(k.replace(/[_A-Z]/g,function(l){return i[l];}));}};e.exports=j;});
__d("DocRPC",["ErrorUtils"],function(a,b,c,d,e,f){var g=b('ErrorUtils'),h={_apis:{},_dispatch:function(i){var j;try{i=JSON.parse(i);}catch(k){throw new Error('DocRPC unparsable dispatch: "'+i+'"');}if(h._apis.hasOwnProperty(i.api)){var l=h._apis[i.api];if(l[i.method])j=g.applyWithGuard(l[i.method],l,i.args);}if(j===undefined)j=null;return JSON.stringify(j);},publish:function(i,j){h._apis[j]=i;},proxy:function(i,j,k){var l={};k.forEach(function(m){l[m]=function(){var n={api:j,method:m,args:Array.prototype.slice.call(arguments)},o;try{if(i.closed)throw new Error('DocRPC window closed');o=i.DocRPC._dispatch(JSON.stringify(n));}catch(p){g.reportError(p);return;}if(typeof(o)=='string')try{o=JSON.parse(o);}catch(p){throw new Error('DocRPC '+j+'.'+m+' unparsable return: "'+o+'"');}return o;};});return l;}};e.exports=a.DocRPC=h;});
__d("SystemEvents",["Arbiter","Env","ErrorUtils","UserAgent","copyProperties"],function(a,b,c,d,e,f){var g=b('Arbiter'),h=b('Env'),i=b('ErrorUtils'),j=b('UserAgent'),k=b('copyProperties'),l=new g(),m=[],n=1000;setInterval(function(){for(var w=0;w<m.length;w++)m[w]();},n,false);function o(){return (/c_user=(\d+)/.test(document.cookie)&&RegExp.$1)||0;}var p=h.user,q=navigator.onLine;function r(){if(!q){q=true;l.inform(l.ONLINE,q);}}function s(){if(q){q=false;l.inform(l.ONLINE,q);}}if(j.ie()){if(j.ie()>=8){window.attachEvent('onload',function(){document.body.ononline=r;document.body.onoffline=s;});}else m.push(function(){(navigator.onLine?r:s)();});}else if(window.addEventListener)if(!j.chrome()){window.addEventListener('online',r,false);window.addEventListener('offline',s,false);}var t=p;m.push(function(){var w=o();if(t!=w){l.inform(l.USER,w);t=w;}});var u=Date.now();function v(){var w=Date.now(),x=w-u,y=x<0||x>10000;u=w;if(y)l.inform(l.TIME_TRAVEL,x);return y;}m.push(v);m.push(function(){if(window.onerror!=i.onerror)window.onerror=i.onerror;});k(l,{USER:'SystemEvents/USER',ONLINE:'SystemEvents/ONLINE',TIME_TRAVEL:'SystemEvents/TIME_TRAVEL',isPageOwner:function(w){return (w||o())==p;},isOnline:function(){return j.chrome()||q;},checkTimeTravel:v});e.exports=l;});
__d("setIntervalAcrossTransitions",[],function(a,b,c,d,e,f){function g(h,i){return setInterval(h,i,false);}e.exports=g;});
__d("MusicButtonStore",[],function(a,b,c,d,e,f){var g={},h={addButton:function(i,j){g[i]=j;return j;},getButton:function(i){return g[i];},getButtons:function(){return g;},removeButton:function(i){g[i]&&g[i].resetLoadingTimers();delete g[i];}};e.exports=h;});
__d("MusicConstants",["URI"],function(a,b,c,d,e,f){var g=b('URI'),h={DEBUG:false,LIVE_LISTEN_MIN_SPOTIFY_VERSION:'spotify-0.6.6.0.g5a9eaca5',enableDebug:function(){this.DEBUG=true;},sameURLs:function(i,j){var k=/\/$/;if(i&&j){i=g(i);j=g(j);return i.getDomain()==j.getDomain()&&i.getPath()==j.getPath();}return false;},greaterOrEqualToMinimumVersion:function(i,j){var k=/(?:\d+\.)+/,l=i.match(k)[0].split('.').slice(0,-1),m=j.match(k)[0].split('.').slice(0,-1);if(l.length!==m.length)return false;for(var n=0;n<m.length;n++)if(+l[n]<+m[n]){return false;}else if(+l[n]>+m[n])return true;return true;},sanitizeForProviders:function(i){var j={};for(var k in i)if(this.ALLOWED_EXTERNAL_CONTEXT_PARAMS[k])j[k]=i[k];return j;},OP:{RESUME:'RESUME',PAUSE:'PAUSE',PLAY:'PLAY',VERSION:'VERSION'},STATUS_CHANGE_OP:{STATUS:'STATUS',LOGIN:'LOGIN',REINFORM:'REINFORM'},STATUS_CHANGE_EVENT:{playing:'PLAY_STATE_CHANGED',track:'TRACK_CHANGED'},DIAGNOSTIC_EVENT:{ALL_PAUSED:'ALL_PAUSED',ALL_OFFLINE:'ALL_OFFLINE',OFFLINE:'OFFLINE',ONLINE:'ONLINE',SEARCHING:'SEARCHING',HIT:'HIT',MISS:'MISS',RESIGN:'RESIGN',IFRAME_POLLING:'IFRAME_POLLING',RELAUNCH:'RELAUNCH',STATE_CHANGE:'STATE_CHANGE',WRONG_VERSION:'WRONG_VERSION',SERVICE_ERROR:'SERVICE_ERROR',INCORRECT_ONLINE_STATE:'INCORRECT_ONLINE_STATE',LOG_SEND_OP:'LOG_SEND_OP',REQUEUE_OP:'REQUEUE_OP'},ALLOWED_STATUS_PARAMS:{playing:'playing',track:'track',context:'context',client_version:'client_version',start_time:'start_time',expires_in:'expires_in',open_graph_state:'open_graph_state'},ALLOWED_EXTERNAL_CONTEXT_PARAMS:{uri:true,song:true,radio_station:true,album:true,playlist:true,musician:true,song_list:true,offset:true,title:true,request_id:true,listen_with_friends:true,needs_tos:true},LIVE_LISTEN_OP:{NOW_LEADING:'NOW_LEADING',NOW_LISTENING:'NOW_LISTENING',END_SESSION:'END_SESSION',SONG_PLAYING:'SONG_PLAYING',LISTENER_UPDATE:'LISTENER_UPDATE',QUEUE_SESSION:'QUEUE_SESSION',PLAY_ERROR:'PLAY_ERROR',SESSION_UPDATED:'SESSION_UPDATED',QUEUING_SESSION:'QUEUING_SESSION'},MUSIC_BUTTON:{ACTIVATE:'ACTIVATE'},ERROR:{1:'SERVICE_UNAVAILABLE_WITHOUT_PREMIUM',2:'SERVICE_UNAVAILABLE_WITHOUT_PREMIUM_OR_WAIT',3:'SERVICE_UNAVAILABLE_BILLING_ISSUE',4:'SERVICE_UNAVAILABLE_TECHNICAL_ISSUE',5:'AUDIO_AD_PLAYING',99:'SERVICE_TEMPORARILY_UNAVAILABLE',101:'SONG_UNAVAILABLE_WITHOUT_PURCHASE',102:'SONG_UNAVAILABLE_WITHOUT_PREMIUM',103:'SONG_UNAVAILABLE_INDEFINITELY'}};e.exports=a.MusicConstants||h;});
__d("MusicEvents",["Arbiter"],function(a,b,c,d,e,f){var g=b('Arbiter');e.exports=a.MusicEvents=new g();});
__d("MusicWaterfallLogger",["JSLogger"],function(a,b,c,d,e,f){var g=b('JSLogger'),h=g.create('music_waterfall'),i={click:function(l){j('click',l);},musicLoadedFromClick:function(l){j('music_loaded_from_click',l);},playPause:function(l){j('play_pause',l);}};function j(l,m){h.debug(l+'_debug',m);h.bump(l);h.bump(l+'_'+k(m));}function k(l){return l?l.replace(/\.|-/g,'_'):'';}e.exports=i;});
__d("MusicButton",["Bootloader","copyProperties","CSS","DOM","MusicButtonStore","MusicConstants","MusicEvents","MusicWaterfallLogger","Parent","Tooltip","cx"],function(a,b,c,d,e,f){var g=b('Bootloader'),h=b('copyProperties'),i=b('CSS'),j=b('DOM'),k=b('MusicButtonStore'),l=b('MusicConstants'),m=b('MusicEvents'),n=b('MusicWaterfallLogger'),o=b('Parent'),p=b('Tooltip'),q=b('cx'),r=function(s,t,u,v,w,x){this.provider=s;this.buttonElem=t;this.url=u;this.context=v||{};this.mediaType=w;this.setState(this.STATES.OFFLINE);this.tooltip=x||'';m.subscribe(l.MUSIC_BUTTON.ACTIVATE,this.processClick.bind(this));};h(r,{tracksetableTypes:[]});h(r.prototype,{SHOW_LOADING_TIMEOUT:500,HIDE_LOADING_TIMEOUT:4000,RECENTLY_ONLINE_TIMEOUT:6000,STATES:{PLAYING:'music_playing',PAUSED:'music_paused',LOADING:'music_loading',DISABLED:'music_disabled',OFFLINE:'music_offline'},setState:function(s){if(s!==this.STATES.LOADING){this.resetLoadingTimers();this.previousState=this.state||s;}if(s===this.STATES.PLAYING){p.set(this.buttonElem,this.tooltip);}else p.set(this.buttonElem,'');var t=this.buttonElem.parentNode;this.state&&i.removeClass(t,this.state);this.state=s;i.addClass(t,this.state);},isTracksetable:function(s){return r.tracksetableTypes.indexOf(this.mediaType)!==-1;},handleIncomingEvent:function(s,t){clearTimeout(this._showLoadingTimer);if(t&&t.provider&&t.provider!=this.provider)return;switch(s){case l.DIAGNOSTIC_EVENT.ONLINE:case l.STATUS_CHANGE_EVENT.track:case l.STATUS_CHANGE_EVENT.playing:var u=t&&t.track&&t.track.uri,v=t&&t.context&&t.context.uri;if(t&&t.playing&&(l.sameURLs(u,this.url)||l.sameURLs(v,this.url))){this.setState(this.STATES.PLAYING);}else if(this.state===this.STATES.LOADING&&(this.previousState===this.STATES.PAUSED||this.previousState===this.STATES.OFFLINE)){clearTimeout(this._attemptingPlayTimer);this._attemptingPlayTimer=this.setState.bind(this,this.STATES.PAUSED).defer(this.RECENTLY_ONLINE_TIMEOUT,false);}else if(!this._attemptingPlayTimer)this.setState(this.STATES.PAUSED);break;case l.DIAGNOSTIC_EVENT.OFFLINE:this.setState(this.STATES.OFFLINE);break;case l.DIAGNOSTIC_EVENT.ALL_OFFLINE:this.setState(this.STATES.OFFLINE);break;}},processClick:function(s,t){if(t!=this.buttonElem){if(this.state===this.STATES.LOADING)this.previousState&&this.setState(this.previousState);return;}if(this.state!=this.STATES.PLAYING){var u=o.byClass(this.buttonElem,"_4--s");if(u){i.addClass(u,"_4--t");i.removeClass.curry(u,"_4--t").defer(3000);}}n.click(this.provider);var v=this.isTracksetable()&&o.byClass(this.buttonElem,'music_trackset_container'),w=[];if(v){var x=v.getAttribute('data-trackset-title'),y=this.provider,z=j.scry(v,'.music_button');for(var aa=0;aa<z.length;aa++){var ba=k.getButton([z[aa].id]);if(ba&&ba.provider==y&&ba.isTracksetable())w.push(ba.url);}}if(!a.Music)this.showLoading(true);g.loadModules(['Music'],function(ca){n.musicLoadedFromClick(this.provider);var da=(v&&w.length>1)?ca.playPauseSongList(this.provider,this.url,w,x,this.context):ca.playPauseSong(this.provider,this.url,this.context);this.showLoading(!da);}.bind(this));},showLoading:function(s){this.resetLoadingTimers();this._hideLoadingTimer=this._timeout.bind(this,s).defer(this.HIDE_LOADING_TIMEOUT,false);this._showLoadingTimer=this.setState.bind(this,this.STATES.LOADING).defer(this.SHOW_LOADING_TIMEOUT,false);},resetLoadingTimers:function(){clearTimeout(this._hideLoadingTimer);clearTimeout(this._showLoadingTimer);clearTimeout(this._attemptingPlayTimer);this._attemptingPlayTimer=null;},destroy:function(){this.resetLoadingTimers();this.buttonElem=null;},_timeout:function(s){a.Music&&a.Music.reInform([this.provider]);if(!s&&this.state===this.STATES.LOADING)this.setState(this.STATES.PAUSED);}});e.exports=r;});
__d("MusicButtonManager",["Event","DOM","KeyedCallbackManager","Layer","MusicButton","MusicButtonStore","MusicConstants","MusicEvents","Parent","$","copyProperties","ge"],function(a,b,c,d,e,f){var g=b('Event'),h=b('DOM'),i=b('KeyedCallbackManager'),j=b('Layer'),k=b('MusicButton'),l=b('MusicButtonStore'),m=b('MusicConstants'),n=b('MusicEvents'),o=b('Parent'),p=b('$'),q=b('copyProperties'),r=b('ge'),s=new i(),t=null,u={},v=0;function w(da){var ea=da.getTarget(),fa=o.byClass(ea,'music_button');fa=fa||(!(da.getModifiers&&da.getModifiers().any)&&x(ea));if(!fa)return;return y(fa,da);}function x(da){var ea=o.byClass(da,'music_button_trigger')&&o.byClass(da,'music_button_trigger_group');if(ea){var fa=h.scry(ea,'.music_button');if(fa.length)return fa[0];}return null;}function y(da,event){event&&event.stop();n.inform(m.MUSIC_BUTTON.ACTIVATE,da);return false;}function z(da){a.Music&&a.Music.reInform(da);}function aa(da,ea){var fa=l.getButtons();for(var ga in fa)if(fa[ga].noGC||r(ga)){fa[ga].handleIncomingEvent(da,ea);}else l.removeButton(ga);}var ba={init:function(da){if(t)return;t=true;k.tracksetableTypes=da||[];g.listen(document.body,'click',w);n.subscribe([m.STATUS_CHANGE_EVENT.playing,m.STATUS_CHANGE_EVENT.track,m.DIAGNOSTIC_EVENT.OFFLINE,m.DIAGNOSTIC_EVENT.ALL_OFFLINE,m.DIAGNOSTIC_EVENT.ONLINE],aa);},add:function(da,ea,fa,ga,ha,ia){t||ba.init();var ja=ea.id,ka=l.getButton(ja);if(ka)return ka;ka=l.addButton(ja,new k(da,ea,fa,q({button_id:ja},ga),ha,ia));var la=o.byClass(ea,'uiOverlay');if(la){ka.noGC=true;var ma=j.subscribe('destroy',function(na,oa){if(h.contains(oa.getRoot(),ea)){l.removeButton(ja);j.unsubscribe(ma);}});}if(da&&!u[da])u[da]=function(){var na=Object.keys(u);na.length&&z(na);u={};}.defer();return ka;},addButton:function(da,ea,fa,ga,ha,ia){if(!r(ea))return;var ja=p(ea);return ba.add(da,ja,fa,ga,ha,ia);},asyncAddMusicButton:function(da,ea){da.setAttribute('id','music_button_'+v++);ca(da,ea);},tryAddButtonInDOM:function(da,ea){var fa=r(da);fa&&ca(fa,ea);},addMusicData:function(da,ea,fa,ga,ha,ia){s.setResource(da,{provider:ea,uri:fa,context:ga,media_type:ha,tooltip:ia});}};function ca(da,ea){var fa=h.find(da,'a.button_anchor').getAttribute('href');s.executeOrEnqueue(fa,function(ga){return ba.add(ga.provider,da,ga.uri,ga.context,ga.media_type,ea?ga.tooltip:'');});}e.exports=a.MusicButtonManager||ba;});
__d("BulkTagLoader",["AsyncRequest","copyProperties","emptyFunction"],function(a,b,c,d,e,f){var g=b('AsyncRequest'),h=b('copyProperties'),i=b('emptyFunction'),j=false;function k(){}h(k,{loadForSet:function(l){if(!j){j=true;new g('/ajax/photos/sets/tags_fetch.php').setHandler(i).setData({set:l}).send();}},loadForAlbum:function(l){if(!j){j=true;new g('/ajax/photos/album/tags_fetch.php').setHandler(i).setData({fbid:l}).send();}},reset:function(){j=false;}});e.exports=k;});
__d("PresenceCookieManager",["Cookie","Dcode","ErrorUtils","Env","JSLogger","PresenceUtil","URI","PresenceInitialData"],function(a,b,c,d,e,f){var g=b('Cookie'),h=b('Dcode'),i=b('ErrorUtils'),j=b('Env'),k=b('JSLogger'),l=b('PresenceUtil'),m=b('URI'),n=b('PresenceInitialData'),o=n.cookieVersion,p=n.dictEncode,q='presence',r={},s=null,t=null,u=k.create('presence_cookie');function v(){try{var z=g.get(q);if(s!==z){s=z;t=null;if(z&&z.charAt(0)=='E')z=h.decode(z.substring(1));if(z)t=JSON.parse(z);}if(t&&(!t.user||t.user===j.user))return t;}catch(y){u.warn('getcookie_error');}return null;}function w(){return parseInt(Date.now()/1000,10);}var x={register:function(y,z){r[y]=z;},store:function(){var y=v();if(y&&y.v&&o<y.v)return;var z={v:o,time:w(),user:j.user};for(var aa in r)z[aa]=i.applyWithGuard(r[aa],r,[y&&y[aa]],function(ea){ea.presence_subcookie=aa;});var ba=JSON.stringify(z);if(p)ba='E'+h.encode(ba);if(l.hasUserCookie()){var ca=ba.length;if(ca>1024)u.warn('big_cookie',ca);var da=m.getRequestURI(false).isSecure()&&!!g.get('csm');g.set(q,ba,null,null,da);}},clear:function(){g.clear(q);},getSubCookie:function(y){var z=v();if(!z)return null;return z[y];}};e.exports=x;});
__d("PresenceState",["Arbiter","ErrorUtils","JSLogger","PresenceCookieManager","copyProperties","debounceAcrossTransitions","setIntervalAcrossTransitions","PresenceInitialData"],function(a,b,c,d,e,f){var g=b('Arbiter'),h=b('ErrorUtils'),i=b('JSLogger'),j=b('PresenceCookieManager'),k=b('copyProperties'),l=b('debounceAcrossTransitions'),m=b('setIntervalAcrossTransitions'),n=b('PresenceInitialData'),o=n.cookiePollInterval||2000,p=[],q=[],r=null,s=null,t=0,u=null,v=0,w=['sb2','t2','lm2','uct2','tr','tw','at','wml'],x=i.create('presence_state');function y(){return j.getSubCookie('state');}function z(){t=Date.now();j.store();da(s);}var aa=l(z,0);function ba(ia){if(typeof ia=='undefined'||isNaN(ia)||ia==Number.POSITIVE_INFINITY||ia==Number.NEGATIVE_INFINITY)ia=0;return ia;}function ca(ia){var ja={};if(ia){w.forEach(function(ma){ja[ma]=ia[ma];});if(t<ia.ut)x.error('new_cookie',{cookie_time:ia.ut,local_time:t});}ja.ut=t;for(var ka=0,la=p.length;ka<la;ka++)h.applyWithGuard(p[ka],null,[ja]);s=ja;return s;}function da(ia){v++;t=ba(ia.ut);if(!r)r=m(ga,o);s=ia;if(u===null)u=ia;for(var ja=0,ka=q.length;ja<ka;ja++)h.applyWithGuard(q[ja],null,[ia]);v--;}function ea(ia){if(ia&&ia.ut)if(t<ia.ut){return true;}else if(ia.ut<t)x.error('old_cookie',{cookie_time:ia.ut,local_time:t});return false;}function fa(){var ia=y();if(ea(ia))s=ia;return s;}function ga(){var ia=y();if(ea(ia))da(ia);}j.register('state',ca);g.subscribe(i.DUMP_EVENT,function(ia,ja){ja.presence_state={initial:k({},u),state:k({},s),update_time:t,sync_paused:v,poll_time:o};});(function(){var ia=fa();if(ia){da(ia);}else{x.debug('no_cookie_initial');da(ca());return;}})();var ha={doSync:function(ia){if(v)return;if(ia){z();}else aa();},registerStateStorer:function(ia){p.push(ia);},registerStateLoader:function(ia){q.push(ia);},get:function(){return fa();},getInitial:function(){return u;},verifyNumber:ba};e.exports=ha;});
__d("ReminderStory",["Event","DOMQuery"],function(a,b,c,d,e,f){var g=b('Event'),h=b('DOMQuery');function i(j,k){g.listen(j,'click',function(l){k.show();});k.subscribe('aftershow',function(){var l=k.getRoot(),m=h.scry(l,'.inlineReplyTextArea');if(m.length>0)m[0].focus();});}e.exports=i;});
__d("ClearableTypeahead",["Event"],function(a,b,c,d,e,f){var g=b('Event'),h={resetOnCloseButtonClick:function(i,j){g.listen(j,'click',function(){var k=i.getCore();k.getElement().focus();k.reset();});}};e.exports=h;});
__d("TypeaheadShowLoadingIndicator",["CSS","copyProperties"],function(a,b,c,d,e,f){var g=b('CSS'),h=b('copyProperties');function i(j){this._typeahead=j;}h(i.prototype,{_subscription:null,enable:function(){this._subscription=this._typeahead.subscribe('loading',function(j,k){g.conditionClass(this._typeahead.getElement(),'typeaheadLoading',k.loading);g.conditionClass(this._typeahead.getView().getElement(),'typeaheadViewLoading',k.loading);}.bind(this));},disable:function(){this._typeahead.unsubscribe(this._subscription);this._subscription=null;}});e.exports=i;});
__d("legacy:ShowLoadingIndicatorTypeaheadBehavior",["TypeaheadShowLoadingIndicator"],function(a,b,c,d){var e=b('TypeaheadShowLoadingIndicator');if(!a.TypeaheadBehaviors)a.TypeaheadBehaviors={};a.TypeaheadBehaviors.showLoadingIndicator=function(f){f.enableBehavior(e);};},3);
__d("legacy:CompactTypeaheadRenderer",["CompactTypeaheadRenderer"],function(a,b,c,d){if(!a.TypeaheadRenderers)a.TypeaheadRenderers={};a.TypeaheadRenderers.compact=b('CompactTypeaheadRenderer');},3);